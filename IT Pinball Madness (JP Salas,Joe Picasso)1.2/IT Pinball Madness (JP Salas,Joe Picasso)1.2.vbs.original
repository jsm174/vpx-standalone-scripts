'                                                                                ,                                                                ,                   
'               %                                                                %                   
'              */                                                                %                   
'              %                                                                 %,                  
'              %                                                                 %/                  
'              %                                                                 %#                  
'             ,%                                                                 #%                  
'             (#                                                                 (%                  
'             ##                                                                  %*                 
'             %#                                                                  %%                 
'            %#                                                                  %&                 
'             %#                                                                  #&,                
'             %#                                                                   &%                
'            ,%(                                                                   &%                
'            /%/                                                                  .&&                
'            *%#                                                                  *&&                
'           ,%%                                                                  %&%                
'             &&                                                                  &&&                
'             %&                                                                 .&&&                
'             %&,                                                                /&&&                
'             %&%                                                                ,&&&                
'             %&&                                                                 &&&                
'             .&&%                                                               ,&&&                
'              @&@                                                               (&&&                
'              @&&&                                                              %&@%.               
'          .  &@@@@/                                                            ,@&@%. .             
'     .......(@&@@@@.,                                                       ..,%@@@@*.....          
'   ........,%@@@@@&....(                                                .....*/&@&&@&*........ ..   
'  ..........%&&@&@#.......*                                           .....,,,,&@@&&&&%............ 
'  ...(&@@@@@@@@@@@/,....... .                                        ..........(&&@&&@&%,*,#....... 
'  ,&@@@@@@@@@@@@@@@@&&%,....                                        ............&@@@@@@@@@@@@&,/..  
'  *&@@@@@@#*/,#(#/@@@@@@&&/...                                     .........#&@@@/@@@@ ((*/@@@@@&   
'   %&@@@@@@(* %(**@@@ *#%@@&&*..                                  ......,(@@@/@#/(@@@@,/(*%@@@@@&(  
'  .*&@@@@@@@(.*@/,,,,,,#@* *@@&&...                             .....,(@@@#// %***  ,,,,@@@@(@@&&.  
'   ./&@@@@@@@@#%@,,, .*&#  ***@@@&...                          ...,(&@@@#/****,@/ *.,*,@@@@@@@@%,.. 
'   ..(&@@@@@@&&(@@@%,( #.  /((@&@@@&*.                        ..,&@@@@#@@@@**/ , *&%&@%%%&@@@%#,,.  
'   ..,/&&@@@@@@%&%%.@@@@@@@@&%@&@(@@@&...                    ./&@@@@@@,%&&@*@@@@@@@(%&&&@&@&&%/*,.  
'    ..,/#&@@@@@@#*@&&%%%%%&&&@@&@@@&@@&..                   .#&&@@@@@@@@@@@@&&%%%%%&&@@@@@&&#**,... 
'    ..,,*(#%%&@@@@@@@@@@@@@@@@@@@@@&&&&/.. .               .,%#%&&&&@@@@@@@@@@@@@@@@@@@@&&#/**,...  
'    ....,**/##&@@@&&@@@@@@@@@@@@@&&%%%&#,. .              ..*#((#(#%%&&&@@&@@@@@@&&&@@@&%/**,,...   
'     ...,****(@&@@@%#(#%&&&&&&&%###%#((%,...             ...*(///((/((((##%&&&&&@&&&&&&%#/*,,..     
'      ...,/***%&@&@#(///////((((#(((///(*..              ...**,,**//(///////////%&&&&&&#*,,,..      
'       ...,****%&@&&(*/////////(((//*****...              ..*,...,,,****/***,,,,*#&&&&(*,,,..       
'        ....,/**&&&@&&**/////////*****,,,..               ...,......,,***/(******%&&&%*,,,.,        
'         ....,,,@@@@@@@%/****,,,,,,,,,,,..                 ..............,,,,(#&&@@@@&*,..          
'           .,,**#&&@@@%.,,,,,,,.,...,,,...                  ....  ...........  %&&&@@@&..           
'             ,.&&@@&&@  .................                           ........  .&&&&&&@@.            
'             .&&&&@@@,  ..............                                         &&&@&@%@&            
'             #&@@&&@&   ...........                                             &&&@@&@@%           
'            &%@@@@@&,                                                            &@&@&@@@(          
'           @&&&@@@&/                                                              %&&&&&@&          
'          #@@&&@@@%                                                               ,&@@&&@@/         
'          &@@&&@@&                                                                 &@@@@&&%         
'         &&@@@@&&*                                                                 &&@@@&@&         
'        .&&&@@@&%                &                                                 *&&@&&&&,        
'        %&&@@@@&                &@&                             &@@                 %&&&@&&%        
'       #&@%@@@&,               &@@@&                            @@@(                 &&@&&@&%       
'       %&@&&@@#                &&@@@@&.   *@&&&(.              @@@@&                  %&@@@&&*      
'       &&@@&&&                (&&@@@@@&@@@@@@@@@@@@@&/      .&@@@@@@                   &&@&&&&      
'       &&&&@&%                &&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@%                   &&@@@&      
'       &&&@&&                 &&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@&                   %&@&@&%     
'       &@&@@%                 #&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@&                    &@&&&%     
'       &@@&@&                  &&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@@%                    &&&&&%     
'       *@&&&&*                 %&&&&@@@@@@@&@@@@&@@@@@,@@@@@@@@@&&&&#                    &&&&&%     
'        &@&@&&                  &&&&&@@&&&&&&& @&@@&@@#@@@@@@@&&&&&&                     &&&@&,     
'         @@&@@&                  %&&&&&&&&&&&&@&&&&&& &&@&@@@&&&&&%,                    %&&&&&      
'         .@@&@/&%                  %&&&&&&&%&(&&&&&&&&&&&@@@&&&&&%                    &&&&%&&%      
'           &@@@@&&#                  .&@&&&&&&&&&&&&&&%&@&@@&&&/                /&&&&&@@@&@&&       
'             .&@&@&%%                   &&&&&&&%%%&&&&&&&@@%(                 &@&%%&&@@&#&&&        
'                &@@&&%#                  %&&&&&&%%%%&%&&&&                #%&&@%&&(%%%%%&&%         
'                  &&%&%%                   /&&&&&&&%&&&&,               %&&&&(&%**                  
'                    &%%&&&&%*                 #%%%&&&%                &&&&&@&@%&                    
'                     ##&&&&%&&%                                    *%&&&&%&%&&%                     
'                      /%&&@&@&&&&&%,                            .&&&&@@&&%%&&.                      
'                       %%&&&@@@@&&&&&&&&&                   &&&&&&%@@@&&%&&/                        
'                       .#&%&&&&@@@%/ *%& &%&            (&&&&&#%(/&@@&&&%%.                         
'                        %%&&&%&@@@@@#(/,*/%%%&      ,&.&&%#*,,,#&@@@&&&%&.                          
'                        ,%&&&&&@@@@@@@(, #**//**%%%&&#/,./%, ./%@@@@&&&%*                           
'                         %&&%&&&@@@@@@%(/&/***..*/,*** .,(@//%%@@@@&&&%%                            
'                          %&&&&&@@@@@@@@@@/ . ..// /..../#@@@@@@@@&&&%%                             
'                          #&&&&@@@@@@@@@@@#**  ./#** ..,/%@@@@@@@&&&&%                              
'                           %&&&&(&@@@@@@@@&(/ ,**&(*,,/(%&@@@@@@@&&&%#                              
'                           *%&&&@ @@@@@@@@@&(//#&@@&(&@@@@@@@@@@&&&%%                               
'                            %&&&&@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&%%                                
'                             %&&&&@@@@@&&&@@@@@@@@@@@@@@@@@@@@&&&%%                                 
'                             ,%&&&&@@@&@&&&&@@@@@@@@@@@@@@@@@@@&&%/                                 
'                              #%&&&&@@@@@&&&&&&&&@@@@@@@@/@@@@&&%%                                  
'                               #%&&&&&@@(@@@&&&&&&@@@@@@@@@@@&%%%                                   
'                                %%&&%&&@&@&&@@@@@@@@@@%&&@&&&%%%                                    
'                                 %#&&&&&&@@@@(@@@@@@&&&@&&&%%%%                                     
'                                  #%%&&*&&&@@@@@@@@@@@&&&&&%%%                                      
'                                    %%&&& &&&&&&&&&&&&&&&%%%%                                       
'                                     %%%&&&(&&&&&&&&&&&%%%%(                                        
'                                       %%%&&&(&&%%&&&%%%%#                                          
'                                         #,&&%%%%%%%%%%*                                            
'                                           ,%%%%%%%%.                                               
'                                                                                                    
                                                                                                    
                                                                                                    
                  
' ****************************************************************
'             IT for VISUAL PINBALL X 10.7
'    Table built by jpsalas with graphics by Joe Picasso
'         Uses FlexDMD for cabinet / FS mode
' ****************************************************************

' Roach Effect Credits: Dark / Randr / Toxie / Fuzzel / HauntFreaks / BorgDog

Option Explicit
Randomize

'VR Dims...
Dim Stuff
Dim Glass
Dim Scratches
Dim VRroom
Dim RightMagnaEnabled: RightMagnaEnabled = false
Dim LeftMagnaEnabled: LeftMagnaEnabled = false
Dim VRInstructionsEnabled: VRInstructionsEnabled = false


'==================== Player Options ==================================
Const CabinetMode = True	' Hides the side rails (or would, if .visible worked for ramps like the CommandRef says it's supposed to)

' Sound and music volumes
Const SongVolume = 0.1		' 1 is full volume, but I set it quite low to listen better the other sounds since I use headphones, adjust to your setup :)
'Const VoiceVolume = 0		' Volume of the voices
Const VolumeDial = 0.8		' Overall Mechanical sound effect volume. Recommended values should be no greater than 1.
Const BallRollVolume = 0.5	' Level of ball rolling volume. Value between 0 and 1
Const RampRollVolume = 0.6	' Level of ramp rolling volume. Value between 0 and 1

'FlexDMD in high or normal quality
'change it to True if you have an LCD screen, 256x64
'or keep it False if you have a real DMD at 128x32 in size
Const FlexDMDHighQuality = True

'********** VR OPTIONS *****************

VRRoom = 0       ' 0= Desktop/FS   1= Sewer Room  2= Minimal Room  3= Ultra Minimal Room
Glass = 1		 ' 0= Glass Reflection OFF   1= Glass Reflection ON  (This will not run if VRRoom = 0 or 3)
Scratches = 1	 ' 0= Glass Scratches OFF    1= Glass Scratches ON    (This will not run if VRRoom = 0 or 3)

'********** END VR OPTIONS *************


'==================== End of Player Options ===========================

Const BallSize = 50 ' 50 is the normal size used in the core.vbs, VP kicker routines uses this value divided by 2
Const BallMass = 1  ' standard ball mass

' Load the core.vbs for supporting Subs and functions
LoadCoreFiles

Sub LoadCoreFiles
    On Error Resume Next
    ExecuteGlobal GetTextFile("core.vbs")
    If Err Then MsgBox "Can't open core.vbs"
    ExecuteGlobal GetTextFile("controller.vbs")
    If Err Then MsgBox "Can't open controller.vbs"
    On Error Goto 0
End Sub

' Define any Constants
Const cGameName = "it_pinball_madness" 'Temporary change to match incognito table name in dof config too- will be changed back to IT before release
Const myVersion = "0.58"
Const MaxPlayers = 4         ' from 1 to 4
Const MaxMultiplier = 6      ' limit playfield multiplier
Const MaxBonusMultiplier = 6 'limit Bonus multiplier
Const BallsPerGame = 3       ' usually 3 or 5
Const MaxMultiballs = 7      ' max number of balls during multiballs


' Use FlexDMD if in FS mode   ' NOTE:  This may cause issues with VR users set to FS mode (They shouldn't be, but some use their cabinets - Rawd)
Dim UseFlexDMD
If Table1.ShowDT = True then  
    UseFlexDMD = False
Else
    UseFlexDMD = True
End If

'Turn off Flex for VR Users
If VRRoom <> 0 then UseFlexDMD=False

dim bThunderLighting:	bThunderLighting = True
FlasherThunderOverlay.opacity = 200					'Thunder lighting intensity. default 200-300

' Define Global Variables
Dim PlayersPlayingGame
Dim CurrentPlayer
Dim Credits
Dim BonusPoints(4)
Dim BonusHeldPoints(4)
Dim BonusMultiplier(4)
Dim PlayfieldMultiplier(4)
Dim PFxSeconds
Dim BallSaverTime ' in seconds of the first ball
Dim bBonusHeld
Dim BallsRemaining(4)
Dim ExtraBallsAwards(4)
Dim Score(4)
Dim HighScore(4)
Dim HighScoreName(4)
Dim Jackpot(4)
Dim SuperJackpot(4)
Dim Tilt
Dim TiltSensitivity
Dim Tilted
Dim TotalGamesPlayed
Dim mBalls2Eject
Dim bAutoPlunger
Dim bInstantInfo
Dim bAttractMode
Dim ComboCount
Dim ComboHits(4)
Dim ComboValue(4)
Dim x

' Define Game Control Variables
Dim LastSwitchHit
Dim BallsOnPlayfield
Dim BallsInLock(4)
Dim BallsInHole

' Define Game Flags
Dim bFreePlay
Dim bGameInPlay
Dim bOnTheFirstBall
Dim bBallInPlungerLane
Dim bBallSaverActive
Dim bBallSaverReady
Dim bMultiBallMode
Dim bMultiBallStarted
Dim bMusicOn
Dim bSkillshotReady
Dim bExtraBallWonThisBall
Dim bJackpot

' core.vbs variables
Dim plungerIM   'used mostly as an autofire plunger during multiballs
Dim TopMagnet   'at the spinner
Dim LeftMagnet  'Georgie targets
Dim RightMagnet 'Fear targets


' *** VR Initialize... ******************************************************************

If CabinetMode Then
	rrail.visible = False
	lrail.visible = false
End If

If VRRoom = 0 Then 
	VRMessage.visible = true  ' display message telling users to pick a VR option. (this is for if VR users load VRroom = 0 by accident on first Load)
end If

If VRRoom > 0 Then 

	For Each Stuff in VRCab : Stuff.visible = true: Next
	For Each Stuff in VRDMD : Stuff.x = Stuff.x +1093 : Next 
	For Each Stuff in VRDMD : Stuff.y = Stuff.y -446 : Next 
	For Each Stuff in VRDMD : Stuff.height = Stuff.height +330 : Next 
	For Each Stuff in VRDMD : Stuff.rotx = 273 : Next 
	For Each Stuff in VRDMDTOP : Stuff.y = Stuff.y +22 : Next 
	For Each Stuff in VRDMDTOP : Stuff.height = Stuff.height +6 : Next 
	For Each Stuff in VRDMDBOTTOM : Stuff.y = Stuff.y -22 : Next 
	For Each Stuff in VRDMDBOTTOM : Stuff.height = Stuff.height -6 : Next
	setbackglass
	rrail.visible = false
	lrail.visible = false
	RightBlade.Height = 180
	LeftBlade.Height = 180
	Flasher6.visible = false
	Flasher7.visible = false
	Ramp1.visible = false
	Ramp2.visible = false
	Balloon002.visible = false
	LutBox.x = 30000
	LutBox.y = 30000
	VRApronInstructions.visible = true
	hand.z = 140
end If

If VRRoom = 1 Then ' Sewer
	For Each Stuff in VRSewer : Stuff.visible = true: Next
	VRMainTimer.enabled = true
	RatTimer.enabled = true
	TimerVRPlunger2.enabled = true
	'PennywiseTimer1.enabled = true
	SewerPennyTimer.enabled = true
	VRSpeakerTimer.enabled = true
	VRLightTimerStart.enabled = true
	VRRoachRunTimer.enabled = true
	VRPennyWise.visible = false ' setup for timer
	RatAnim1.blenddisablelighting = 3
	RatAnim1.PlayAnimEndless(0.06)
	VRWater.Opacity = 60 ' will resetting this here fix my water animation issues??
	VRWater2.Opacity = 150 ' will resetting this here fix my water animation issues??
	if Scratches = 1 then 
	GlassImpurities.visible = true
	end if
	if Glass = 1 then 
	WIndowGlass.visible = true
	end if
end If

If VRRoom = 2 Then ' Minimal
	For Each Stuff in VRMinimal : Stuff.visible = true: Next
	TimerVRPlunger2.enabled = true
	VRSpeakerTimer.enabled = true  ' we will run this.. its minimal CPU and adds a lot to the backbox.
	if Scratches = 1 then 
	GlassImpurities.visible = true
	end if
	if Glass = 1 then 
	WIndowGlass.visible = true
	end if
End If

If VRRoom = 3 Then ' Ultra Minimal - This displays the backglass only - We don't run flipper or plunger animations in code here either
	PinCab_Coindoor.visible = False
	PinCab_Cabinet.visible = False
	Pincab_Metals.visible = False
	VRKnifeHandle.visible = False
	VRKnifeBlade.visible = False
	VRKnifeSlot001.visible = False
	VRKnifeSlot.visible = False
	Primary_flipperbuttonrings.visible = False
	VRFlipperRight.visible = False
	VRFlipperLeft.visible = False
	VR_LegsFront.visible = False
	VR_LegsBack.visible = False
	VR_LegBoltsBack.visible = False
	VR_LegBoltsFront.visible = False
	StartButtonRing.visible = False
	StartButtonRingOuter.visible = False
	StartButton.visible = False
	VR_Key.visible = False
	VR_KeyShake.visible = False
	StartButtonInner.visible = False
	VRSpeakerTimer.enabled = true  ' we will run this.. its minimal CPU and adds a lot to the backbox.
End If

' *** End VR Initialize... **************************************************************



dim Roachloc, RoachBall
Dim Magnet0, Magnet1, magnet2, Magnet3, Magnet4
' *********************************************************************
'                Visual Pinball Defined Script Events
' *********************************************************************

Sub Table1_Init()
    LoadEM
    Dim i
    Randomize

    'Impulse Plunger as autoplunger
    Const IMPowerSetting = 65 ' Plunger Power
    Const IMTime = 0.5        ' Time in seconds for Full Plunge
    Set plungerIM = New cvpmImpulseP
    With plungerIM
        .InitImpulseP swplunger, IMPowerSetting, IMTime
        .Random 1.5
        .InitExitSnd SoundFXDOF("fx_kicker", 141, DOFPulse, DOFContactors), SoundFXDOF("fx_solenoid", 141, DOFPulse, DOFContactors)
        .CreateEvents "plungerIM"
    End With

    ' TopMagnet
    Set TopMagnet = New cvpmMagnet
    With TopMagnet
        .InitMagnet Magnet1o, 35
        .GrabCenter = True
        .CreateEvents "TopMagnet"
    End With

    ' Left Magnet
    Set LeftMagnet = New cvpmMagnet
    With LeftMagnet
        .InitMagnet Magnet3o, 20
        .GrabCenter = False
        .CreateEvents "LeftMagnet"
    End With

    ' Right Magnet
    Set RightMagnet = New cvpmMagnet
    With RightMagnet
        .InitMagnet Magnet2o, 15
        .GrabCenter = False
        .CreateEvents "RightMagnet"
    End With

	set RoachBall = EVAL("RoachHole"&RoachLoc).CreateSizedBall(15)
	RoachBall.visible=0
'	roachball.mass = 5

	Set Magnet0=New cvpmMagnet
	with Magnet0
		.InitMagnet RoachTrigger0,4
		.CreateEvents "Magnet0"
		.AttractBall RoachBall
		.Grabcenter = 1
		.magneton = 0
	end With
	Set Magnet1=New cvpmMagnet
	with Magnet1
		.InitMagnet RoachTrigger1,3
		.CreateEvents "Magnet1"
		.AttractBall RoachBall
		.Grabcenter = 1
		.magneton = 0
	end With
	Set magnet2=New cvpmMagnet
	with magnet2
		.InitMagnet RoachTrigger2,2
		.CreateEvents "magnet2"
		.AttractBall RoachBall
		.Grabcenter = 1
		.magneton = 0
	end With
	Set Magnet3=New cvpmMagnet
	with Magnet3
		.InitMagnet RoachTrigger3,2
		.CreateEvents "Magnet3"
		.AttractBall RoachBall
		.Grabcenter = 1
		.magneton = 0
	end With
	Set Magnet4=New cvpmMagnet
	with Magnet4
		.InitMagnet RoachTrigger4,4
		.CreateEvents "Magnet4"
		.AttractBall RoachBall
		.Grabcenter = 1
		.magneton = 0
	end With

    ' Misc. VP table objects Initialisation, droptargets, animations...
    VPObjects_Init

    ' load saved values, highscore, names, jackpot
    Credits = 0
    Loadhs

    ' Initalise the DMD display
    DMD_Init

    ' freeplay or coins
    bFreePlay = False 'we want coins

    'if bFreePlay Then DOF 125, DOFOn


    ' Init main variables and any other flags
    bAttractMode = False
    bOnTheFirstBall = False
    bBallInPlungerLane = False
    bBallSaverActive = False
    bBallSaverReady = False
    bMultiBallMode = False
    bMultiBallStarted = False
    PFxSeconds = 0
    bGameInPlay = False
    bAutoPlunger = False
    bMusicOn = True
    BallsOnPlayfield = 0
    BallsInHole = 0
    LastSwitchHit = ""
    Tilt = 0
    TiltSensitivity = 6
    Tilted = False
    bBonusHeld = False
    bJackpot = False
    bInstantInfo = False
    ' set any lights for the attract mode
    vpmtimer.addtimer 2000, "GiOn '"
    StartAttractMode

    ' Start the RealTime timer
    RealTime.Enabled = 1

    ' Load table color
    LoadLut


End Sub

'******
' Keys
'******

Sub Table1_KeyDown(ByVal Keycode)

    If hsbModeActive Then
        EnterHighScoreKey(keycode)
        Exit Sub
    End If

    If keycode = LeftTiltKey Then Nudge 90, 6 : SoundNudgeLeft
    If keycode = RightTiltKey Then Nudge 270, 6 : SoundNudgeRight
    If keycode = CenterTiltKey Then Nudge 0, 7:SoundNudgeCenter

    If keycode = LeftMagnaSave And Vrroom=0 Then bLutActive = True: Lutbox.text = "level of darkness " & LUTImage + 1

	If keycode = LeftMagnaSave And Vrroom>0 Then
	if VRLeftMagnaTimer.enabled = false then VRLeftMagnaTimer.enabled = true	
	end If

	If keycode = LeftMagnaSave And VRInstructionsEnabled = true then
	VRInstructions = VRInstructions - 1
		if VRInstructions = 20 then VRInstructions = 1
		if VRInstructions = 0 then VRInstructions = 19
	VRInstructionsLogic
	end If

    If keycode = RightMagnaSave Then
        If bLutActive Then
            NextLUT
        End If
    End If

	If keycode = RightMagnaSave And Vrroom>0 Then
	if VRRightMagnaTimer.enabled = false then VRRightMagnaTimer.enabled = true
	End If

	If keycode = RightMagnaSave and VRInstructionsEnabled = true then
	VRInstructions = VRInstructions + 1
		if VRInstructions = 20 then VRInstructions = 1
		if VRInstructions = 0 then VRInstructions = 19
	VRInstructionsLogic
	end If

    If Keycode = AddCreditKey Then
		Select Case Int(rnd*3)
			Case 0: PlaySound ("Coin_In_1"), 0, CoinSoundLevel, 0, 0.25
			Case 1: PlaySound ("Coin_In_2"), 0, CoinSoundLevel, 0, 0.25
			Case 2: PlaySound ("Coin_In_3"), 0, CoinSoundLevel, 0, 0.25
		End Select
        Credits = Credits + 1
		DOF 140, Dofpulse 'Strobes

		If NOT bGameInPlay Then  ' we only want the start button to start flashing if the game is NOT already in play.
			if VRRoom = 1 and Credits > 0 then VRStartButtonTimer.enabled = true
			if VRRoom = 2 and Credits > 0 then VRStartButtonTimer.enabled = true
		end If

        'if bFreePlay = False Then DOF 125, DOFOn 'Attract Mode Ballons
        If(Tilted = False)Then
            DMDFlush
            DMD "", CL("CREDITS " & Credits), "", eNone, eNone, eNone, 500, True, ""

            If NOT bGameInPlay Then ShowTableInfo
        End If
    End If

	If keycode = PlungerKey Then
'		roachmove
        Plunger.Pullback
        SoundPlungerPull

		If VRRoom > 0 and VRRoom < 3 then 
		TimerVRPlunger.Enabled = True   'VR Plunger
		TimerVRPlunger2.Enabled = False   'VR Plunger
		End If
	end If
	If keycode = StartGameKey Then SoundStartButton
	If keycode = StartGameKey and VRRoom > 0 and VRRoom < 3 then
		StartButtonInner.y = StartButtonInner.y - 4
		StartButton.y = StartButton.y - 4
		SoundStartButton
		if credits > 0 then VRStartButtonTimer.enabled = false : StartButtonInner.DisableLighting = 1 ' leave it lit solid during gameplay.

	end If
	
	If keycode = RightFlipperKey and VRRoom > 0 and VRRoom < 3 then VRFlipperRight.x = VRFlipperRight.x -5
	If keycode = LeftFlipperKey and VRRoom > 0 and VRRoom < 3 then VRFlipperLeft.x = VRFlipperLeft.x +5


	

    ' Normal flipper action

    If bGameInPlay AND NOT Tilted Then
	    If keycode = LeftTiltKey Then CheckTilt 'only check the tilt during game
        If keycode = RightTiltKey Then CheckTilt
        If keycode = CenterTiltKey Then CheckTilt

        If keycode = LeftFlipperKey Then FlipperActivate LeftFlipper, LFPress :SolLFlipper 1:InstantInfoTimer.Enabled = True:RotateLaneLights 1: DOF 101, DOFon
        If keycode = RightFlipperKey Then FlipperActivate RightFlipper, RFPress :SolRFlipper 1:InstantInfoTimer.Enabled = True:RotateLaneLights 0: DOF 102, DOFon

        If keycode = StartGameKey Then
            If((PlayersPlayingGame < MaxPlayers)AND(bOnTheFirstBall = True))Then

                If(bFreePlay = True)Then
                    PlayersPlayingGame = PlayersPlayingGame + 1
                    TotalGamesPlayed = TotalGamesPlayed + 1
                    DMD "_", CL(PlayersPlayingGame & " PLAYERS"), "", eNone, eBlink, eNone, 1000, True, ""
                Else
                    If(Credits > 0)then
                        PlayersPlayingGame = PlayersPlayingGame + 1
                        TotalGamesPlayed = TotalGamesPlayed + 1
                        Credits = Credits - 1
                        DMD "_", CL(PlayersPlayingGame & " PLAYERS"), "", eNone, eBlink, eNone, 1000, True, ""
                        If Credits < 1 And bFreePlay = False Then DOF 125, DOFOff 'Attract Mode Ballons
                        Else
                            ' Not Enough Credits to start a game.
                            DMD CL("CREDITS " & Credits), CL("INSERT COIN"), "", eNone, eBlink, eNone, 1000, True, ""
                    End If
                End If
            End If
        End If
        Else ' If (GameInPlay)

            If keycode = StartGameKey Then
                If(bFreePlay = True)Then
                    If(BallsOnPlayfield = 0)Then
                        ResetForNewGame()
                    End If
                Else
                    If(Credits > 0)Then
                        If(BallsOnPlayfield = 0)Then
                            Credits = Credits - 1
                            If Credits < 1 And bFreePlay = False Then DOF 125, DOFOff
                            ResetForNewGame()
                        End If
                    Else
                        ' Not Enough Credits to start a game.
                        DMDFlush
                        DMD CL("CREDITS " & Credits), CL("INSERT COIN"), "", eNone, eBlink, eNone, 1000, True, ""
                        ShowTableInfo
                    End If
                End If
            End If
    End If ' If (GameInPlay)
End Sub

Sub Table1_KeyUp(ByVal keycode)

    If hsbModeActive Then
        Exit Sub
    End If

    If keycode = LeftMagnaSave Then bLutActive = False:LutBox.text = ""

If keycode = LeftMagnaSave and VRroom > 0 then 
VRLeftMagnaTimer.enabled = false
VRLeftMagnaTimer.interval = 2000
LeftMagnaEnabled = false
End if
If keycode = RightMagnaSave and VRroom > 0 then 
VRRightMagnaTimer.enabled = false
VRRightMagnaTimer.interval = 2000
RightMagnaEnabled = false
End if

    If keycode = PlungerKey Then
        Plunger.Fire
		If bBallInPlungerLane = 1 Then
			SoundPlungerReleaseBall()			'Plunger release sound when there is a ball in shooter lane
		Else
			SoundPlungerReleaseNoBall()			'Plunger release sound when there is no ball in shooter lane
		End If

		If VRRoom > 0 and VRRoom < 3 then
		TimerVRPlunger.Enabled = False  'VR Plunger
		TimerVRPlunger2.Enabled = True   ' VR Plunger
		VRKnifeHandle.Y = 2265   ' VR Plunger
		VRKnifeBlade.Y = 2270  ' VR Plunger
		End if
	End If


	If keycode = RightFlipperKey and VRRoom > 0 and VRRoom < 3 then VRFlipperRight.x = VRFlipperRight.x +5
	If keycode = LeftFlipperKey and VRRoom > 0 and VRRoom < 3 then VRFlipperLeft.x = VRFlipperLeft.x -5


	If keycode = StartGameKey and VRRoom > 0 and VRRoom < 3 then
		StartButtonInner.y = StartButtonInner.y + 4
		StartButton.y = StartButton.y + 4 
	end If

    ' Table specific

    If bGameInPLay AND NOT Tilted Then
        If keycode = LeftFlipperKey Then
			DOF 101, DOfoff 'Turn off flipper solenoid
			FlipperDeActivate LeftFlipper, LFPress
            SolLFlipper 0
            InstantInfoTimer.Enabled = False
            If bInstantInfo Then
                DMDScoreNow
                bInstantInfo = False
            End If
        End If
        If keycode = RightFlipperKey Then
			DOF 102, DOfoff 'Turn off flipper solenoid
			FlipperDeActivate RightFlipper, RFPress
            SolRFlipper 0
            InstantInfoTimer.Enabled = False
            If bInstantInfo Then
                DMDScoreNow
                bInstantInfo = False
            End If
        End If
    End If

' test Keys
End Sub

Sub InstantInfoTimer_Timer
    InstantInfoTimer.Enabled = False
    If NOT hsbModeActive Then
        bInstantInfo = True
        DMDFlush
        InstantInfo
    End If
End Sub

Sub RotateLaneLights(dir)
    Dim tmp
    If dir = 1 Then 'rotate left
        tmp = TopLanes(CurrentPLayer, 1)
        TopLanes(CurrentPLayer, 1) = TopLanes(CurrentPLayer, 2)
        TopLanes(CurrentPLayer, 2) = TopLanes(CurrentPLayer, 3)
        TopLanes(CurrentPLayer, 3) = tmp
        tmp = LowerLanes(CurrentPLayer, 1)
        LowerLanes(CurrentPLayer, 1) = LowerLanes(CurrentPLayer, 2)
        LowerLanes(CurrentPLayer, 2) = LowerLanes(CurrentPLayer, 3)
        LowerLanes(CurrentPLayer, 3) = LowerLanes(CurrentPLayer, 4)
        LowerLanes(CurrentPLayer, 4) = tmp
    Else 'rotate RightFlipper
        tmp = TopLanes(CurrentPLayer, 3)
        TopLanes(CurrentPLayer, 3) = TopLanes(CurrentPLayer, 2)
        TopLanes(CurrentPLayer, 2) = TopLanes(CurrentPLayer, 1)
        TopLanes(CurrentPLayer, 1) = tmp
        tmp = LowerLanes(CurrentPLayer, 4)
        LowerLanes(CurrentPLayer, 4) = LowerLanes(CurrentPLayer, 3)
        LowerLanes(CurrentPLayer, 3) = LowerLanes(CurrentPLayer, 2)
        LowerLanes(CurrentPLayer, 2) = LowerLanes(CurrentPLayer, 1)
        LowerLanes(CurrentPLayer, 1) = tmp
    End If
    UpdateTopLaneLights
    UpdateLowerLaneLights
End Sub

'*************
' Pause Table
'*************

Sub table1_Paused
End Sub

Sub table1_unPaused
End Sub

Sub Table1_Exit
    Savehs
    If UseFlexDMD Then FlexDMD.Run = False
    If B2SOn = true Then Controller.Stop
End Sub

'********************
'     Flippers
'********************

Const ReflipAngle = 20

Sub SolLFlipper(Enabled)
    If Enabled Then
		LF.Fire
		LeftFlipperRoach.EOSTorque = 0.275:LeftFlipperRoach.RotateToEnd
		If leftflipper.currentangle < leftflipper.endangle + ReflipAngle Then 
			RandomSoundReflipUpLeft LeftFlipper
		Else 
			SoundFlipperUpAttackLeft LeftFlipper
			RandomSoundFlipperUpLeft LeftFlipper
		End If	
    Else
		LeftFlipper.RotateToStart
		LeftFlipperRoach.EOSTorque = 0.125:LeftFlipperRoach.RotateToStart
		If LeftFlipper.currentangle < LeftFlipper.startAngle - 5 Then
			RandomSoundFlipperDownLeft LeftFlipper
		End If
		FlipperLeftHitParm = FlipperUpSoundLevel
    End If
End Sub

Sub SolRFlipper(Enabled)
    If Enabled Then
		RF.Fire
        RightFlipper2.EOSTorque = 0.275:RightFlipper2.RotateToEnd
		RightFlipperRoach.EOSTorque = 0.275:RightFlipperRoach.RotateToEnd
		
		If rightflipper.currentangle > rightflipper.endangle - ReflipAngle Then
			RandomSoundReflipUpRight RightFlipper
			RandomSoundReflipUpRight2 RightFlipper2
		Else 
			SoundFlipperUpAttackRight RightFlipper
			RandomSoundFlipperUpRight RightFlipper
			SoundFlipperUpAttackRight2 RightFlipper2
			RandomSoundFlipperUpRight2 RightFlipper2
		End If
	Else
		RightFlipper.RotateToStart
        RightFlipper2.EOSTorque = 0.125:RightFlipper2.RotateToStart
		RightFlipperRoach.EOSTorque = 0.125:RightFlipperRoach.RotateToStart
		If RightFlipper.currentangle > RightFlipper.startAngle + 5 Then
			RandomSoundFlipperDownRight RightFlipper
			RandomSoundFlipperDownRight2 RightFlipper2
		End If	
		FlipperRightHitParm = FlipperUpSoundLevel
		FlipperRight2HitParm = FlipperUpSoundLevel
    End If
End Sub

' flippers hit Sound

Sub LeftFlipper_Collide(parm)
	CheckLiveCatch Activeball, LeftFlipper, LFCount, parm
	LeftFlipperCollide parm
End Sub

Sub RightFlipper2_Collide(parm)
	RightFlipper2Collide parm
End Sub

Sub RightFlipper_Collide(parm)
	CheckLiveCatch Activeball, RightFlipper, RFCount, parm
	RightFlipperCollide parm
End Sub

'*********
' TILT
'*********

'NOTE: The TiltDecreaseTimer Subtracts .01 from the "Tilt" variable every round

Sub CheckTilt 'Called when table is nudged
    Dim BOT
    BOT = GetBalls
    ' exit the sub if no balls on the table
    If UBound(BOT) = lob - 1 Then Exit Sub
    Tilt = Tilt + TiltSensitivity                 'Add to tilt count
    TiltDecreaseTimer.Enabled = True
    If(Tilt > TiltSensitivity)AND(Tilt <= 15)Then 'show a warning
        DMD "_", CL("CAREFUL"), "_", eNone, eBlinkFast, eNone, 1000, True, ""
    End if
    If(NOT Tilted)AND Tilt > 15 Then 'If more that 15 then TILT the table
        'display Tilt
        InstantInfoTimer.Enabled = False
        DMDFlush
        DMD CL("YOU"), CL("TILTED"), "", eNone, eNone, eNone, 3000, True, "vo_tilt" &RndNbr(3)
		DOF 146, DOFPulse 'MX Tilted
        DisableTable True
        TiltRecoveryTimer.Enabled = True 'start the Tilt delay to check for all the balls to be drained
        StopMBmodes


		If VRRoom > 0 Then
			VRBGFlashIT.enabled = True
		End If

    End If
End Sub

dim bEnableBloodTrails:	bEnableBloodTrails = False

Sub TiltDecreaseTimer_Timer
    ' DecreaseTilt
    If Tilt > 0 Then
        Tilt = Tilt - 0.1
    Else
        TiltDecreaseTimer.Enabled = False
    End If
End Sub

Sub DisableTable(Enabled)
    If Enabled Then
        Tilted = True
        'turn off GI and turn off all the lights
        GiOff
        LightSeqTilt.Play SeqAllOff
        'Disable slings, bumpers etc
        LeftFlipper.RotateToStart
        RightFlipper2.RotateToStart
        RightFlipper.RotateToStart
        Bumper1.Threshold = 100
        Bumper2.Threshold = 100
        Bumper3.Threshold = 100
        LeftSlingshot.Disabled = 1
        RightSlingshot.Disabled = 1
        TopMagnet.MagnetOn = False
        LeftMagnet.MagnetOn = False
        RightMagnet.MagnetOn = False
    Else
        Tilted = False
        'turn back on GI and the lights
        GiOn
        LightSeqTilt.StopPlay
        Bumper1.Threshold = 1
        Bumper2.Threshold = 1
        Bumper3.Threshold = 1
        LeftSlingshot.Disabled = 0
        RightSlingshot.Disabled = 0
        'clean up the buffer display
        DMDFlush
    End If
End Sub

Sub TiltRecoveryTimer_Timer()
    ' if all the balls have been drained then..
    If(BallsOnPlayfield = 0)Then
        ' do the normal end of ball thing (this doesn't give a bonus if the table is tilted)
        vpmtimer.Addtimer 2000, "EndOfBall() '"
        TiltRecoveryTimer.Enabled = False
    End If
' else retry (checks again in another second or so)
End Sub

'*****************************************
'         Music as wav sounds
' in VPX 10.7 you may use also mp3 or ogg
'*****************************************

Dim Song
Song = ""

Sub PlaySong(name)
    If bMusicOn Then
        If Song <> name Then
            StopSound Song
            Song = name
            PlaySound Song, -1, SongVolume
        End If
    End If
End Sub

Sub ChangeSong
    Select Case Mode(CurrentPlayer, 0)
        Case 0:
            If bMultiBallStarted Then
                Select Case MultiballType(CurrentPlayer)
                    Case 1:PlaySong "m_multiball1"
                    Case 2:PlaySong "m_multiball2"
                    Case 3:PlaySong "m_multiball1"
                    Case 4:PlaySong "m_multiball2"
                End Select
            Else
                PlaySong "m_main"
            End If
        Case 1, 2, 3:PlaySong "m_mode1"
        Case 5, 6, 7:PlaySong "m_mode2"
        Case 7, 8, 9, 10, 11:PlaySong "m_mode3"
        Case 12, 13, 14:PlaySong "m_main2"
    End Select
	debug.print Song
End Sub

Sub StopSong(name)
    StopSound name
	Song = ""
End Sub

'********************
' Play random sounds
'********************

Dim Thunder:Thunder = ""
Dim Boom 'Loop Counter


Sub PlayThunder
	Boom=1
	Dof 164, Dofpulse 'Strobe and Shaker pulse for lightning
	B2SLightning_Start
	StopSound Thunder
    Thunder = "sfx_thunder" &RndNbr(13)

	if bThunderLighting then
		select case RndInt(1,3)
			case 1: LightSeqThunder.StopPlay : LightSeqThunder.Play SeqBlinking, , 20, 10
			case 2: LightSeqThunder.StopPlay : LightSeqThunder.Play SeqBlinking, , 10, 20
			case 3: LightSeqThunder.StopPlay : LightSeqThunder.Play SeqBlinking, , 10, 10
		end select
	end if
    PlaySound Thunder, , 0.2
    LightSeqHouse.StopPlay
    LightSeqHouse.Play SeqRandom, 10, , 6000

End Sub

Sub PlayElectro
    PlaySound "sfx_electro" &RndNbr(9), , 0.3
End Sub

Sub B2SLightning_Start
	DOF 163, DOFon 'turn on b2s effect and table dof
	B2SLightningOff.Enabled=True	
End Sub

Sub B2SLightningOff_Timer()
	B2SLightningOff.Enabled=False
	DOF 163,DOFoff 'turn off b2s effect	
	Boom= Boom+1 
	If Boom < 11 Then B2SLightningOn.Enabled=True 'Loop the DOF on/off trigger X times
End Sub

Sub B2SLightningOn_Timer()
	B2SLightningOn.Enabled=False
	DOF 163, DOFon 'turn on b2s effect
	B2SLightningOff.Enabled=True 'Loop back up to the off timer
End Sub







'**********************
'     GI effects
' independent routine
' it turns on the gi
' when there is a ball
' in play
'**********************

Dim GiIntensity
GiIntensity = 1   'used for the LUT changing to increase the GI lights when the table is darker

Sub ChangeGi(col) 'changes the gi color
    Dim bulb
    For each bulb in aGILights
        SetLightColor bulb, col, -1
    Next
End Sub

Sub ChangeGIIntensity(factor) 'changes the intensity scale
    Dim bulb
    For each bulb in aGILights
        bulb.IntensityScale = GiIntensity * factor
    Next
End Sub

Sub GiOn
'    PlaySoundAt "fx_GiOn", li000 'about the center of the table
    DOF 118, DOFOn
    Dim bulb
    For each bulb in aGiLights
        bulb.State = 1
	ShadowsGI.visible = 1
    Next
    For each bulb in aGiBlink
        bulb.State = 2
    Next
    DarkNight.Visible = 0
    aBallGlowing = False
    For each bulb in aBallGlow
        bulb.Visible = 0
    Next

	If VRRoom > 0 Then
		BGBright.visible = 1
	End If

End Sub

Sub GiOff
    DOF 118, DOFOff
    Dim bulb
    For each bulb in aGiLights
        bulb.State = 0
	ShadowsGI.visible = 0
    Next
    For each bulb in aGiBlink
        bulb.State = 0
    Next
End Sub

Sub NightMode                     'a kind of Gi Off but darker, stops by turning the GI back on
	DOF 118, DOFOff
    Dim bulb
    For each bulb in aGiLights
        bulb.State = 0
    Next
    For each bulb in aGiBlink
        bulb.State = 2
    Next
    DarkNight.Visible = 1
    aBallGlowing = True

	If VRRoom > 0 Then
		BGBright.visible = 0
	End If

End Sub

' GI, light & flashers sequence effects
Dim GIStateOld, GIStateNew
Sub GIUpdate
	Dim iii
	GIStateNew = gi023.GetInPlayStateBool
'	Debug.print GIStateNew
'	Debug.print GIStateOld
	If GIStateNew <> GIStateOld Then
		If GIStateNew = -1 and GIStateOld = 0 Then
			Sound_GI_Relay 1, li000
		ElseIf GIStateNew = 0 and GIStateOld = -1 Then
			Sound_GI_Relay 0, li000
		End If
	End If
	GIStateOld = GIStateNew
End Sub

Sub GiEffect(n)
    Dim ii
    Select Case n
        Case 0 'all off
            LightSeqGi.Play SeqAlloff
        Case 1 'all blink
            LightSeqGi.UpdateInterval = 40
            LightSeqGi.Play SeqBlinking, , 15, 25
        Case 2 'random
            LightSeqGi.UpdateInterval = 25
            LightSeqGi.Play SeqRandom, 50, , 1000
        Case 3 'all blink fast
            LightSeqGi.UpdateInterval = 40
            LightSeqGi.Play SeqBlinking, , 10, 20
    End Select
End Sub

Sub LightEffect(n)
    Select Case n
        Case 0 ' all off
            LightSeqInserts.Play SeqAlloff
        Case 1 'all blink
            LightSeqInserts.UpdateInterval = 40
            LightSeqInserts.Play SeqBlinking, , 15, 25
        Case 2 'random
            LightSeqInserts.UpdateInterval = 25
            LightSeqInserts.Play SeqRandom, 50, , 1000
        Case 3 'all blink fast
            LightSeqInserts.UpdateInterval = 20
            LightSeqInserts.Play SeqBlinking, , 10, 10
        Case 4 'center - used in the bonus count
            LightSeqInserts.UpdateInterval = 10
            LightSeqInserts.Play SeqCircleOutOn, 15, 1
        Case 5 'top down
            LightSeqInserts.UpdateInterval = 4
            LightSeqInserts.Play SeqDownOn, 15, 2
        Case 6 'down to top
            LightSeqInserts.UpdateInterval = 4
            LightSeqInserts.Play SeqUpOn, 15, 1
    End Select
End Sub

Dim FlashStateOld(6), FlashStateNew(6), FlasherLights:FlasherLights = Array (F1B, F2B, f3b, f4b, f5b, f6b)
Sub FlasherUpdate
	Dim iii
	For iii = 0 to 5
		FlashStateNew(iii) = FlasherLights(iii).GetInPlayStateBool
'		Debug.print FlashStateNew(iii)
		If FlashStateNew(iii) = -1 and FlashStateOld(iii) = 0 Then
			Sound_Flash_Relay 1, FlasherLights(iii)
		ElseIf FlashStateNew(iii) = 0 and FlashStateOld(iii) = -1 Then
			Sound_Flash_Relay 0, FlasherLights(iii)
		End If
		FlashStateOld(iii)=FlashStateNew(iii)
	Next
End Sub

Sub FlashEffect(n)
    Select Case n
        Case 0 ' all off
            LightSeqFlashers.Play SeqAlloff
        Case 1 'all blink
            LightSeqFlashers.UpdateInterval = 40
            LightSeqFlashers.Play SeqBlinking, , 15, 25
        Case 2 'random
            LightSeqFlashers.UpdateInterval = 25
            LightSeqFlashers.Play SeqRandom, 50, , 1000
        Case 3 'all blink fast
            LightSeqFlashers.UpdateInterval = 20
            LightSeqFlashers.Play SeqBlinking, , 10, 20
        Case 4 'center
            LightSeqFlashers.UpdateInterval = 10
            LightSeqFlashers.Play SeqCircleOutOn, 15, 1
        Case 5 'top down
            LightSeqFlashers.UpdateInterval = 10
            LightSeqFlashers.Play SeqDownOn, 15, 1
        Case 6 'down to top
            LightSeqFlashers.UpdateInterval = 10
            LightSeqFlashers.Play SeqUpOn, 15, 1
        Case 7 'top flashers left right
            LightSeqTopFlashers.UpdateInterval = 10
            LightSeqTopFlashers.Play SeqRightOn, 50, 10
        Case 8 'It
            LightSeqIT.UpdateInterval = 10
            LightSeqIT.Play SeqBlinking, , 15, 15
    End Select
End Sub

'******************************************************
' VPW TargetBouncer for targets and posts by Iaakki, Wrd1972, Apophis
'******************************************************

Const TargetBouncerEnabled = 1 		'0 = normal standup targets, 1 = bouncy targets
Const TargetBouncerFactor = 0.7 	'Level of bounces. Recommmended value of 0.7

sub TargetBouncer(aBall,defvalue)
    dim zMultiplier, vel, vratio
    if TargetBouncerEnabled = 1 and aball.z < 30 then
        'debug.print "velx: " & aball.velx & " vely: " & aball.vely & " velz: " & aball.velz
        vel = BallSpeed(aBall)
        if aBall.velx = 0 then vratio = 1 else vratio = aBall.vely/aBall.velx
        Select Case Int(Rnd * 6) + 1
            Case 1: zMultiplier = 0.2*defvalue
			Case 2: zMultiplier = 0.25*defvalue
            Case 3: zMultiplier = 0.3*defvalue
			Case 4: zMultiplier = 0.4*defvalue
            Case 5: zMultiplier = 0.45*defvalue
            Case 6: zMultiplier = 0.5*defvalue
        End Select
        aBall.velz = abs(vel * zMultiplier * TargetBouncerFactor)
        aBall.velx = sgn(aBall.velx) * sqr(abs((vel^2 - aBall.velz^2)/(1+vratio^2)))
        aBall.vely = aBall.velx * vratio
        'debug.print "---> velx: " & aball.velx & " vely: " & aball.vely & " velz: " & aball.velz
        'debug.print "conservation check: " & BallSpeed(aBall)/vel
	end if
end sub

' Add targets or posts to the TargetBounce collection if you want to activate the targetbouncer code from them
Sub TargetBounce_Hit(idx)
	TargetBouncer activeball, 1
End Sub


'******************************************************
'****  GENERAL ADVICE ON PHYSICS
'******************************************************
'
' It's advised that flipper corrections, dampeners, and general physics settings should all be updated per these 
' examples as all of these improvements work together to provide a realistic physics simulation.
'
' Tutorial videos provided by Bord
' Flippers: 	https://www.youtube.com/watch?v=FWvM9_CdVHw
' Dampeners: 	https://www.youtube.com/watch?v=tqsxx48C6Pg
' Physics: 		https://www.youtube.com/watch?v=UcRMG-2svvE
'
'
' Note: BallMass must be set to 1. BallSize should be set to 50 (in other words the ball radius is 25) 
'
' Recommended Table Physics Settings
' | Gravity Constant             | 0.97      |
' | Playfield Friction           | 0.15-0.25 |
' | Playfield Elasticity         | 0.25      |
' | Playfield Elasticity Falloff | 0         |
' | Playfield Scatter            | 0         |
' | Default Element Scatter      | 2         |
'
' Bumpers
' | Force         | 9.5-10.5 |
' | Hit Threshold | 1.6-2    |
' | Scatter Angle | 2        |
' 
' Slingshots
' | Hit Threshold      | 2    |
' | Slingshot Force    | 4-5  |
' | Slingshot Theshold | 2-3  |
' | Elasticity         | 0.85 |
' | Friction           | 0.8  |
' | Scatter Angle      | 1    |



'******************************************************
'****  FLIPPER CORRECTIONS by nFozzy
'******************************************************
'
' There are several steps for taking advantage of nFozzy's flipper solution.  At a high level we?ll need the following:
'	1. flippers with specific physics settings
'	2. custom triggers for each flipper (TriggerLF, TriggerRF)
'	3. an object or point to tell the script where the tip of the flipper is at rest (EndPointLp, EndPointRp)
'	4. and, special scripting
'
' A common mistake is incorrect flipper length.  A 3-inch flipper with rubbers will be about 3.125 inches long.  
' This translates to about 147 vp units.  Therefore, the flipper start radius + the flipper length + the flipper end 
' radius should  equal approximately 147 vp units. Another common mistake is is that sometimes the right flipper
' angle was set with a large postive value (like 238 or something). It should be using negative value (like -122).
'
' The following settings are a solid starting point for various eras of pinballs.
' |                    | EM's           | late 70's to mid 80's | mid 80's to early 90's | mid 90's and later |
' | ------------------ | -------------- | --------------------- | ---------------------- | ------------------ |
' | Mass               | 1              | 1                     | 1                      | 1                  |
' | Strength           | 500-1000 (750) | 1400-1600 (1500)      | 2000-2600              | 3200-3300 (3250)   |
' | Elasticity         | 0.88           | 0.88                  | 0.88                   | 0.88               |
' | Elasticity Falloff | 0.15           | 0.15                  | 0.15                   | 0.15               |
' | Fricition          | 0.8-0.9        | 0.9                   | 0.9                    | 0.9                |
' | Return Strength    | 0.11           | 0.09                  | 0.07                   | 0.055              |
' | Coil Ramp Up       | 2.5            | 2.5                   | 2.5                    | 2.5                |
' | Scatter Angle      | 0              | 0                     | 0                      | 0                  |
' | EOS Torque         | 0.3            | 0.3                   | 0.275                  | 0.275              |
' | EOS Torque Angle   | 4              | 4                     | 6                      | 6                  |
'


'******************************************************
' Flippers Polarity (Select appropriate sub based on era) 
'******************************************************

dim LF : Set LF = New FlipperPolarity
dim RF : Set RF = New FlipperPolarity

InitPolarity

'*******************************************
' Early 90's and after

Sub InitPolarity()
        dim x, a : a = Array(LF, RF)
        for each x in a
                x.AddPoint "Ycoef", 0, RightFlipper.Y-65, 1        'disabled
                x.AddPoint "Ycoef", 1, RightFlipper.Y-11, 1
                x.enabled = True
                x.TimeDelay = 60
        Next

        AddPt "Polarity", 0, 0, 0
        AddPt "Polarity", 1, 0.05, -5.5
        AddPt "Polarity", 2, 0.4, -5.5
        AddPt "Polarity", 3, 0.6, -5.0
        AddPt "Polarity", 4, 0.65, -4.5
        AddPt "Polarity", 5, 0.7, -4.0
        AddPt "Polarity", 6, 0.75, -3.5
        AddPt "Polarity", 7, 0.8, -3.0
        AddPt "Polarity", 8, 0.85, -2.5
        AddPt "Polarity", 9, 0.9,-2.0
        AddPt "Polarity", 10, 0.95, -1.5
        AddPt "Polarity", 11, 1, -1.0
        AddPt "Polarity", 12, 1.05, -0.5
        AddPt "Polarity", 13, 1.1, 0
        AddPt "Polarity", 14, 1.3, 0

        addpt "Velocity", 0, 0,         1
        addpt "Velocity", 1, 0.16, 1.06
        addpt "Velocity", 2, 0.41,         1.05
        addpt "Velocity", 3, 0.53,         1'0.982
        addpt "Velocity", 4, 0.702, 0.968
        addpt "Velocity", 5, 0.95,  0.968
        addpt "Velocity", 6, 1.03,         0.945

        LF.Object = LeftFlipper        
        LF.EndPoint = EndPointLp
        RF.Object = RightFlipper
        RF.EndPoint = EndPointRp
End Sub


' Flipper trigger hit subs
Sub TriggerLF_Hit() : LF.Addball activeball : End Sub
Sub TriggerLF_UnHit() : LF.PolarityCorrect activeball : End Sub
Sub TriggerRF_Hit() : RF.Addball activeball : End Sub
Sub TriggerRF_UnHit() : RF.PolarityCorrect activeball : End Sub




'******************************************************
'  FLIPPER CORRECTION FUNCTIONS
'******************************************************

Class FlipperPolarity
	Public DebugOn, Enabled
	Private FlipAt        'Timer variable (IE 'flip at 723,530ms...)
	Public TimeDelay        'delay before trigger turns off and polarity is disabled TODO set time!
	private Flipper, FlipperStart,FlipperEnd, FlipperEndY, LR, PartialFlipCoef
	Private Balls(20), balldata(20)

	dim PolarityIn, PolarityOut
	dim VelocityIn, VelocityOut
	dim YcoefIn, YcoefOut
	Public Sub Class_Initialize 
		redim PolarityIn(0) : redim PolarityOut(0) : redim VelocityIn(0) : redim VelocityOut(0) : redim YcoefIn(0) : redim YcoefOut(0)
		Enabled = True : TimeDelay = 50 : LR = 1:  dim x : for x = 0 to uBound(balls) : balls(x) = Empty : set Balldata(x) = new SpoofBall : next 
	End Sub

	Public Property let Object(aInput) : Set Flipper = aInput : StartPoint = Flipper.x : End Property
	Public Property Let StartPoint(aInput) : if IsObject(aInput) then FlipperStart = aInput.x else FlipperStart = aInput : end if : End Property
	Public Property Get StartPoint : StartPoint = FlipperStart : End Property
	Public Property Let EndPoint(aInput) : FlipperEnd = aInput.x: FlipperEndY = aInput.y: End Property
	Public Property Get EndPoint : EndPoint = FlipperEnd : End Property        
	Public Property Get EndPointY: EndPointY = FlipperEndY : End Property

	Public Sub AddPoint(aChooseArray, aIDX, aX, aY) 'Index #, X position, (in) y Position (out) 
		Select Case aChooseArray
			case "Polarity" : ShuffleArrays PolarityIn, PolarityOut, 1 : PolarityIn(aIDX) = aX : PolarityOut(aIDX) = aY : ShuffleArrays PolarityIn, PolarityOut, 0
			Case "Velocity" : ShuffleArrays VelocityIn, VelocityOut, 1 :VelocityIn(aIDX) = aX : VelocityOut(aIDX) = aY : ShuffleArrays VelocityIn, VelocityOut, 0
			Case "Ycoef" : ShuffleArrays YcoefIn, YcoefOut, 1 :YcoefIn(aIDX) = aX : YcoefOut(aIDX) = aY : ShuffleArrays YcoefIn, YcoefOut, 0
		End Select
		if gametime > 100 then Report aChooseArray
	End Sub 

	Public Sub Report(aChooseArray)         'debug, reports all coords in tbPL.text
		if not DebugOn then exit sub
		dim a1, a2 : Select Case aChooseArray
			case "Polarity" : a1 = PolarityIn : a2 = PolarityOut
			Case "Velocity" : a1 = VelocityIn : a2 = VelocityOut
			Case "Ycoef" : a1 = YcoefIn : a2 = YcoefOut 
				case else :tbpl.text = "wrong string" : exit sub
		End Select
		dim str, x : for x = 0 to uBound(a1) : str = str & aChooseArray & " x: " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
		tbpl.text = str
	End Sub

	Public Sub AddBall(aBall) : dim x : for x = 0 to uBound(balls) : if IsEmpty(balls(x)) then set balls(x) = aBall : exit sub :end if : Next  : End Sub

	Private Sub RemoveBall(aBall)
		dim x : for x = 0 to uBound(balls)
			if TypeName(balls(x) ) = "IBall" then 
				if aBall.ID = Balls(x).ID Then
					balls(x) = Empty
					Balldata(x).Reset
				End If
			End If
		Next
	End Sub

	Public Sub Fire() 
		Flipper.RotateToEnd
		processballs
	End Sub

	Public Property Get Pos 'returns % position a ball. For debug stuff.
		dim x : for x = 0 to uBound(balls)
			if not IsEmpty(balls(x) ) then
				pos = pSlope(Balls(x).x, FlipperStart, 0, FlipperEnd, 1)
			End If
		Next                
	End Property

	Public Sub ProcessBalls() 'save data of balls in flipper range
		FlipAt = GameTime
		dim x : for x = 0 to uBound(balls)
			if not IsEmpty(balls(x) ) then
				balldata(x).Data = balls(x)
			End If
		Next
		PartialFlipCoef = ((Flipper.StartAngle - Flipper.CurrentAngle) / (Flipper.StartAngle - Flipper.EndAngle))
		PartialFlipCoef = abs(PartialFlipCoef-1)
	End Sub
	Private Function FlipperOn() : if gameTime < FlipAt+TimeDelay then FlipperOn = True : End If : End Function        'Timer shutoff for polaritycorrect

	Public Sub PolarityCorrect(aBall)
		if FlipperOn() then 
			dim tmp, BallPos, x, IDX, Ycoef : Ycoef = 1

			'y safety Exit
			if aBall.VelY > -8 then 'ball going down
				RemoveBall aBall
				exit Sub
			end if

			'Find balldata. BallPos = % on Flipper
			for x = 0 to uBound(Balls)
				if aBall.id = BallData(x).id AND not isempty(BallData(x).id) then 
					idx = x
					BallPos = PSlope(BallData(x).x, FlipperStart, 0, FlipperEnd, 1)
					if ballpos > 0.65 then  Ycoef = LinearEnvelope(BallData(x).Y, YcoefIn, YcoefOut)                                'find safety coefficient 'ycoef' data
				end if
			Next

			If BallPos = 0 Then 'no ball data meaning the ball is entering and exiting pretty close to the same position, use current values.
				BallPos = PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1)
				if ballpos > 0.65 then  Ycoef = LinearEnvelope(aBall.Y, YcoefIn, YcoefOut)                                                'find safety coefficient 'ycoef' data
			End If

			'Velocity correction
			if not IsEmpty(VelocityIn(0) ) then
				Dim VelCoef
				VelCoef = LinearEnvelope(BallPos, VelocityIn, VelocityOut)

				if partialflipcoef < 1 then VelCoef = PSlope(partialflipcoef, 0, 1, 1, VelCoef)

				if Enabled then aBall.Velx = aBall.Velx*VelCoef
				if Enabled then aBall.Vely = aBall.Vely*VelCoef
			End If

			'Polarity Correction (optional now)
			if not IsEmpty(PolarityIn(0) ) then
				If StartPoint > EndPoint then LR = -1        'Reverse polarity if left flipper
				dim AddX : AddX = LinearEnvelope(BallPos, PolarityIn, PolarityOut) * LR

				if Enabled then aBall.VelX = aBall.VelX + 1 * (AddX*ycoef*PartialFlipcoef)
			End If
		End If
		RemoveBall aBall
	End Sub
End Class



'******************************************************
'  SLINGSHOT CORRECTION FUNCTIONS
'******************************************************
' To add these slingshot corrections:
' 	- On the table, add the endpoint primitives that define the two ends of the Slingshot
'	- Initialize the SlingshotCorrection objects in InitSlingCorrection
' 	- Call the .VelocityCorrect methods from the respective _Slingshot event sub


dim LS : Set LS = New SlingshotCorrection
dim LS2: Set LS2= New SlingshotCorrection
dim RS : Set RS = New SlingshotCorrection

InitSlingCorrection

Sub InitSlingCorrection

	LS.Object = LeftSlingshot
	LS.EndPoint1 = EndPoint1LS
	LS.EndPoint2 = EndPoint2LS

	LS2.Object = LeftSlingshot2
	LS2.EndPoint1 = EndPoint1LS2
	LS2.EndPoint2 = EndPoint2LS2

	RS.Object = RightSlingshot
	RS.EndPoint1 = EndPoint1RS
	RS.EndPoint2 = EndPoint2RS

	'Slingshot angle corrections (pt, BallPos in %, Angle in deg)
	' These values are best guesses. Retune them if needed based on specific table research.
	AddSlingsPt 0, 0.00,	-4
	AddSlingsPt 1, 0.45,	-7
	AddSlingsPt 2, 0.48,	0
	AddSlingsPt 3, 0.52,	0
	AddSlingsPt 4, 0.55,	7
	AddSlingsPt 5, 1.00,	4

End Sub


Sub AddSlingsPt(idx, aX, aY)        'debugger wrapper for adjusting flipper script in-game
	dim a : a = Array(LS, RS)
	dim x : for each x in a
		x.addpoint idx, aX, aY
	Next
End Sub

'' The following sub are needed, however they may exist somewhere else in the script. Uncomment below if needed
'Dim PI: PI = 4*Atn(1)
'Function dSin(degrees)
'	dsin = sin(degrees * Pi/180)
'End Function
'Function dCos(degrees)
'	dcos = cos(degrees * Pi/180)
'End Function
'
Function RotPoint(x,y,angle)
    dim rx, ry
    rx = x*dCos(angle) - y*dSin(angle)
    ry = x*dSin(angle) + y*dCos(angle)
    RotPoint = Array(rx,ry)
End Function

Class SlingshotCorrection
	Public DebugOn, Enabled
	private Slingshot, SlingX1, SlingX2, SlingY1, SlingY2

	Public ModIn, ModOut
	Private Sub Class_Initialize : redim ModIn(0) : redim Modout(0): Enabled = True : End Sub 

	Public Property let Object(aInput) : Set Slingshot = aInput : End Property
	Public Property Let EndPoint1(aInput) : SlingX1 = aInput.x: SlingY1 = aInput.y: End Property
	Public Property Let EndPoint2(aInput) : SlingX2 = aInput.x: SlingY2 = aInput.y: End Property

	Public Sub AddPoint(aIdx, aX, aY) 
		ShuffleArrays ModIn, ModOut, 1 : ModIn(aIDX) = aX : ModOut(aIDX) = aY : ShuffleArrays ModIn, ModOut, 0
		If gametime > 100 then Report
	End Sub

	Public Sub Report()         'debug, reports all coords in tbPL.text
		If not debugOn then exit sub
		dim a1, a2 : a1 = ModIn : a2 = ModOut
		dim str, x : for x = 0 to uBound(a1) : str = str & x & ": " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
		TBPout.text = str
	End Sub


	Public Sub VelocityCorrect(aBall)
		dim BallPos, XL, XR, YL, YR
		
		'Assign right and left end points
		If SlingX1 < SlingX2 Then 
			XL = SlingX1 : YL = SlingY1 : XR = SlingX2 : YR = SlingY2
		Else
			XL = SlingX2 : YL = SlingY2 : XR = SlingX1 : YR = SlingY1
		End If

		'Find BallPos = % on Slingshot
		If Not IsEmpty(aBall.id) Then 
			If ABS(XR-XL) > ABS(YR-YL) Then 
				BallPos = PSlope(aBall.x, XL, 0, XR, 1)
			Else
				BallPos = PSlope(aBall.y, YL, 0, YR, 1)
			End If
			If BallPos < 0 Then BallPos = 0
			If BallPos > 1 Then BallPos = 1
		End If

		'Velocity angle correction
		If not IsEmpty(ModIn(0) ) then
			Dim Angle, RotVxVy
			Angle = LinearEnvelope(BallPos, ModIn, ModOut)
			'debug.print " BallPos=" & BallPos &" Angle=" & Angle 
			'debug.print " BEFORE: aBall.Velx=" & aBall.Velx &" aBall.Vely" & aBall.Vely 
			RotVxVy = RotPoint(aBall.Velx,aBall.Vely,Angle)
			If Enabled then aBall.Velx = RotVxVy(0)
			If Enabled then aBall.Vely = RotVxVy(1)
			'debug.print " AFTER: aBall.Velx=" & aBall.Velx &" aBall.Vely" & aBall.Vely 
			'debug.print " " 
		End If
	End Sub

End Class



'******************************************************
'  FLIPPER POLARITY. RUBBER DAMPENER, AND SLINGSHOT CORRECTION SUPPORTING FUNCTIONS 
'******************************************************


Sub AddPt(aStr, idx, aX, aY)        'debugger wrapper for adjusting flipper script in-game
	dim a : a = Array(LF, RF)
	dim x : for each x in a
		x.addpoint aStr, idx, aX, aY
	Next
End Sub


' Used for flipper correction and rubber dampeners
Sub ShuffleArray(ByRef aArray, byVal offset) 'shuffle 1d array
	dim x, aCount : aCount = 0
	redim a(uBound(aArray) )
	for x = 0 to uBound(aArray)        'Shuffle objects in a temp array
		if not IsEmpty(aArray(x) ) Then
			if IsObject(aArray(x)) then 
				Set a(aCount) = aArray(x)
			Else
				a(aCount) = aArray(x)
			End If
			aCount = aCount + 1
		End If
	Next
	if offset < 0 then offset = 0
	redim aArray(aCount-1+offset)        'Resize original array
	for x = 0 to aCount-1                'set objects back into original array
		if IsObject(a(x)) then 
			Set aArray(x) = a(x)
		Else
			aArray(x) = a(x)
		End If
	Next
End Sub

' Used for flipper correction and rubber dampeners
Sub ShuffleArrays(aArray1, aArray2, offset)
	ShuffleArray aArray1, offset
	ShuffleArray aArray2, offset
End Sub

' Used for flipper correction, rubber dampeners, and drop targets
Function BallSpeed(ball) 'Calculates the ball speed
	BallSpeed = SQR(ball.VelX^2 + ball.VelY^2 + ball.VelZ^2)
End Function

' Used for flipper correction and rubber dampeners
Function PSlope(Input, X1, Y1, X2, Y2)        'Set up line via two points, no clamping. Input X, output Y
	dim x, y, b, m : x = input : m = (Y2 - Y1) / (X2 - X1) : b = Y2 - m*X2
	Y = M*x+b
	PSlope = Y
End Function

' Used for flipper correction
Class spoofball 
	Public X, Y, Z, VelX, VelY, VelZ, ID, Mass, Radius 
	Public Property Let Data(aBall)
		With aBall
			x = .x : y = .y : z = .z : velx = .velx : vely = .vely : velz = .velz
			id = .ID : mass = .mass : radius = .radius
		end with
	End Property
	Public Sub Reset()
		x = Empty : y = Empty : z = Empty  : velx = Empty : vely = Empty : velz = Empty 
		id = Empty : mass = Empty : radius = Empty
	End Sub
End Class

' Used for flipper correction and rubber dampeners
Function LinearEnvelope(xInput, xKeyFrame, yLvl)
	dim y 'Y output
	dim L 'Line
	dim ii : for ii = 1 to uBound(xKeyFrame)        'find active line
		if xInput <= xKeyFrame(ii) then L = ii : exit for : end if
	Next
	if xInput > xKeyFrame(uBound(xKeyFrame) ) then L = uBound(xKeyFrame)        'catch line overrun
	Y = pSlope(xInput, xKeyFrame(L-1), yLvl(L-1), xKeyFrame(L), yLvl(L) )

	if xInput <= xKeyFrame(lBound(xKeyFrame) ) then Y = yLvl(lBound(xKeyFrame) )         'Clamp lower
	if xInput >= xKeyFrame(uBound(xKeyFrame) ) then Y = yLvl(uBound(xKeyFrame) )        'Clamp upper

	LinearEnvelope = Y
End Function


'******************************************************
'  FLIPPER TRICKS 
'******************************************************

RightFlipper.timerinterval=1
RightFlipper.timerenabled=True

sub RightFlipper_timer()
	FlipperTricks LeftFlipper, LFPress, LFCount, LFEndAngle, LFState
	FlipperTricks RightFlipper, RFPress, RFCount, RFEndAngle, RFState
	FlipperNudge RightFlipper, RFEndAngle, RFEOSNudge, LeftFlipper, LFEndAngle
	FlipperNudge LeftFlipper, LFEndAngle, LFEOSNudge,  RightFlipper, RFEndAngle
end sub

Dim LFEOSNudge, RFEOSNudge

Sub FlipperNudge(Flipper1, Endangle1, EOSNudge1, Flipper2, EndAngle2)
	Dim b, gBOT
	gBOT = GetBalls

	If Flipper1.currentangle = Endangle1 and EOSNudge1 <> 1 Then
		EOSNudge1 = 1
		'debug.print Flipper1.currentangle &" = "& Endangle1 &"--"& Flipper2.currentangle &" = "& EndAngle2
		If Flipper2.currentangle = EndAngle2 Then 
			For b = 0 to Ubound(gBOT)
				If FlipperTrigger(gBOT(b).x, gBOT(b).y, Flipper1) Then
					'Debug.Print "ball in flip1. exit"
					exit Sub
				end If
			Next
			For b = 0 to Ubound(gBOT)
				If FlipperTrigger(gBOT(b).x, gBOT(b).y, Flipper2) Then
					gBOT(b).velx = gBOT(b).velx / 1.3
					gBOT(b).vely = gBOT(b).vely - 0.5
'					Debug.Print "nudge"
				end If
			Next
		End If
	Else 
		If Abs(Flipper1.currentangle) > Abs(EndAngle1) + 30 then EOSNudge1 = 0
	End If
End Sub

'*****************
' Maths
'*****************
Dim PI: PI = 4*Atn(1)

Function dSin(degrees)
	dsin = sin(degrees * Pi/180)
End Function

Function dCos(degrees)
	dcos = cos(degrees * Pi/180)
End Function

Function Atn2(dy, dx)
	If dx > 0 Then
		Atn2 = Atn(dy / dx)
	ElseIf dx < 0 Then
		If dy = 0 Then 
			Atn2 = pi
		Else
			Atn2 = Sgn(dy) * (pi - Atn(Abs(dy / dx)))
		end if
	ElseIf dx = 0 Then
		if dy = 0 Then
			Atn2 = 0
		else
			Atn2 = Sgn(dy) * pi / 2
		end if
	End If
End Function

'*************************************************
'  Check ball distance from Flipper for Rem
'*************************************************

Function Distance(ax,ay,bx,by)
	Distance = SQR((ax - bx)^2 + (ay - by)^2)
End Function

Function DistancePL(px,py,ax,ay,bx,by) ' Distance between a point and a line where point is px,py
	DistancePL = ABS((by - ay)*px - (bx - ax) * py + bx*ay - by*ax)/Distance(ax,ay,bx,by)
End Function

Function Radians(Degrees)
	Radians = Degrees * PI /180
End Function

Function AnglePP(ax,ay,bx,by)
	AnglePP = Atn2((by - ay),(bx - ax))*180/PI
End Function

Function DistanceFromFlipper(ballx, bally, Flipper)
	DistanceFromFlipper = DistancePL(ballx, bally, Flipper.x, Flipper.y, Cos(Radians(Flipper.currentangle+90))+Flipper.x, Sin(Radians(Flipper.currentangle+90))+Flipper.y)
End Function

Function FlipperTrigger(ballx, bally, Flipper)
	Dim DiffAngle
	DiffAngle  = ABS(Flipper.currentangle - AnglePP(Flipper.x, Flipper.y, ballx, bally) - 90)
	If DiffAngle > 180 Then DiffAngle = DiffAngle - 360

	If DistanceFromFlipper(ballx,bally,Flipper) < 48 and DiffAngle <= 90 and Distance(ballx,bally,Flipper.x,Flipper.y) < Flipper.Length Then
		FlipperTrigger = True
	Else
		FlipperTrigger = False
	End If        
End Function


'*************************************************
'  End - Check ball distance from Flipper for Rem
'*************************************************

dim LFPress, RFPress, LFCount, RFCount
dim LFState, RFState
dim EOST, EOSA,Frampup, FElasticity,FReturn
dim RFEndAngle, LFEndAngle

Const FlipperCoilRampupMode = 0   	'0 = fast, 1 = medium, 2 = slow (tap passes should work)

LFState = 1
RFState = 1
EOST = leftflipper.eostorque
EOSA = leftflipper.eostorqueangle
Frampup = LeftFlipper.rampup
FElasticity = LeftFlipper.elasticity
FReturn = LeftFlipper.return
'Const EOSTnew = 1 'EM's to late 80's
Const EOSTnew = 0.8 '90's and later
Const EOSAnew = 1
Const EOSRampup = 0
Dim SOSRampup
Select Case FlipperCoilRampupMode 
	Case 0:
		SOSRampup = 2
	Case 1:
		SOSRampup = 6
	Case 2:
		SOSRampup = 8.5
End Select

Const LiveCatch = 16
Const LiveElasticity = 0.45
Const SOSEM = 0.815
'Const EOSReturn = 0.055  'EM's
'Const EOSReturn = 0.045  'late 70's to mid 80's
'Const EOSReturn = 0.035  'mid 80's to early 90's
Const EOSReturn = 0.025  'mid 90's and later

LFEndAngle = Leftflipper.endangle
RFEndAngle = RightFlipper.endangle

Sub FlipperActivate(Flipper, FlipperPress)
	FlipperPress = 1
	Flipper.Elasticity = FElasticity

	Flipper.eostorque = EOST         
	Flipper.eostorqueangle = EOSA         
End Sub

Sub FlipperDeactivate(Flipper, FlipperPress)
	FlipperPress = 0
	Flipper.eostorqueangle = EOSA
	Flipper.eostorque = EOST*EOSReturn/FReturn


	If Abs(Flipper.currentangle) <= Abs(Flipper.endangle) + 0.1 Then
		
		Dim b, gBOT
		gBOT = GetBalls

		For b = 0 to UBound(gBOT)
			If Distance(gBOT(b).x, gBOT(b).y, Flipper.x, Flipper.y) < 55 Then 'check for cradle
				If gBOT(b).vely >= -0.4 Then gBOT(b).vely = -0.4
			End If
		Next
	End If
End Sub

Sub FlipperTricks (Flipper, FlipperPress, FCount, FEndAngle, FState) 
	Dim Dir
	Dir = Flipper.startangle/Abs(Flipper.startangle)        '-1 for Right Flipper

	If Abs(Flipper.currentangle) > Abs(Flipper.startangle) - 0.05 Then
		If FState <> 1 Then
			Flipper.rampup = SOSRampup 
			Flipper.endangle = FEndAngle - 3*Dir
			Flipper.Elasticity = FElasticity * SOSEM
			FCount = 0 
			FState = 1
		End If
	ElseIf Abs(Flipper.currentangle) <= Abs(Flipper.endangle) and FlipperPress = 1 then
		if FCount = 0 Then FCount = GameTime

		If FState <> 2 Then
			Flipper.eostorqueangle = EOSAnew
			Flipper.eostorque = EOSTnew
			Flipper.rampup = EOSRampup                        
			Flipper.endangle = FEndAngle
			FState = 2
		End If
	Elseif Abs(Flipper.currentangle) > Abs(Flipper.endangle) + 0.01 and FlipperPress = 1 Then 
		If FState <> 3 Then
			Flipper.eostorque = EOST        
			Flipper.eostorqueangle = EOSA
			Flipper.rampup = Frampup
			Flipper.Elasticity = FElasticity
			FState = 3
		End If

	End If
End Sub

Const LiveDistanceMin = 30  'minimum distance in vp units from flipper base live catch dampening will occur
Const LiveDistanceMax = 114  'maximum distance in vp units from flipper base live catch dampening will occur (tip protection)

Sub CheckLiveCatch(ball, Flipper, FCount, parm) 'Experimental new live catch
	Dim Dir
	Dir = Flipper.startangle/Abs(Flipper.startangle)    '-1 for Right Flipper
	Dim LiveCatchBounce                                                                                                                        'If live catch is not perfect, it won't freeze ball totally
	Dim CatchTime : CatchTime = GameTime - FCount

	if CatchTime <= LiveCatch and parm > 6 and ABS(Flipper.x - ball.x) > LiveDistanceMin and ABS(Flipper.x - ball.x) < LiveDistanceMax Then
		if CatchTime <= LiveCatch*0.5 Then                                                'Perfect catch only when catch time happens in the beginning of the window
			LiveCatchBounce = 0
		else
			LiveCatchBounce = Abs((LiveCatch/2) - CatchTime)        'Partial catch when catch happens a bit late
		end If

		If LiveCatchBounce = 0 and ball.velx * Dir > 0 Then ball.velx = 0
		ball.vely = LiveCatchBounce * (32 / LiveCatch) ' Multiplier for inaccuracy bounce
		ball.angmomx= 0
		ball.angmomy= 0
		ball.angmomz= 0
    Else
        If Abs(Flipper.currentangle) <= Abs(Flipper.endangle) + 1 Then FlippersD.Dampenf Activeball, parm
	End If
End Sub


'******************************************************
'****  END FLIPPER CORRECTIONS
'******************************************************


'******************************************************
'****  PHYSICS DAMPENERS
'******************************************************
'
' These are data mined bounce curves, 
' dialed in with the in-game elasticity as much as possible to prevent angle / spin issues.
' Requires tracking ballspeed to calculate COR


Sub dPosts_Hit(idx) 
	RubbersD.dampen Activeball
	TargetBouncer Activeball, 1
End Sub

Sub dSleeves_Hit(idx) 
	SleevesD.Dampen Activeball
	TargetBouncer Activeball, 0.7
End Sub


dim RubbersD : Set RubbersD = new Dampener        'frubber
RubbersD.name = "Rubbers"
RubbersD.debugOn = False        'shows info in textbox "TBPout"
RubbersD.Print = False        'debug, reports in debugger (in vel, out cor)
'cor bounce curve (linear)
'for best results, try to match in-game velocity as closely as possible to the desired curve
'RubbersD.addpoint 0, 0, 0.935        'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 0, 0, 1.1        'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 1, 3.77, 0.97
RubbersD.addpoint 2, 5.76, 0.967        'dont take this as gospel. if you can data mine rubber elasticitiy, please help!
RubbersD.addpoint 3, 15.84, 0.874
RubbersD.addpoint 4, 56, 0.64        'there's clamping so interpolate up to 56 at least

dim SleevesD : Set SleevesD = new Dampener        'this is just rubber but cut down to 85%...
SleevesD.name = "Sleeves"
SleevesD.debugOn = False        'shows info in textbox "TBPout"
SleevesD.Print = False        'debug, reports in debugger (in vel, out cor)
SleevesD.CopyCoef RubbersD, 0.85

'######################### Add new FlippersD Profile
'#########################    Adjust these values to increase or lessen the elasticity

dim FlippersD : Set FlippersD = new Dampener
FlippersD.name = "Flippers"
FlippersD.debugOn = False
FlippersD.Print = False	
FlippersD.addpoint 0, 0, 1.1	
FlippersD.addpoint 1, 3.77, 0.99
FlippersD.addpoint 2, 6, 0.99

Class Dampener
	Public Print, debugOn 'tbpOut.text
	public name, Threshold         'Minimum threshold. Useful for Flippers, which don't have a hit threshold.
	Public ModIn, ModOut
	Private Sub Class_Initialize : redim ModIn(0) : redim Modout(0): End Sub 

	Public Sub AddPoint(aIdx, aX, aY) 
		ShuffleArrays ModIn, ModOut, 1 : ModIn(aIDX) = aX : ModOut(aIDX) = aY : ShuffleArrays ModIn, ModOut, 0
		if gametime > 100 then Report
	End Sub

	public sub Dampen(aBall)
		if threshold then if BallSpeed(aBall) < threshold then exit sub end if end if
		dim RealCOR, DesiredCOR, str, coef
		DesiredCor = LinearEnvelope(cor.ballvel(aBall.id), ModIn, ModOut )
		RealCOR = BallSpeed(aBall) / (cor.ballvel(aBall.id)+0.0001)
		coef = desiredcor / realcor 
		if debugOn then str = name & " in vel:" & round(cor.ballvel(aBall.id),2 ) & vbnewline & "desired cor: " & round(desiredcor,4) & vbnewline & _
		"actual cor: " & round(realCOR,4) & vbnewline & "ballspeed coef: " & round(coef, 3) & vbnewline 
		if Print then debug.print Round(cor.ballvel(aBall.id),2) & ", " & round(desiredcor,3)

		aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef
		if debugOn then TBPout.text = str
	End Sub

	public sub Dampenf(aBall, parm) 'Rubberizer is handle here
		dim RealCOR, DesiredCOR, str, coef
		DesiredCor = LinearEnvelope(cor.ballvel(aBall.id), ModIn, ModOut )
		RealCOR = BallSpeed(aBall) / (cor.ballvel(aBall.id)+0.0001)
		coef = desiredcor / realcor 
		If abs(aball.velx) < 2 and aball.vely < 0 and aball.vely > -3.75 then 
			aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef
		End If
	End Sub

	Public Sub CopyCoef(aObj, aCoef) 'alternative addpoints, copy with coef
		dim x : for x = 0 to uBound(aObj.ModIn)
			addpoint x, aObj.ModIn(x), aObj.ModOut(x)*aCoef
		Next
	End Sub


	Public Sub Report()         'debug, reports all coords in tbPL.text
		if not debugOn then exit sub
		dim a1, a2 : a1 = ModIn : a2 = ModOut
		dim str, x : for x = 0 to uBound(a1) : str = str & x & ": " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
		TBPout.text = str
	End Sub

End Class



'******************************************************
'  TRACK ALL BALL VELOCITIES
'  FOR RUBBER DAMPENER AND DROP TARGETS
'******************************************************

dim cor : set cor = New CoRTracker

Class CoRTracker
	public ballvel, ballvelx, ballvely

	Private Sub Class_Initialize : redim ballvel(0) : redim ballvelx(0): redim ballvely(0) : End Sub 

	Public Sub Update()	'tracks in-ball-velocity
		dim str, b, AllBalls, highestID : allBalls = getballs

		for each b in allballs
			if b.id >= HighestID then highestID = b.id
		Next

		if uBound(ballvel) < highestID then redim ballvel(highestID)	'set bounds
		if uBound(ballvelx) < highestID then redim ballvelx(highestID)	'set bounds
		if uBound(ballvely) < highestID then redim ballvely(highestID)	'set bounds

		for each b in allballs
			ballvel(b.id) = BallSpeed(b)
			ballvelx(b.id) = b.velx
			ballvely(b.id) = b.vely
		Next
	End Sub
End Class

' Note, cor.update must be called in a 10 ms timer. The example table uses the GameTimer for this purpose, but sometimes a dedicated timer call RDampen is used.
'
'Sub RDampen_Timer
'	Cor.Update
'End Sub



'******************************************************
'****  END PHYSICS DAMPENERS
'******************************************************

'***************************************************************
'             Supporting Ball & Sound Functions v3.0
'  includes random pitch in PlaySoundAt and PlaySoundAtBall
'***************************************************************

Dim TableWidth, TableHeight

TableWidth = Table1.width
TableHeight = Table1.height

Function Pan(ball) ' Calculates the pan for a ball based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = ball.x * 2 / TableWidth-1
    If tmp > 0 Then
        Pan = Csng(tmp ^10)
    Else
        Pan = Csng(-((- tmp) ^10))
    End If
End Function

Function RndNbr(n) 'returns a random number between 1 and n
    Randomize timer
    RndNbr = Int((n * Rnd) + 1)
End Function

'***********************************************
'   JP's VP10 Rolling Sounds + Ballshadow v3.0
'   uses a collection of shadows, aBallShadow
'***********************************************

Const tnob = 19   'total number of balls, 20 balls, from 0 to 19
Const lob = 2     'number of locked balls
'Const maxvel = 40 'max ball velocity
Dim DropCount
ReDim DropCount(tnob)
ReDim rolling(tnob)
Dim aBallGlowing:aBallGlowing = False
Dim aBallWhiteGlowing:aBallWhiteGlowing = False
InitRolling

Sub InitRolling
    Dim i
    For i = 0 to tnob
        rolling(i) = False
    Next
End Sub

Sub RollingUpdate()
    Dim BOT, b
    BOT = GetBalls

    ' stop the sound of deleted balls and hide the shadow
    For b = UBound(BOT) + 1 to tnob
        rolling(b) = False
		StopSound("BallRoll_" & b)
        aBallShadow(b).Y = 2060 'hide it under the apron
        aBallGlow(b).Visible = 0
        aBallGlow2(b).Visible = 0
    Next

    ' exit the sub if no balls on the table
    If UBound(BOT) = lob - 2 Then Exit Sub 'there no extra balls on this table

    ' play the rolling sound for each ball and draw the shadow
    For b = lob to UBound(BOT)
        aBallShadow(b).X = BOT(b).X
        aBallShadow(b).Y = BOT(b).Y
        aBallShadow(b).Height = BOT(b).Z -24

        If aBallGlowing Then
            aBallGlow(b).Visible = 1
            aBallGlow(b).X = BOT(b).X
            aBallGlow(b).Y = BOT(b).Y + 10
            aBallGlow(b).Height = BOT(b).Z + 32
        End If

        If aBallWhiteGlowing Then
            aBallGlow2(b).Visible = 1
            aBallGlow2(b).X = BOT(b).X
            aBallGlow2(b).Y = BOT(b).Y + 10
            aBallGlow2(b).Height = BOT(b).Z + 32
        End If

		If BallVel(BOT(b)) > 1 AND BOT(b).z < 30 Then
			rolling(b) = True
			PlaySound ("BallRoll_" & b), -1, VolPlayfieldRoll(BOT(b)) * BallRollVolume * VolumeDial, AudioPan(BOT(b)), 0, PitchPlayfieldRoll(BOT(b)), 1, 0, AudioFade(BOT(b))

		Else
			If rolling(b) = True Then
				StopSound("BallRoll_" & b)
				rolling(b) = False
			End If
		End If

        ' rothbauerw's Dropping Sounds
		If BOT(b).VelZ < -1 and BOT(b).z < 55 and BOT(b).z > 27 Then 'height adjust for ball drop sounds
			If DropCount(b) >= 5 Then
				DropCount(b) = 0
				If BOT(b).velz > -7 Then
					RandomSoundBallBouncePlayfieldSoft BOT(b)
				Else
					RandomSoundBallBouncePlayfieldHard BOT(b)
				End If				
			End If
		End If
		If DropCount(b) < 5 Then
			DropCount(b) = DropCount(b) + 1
		End If

        ' jps ball speed control
'        If BOT(b).VelX AND BOT(b).VelY <> 0 Then
'            speedfactorx = ABS(maxvel / BOT(b).VelX)
'            speedfactory = ABS(maxvel / BOT(b).VelY)
'            If speedfactorx < 1 Then
'                BOT(b).VelX = BOT(b).VelX * speedfactorx
'                BOT(b).VelY = BOT(b).VelY * speedfactorx
'            End If
'            If speedfactory < 1 Then
'                BOT(b).VelX = BOT(b).VelX * speedfactory
'                BOT(b).VelY = BOT(b).VelY * speedfactory
'            End If
'        End If
    Next
End Sub

'******************************************************
'**** RAMP ROLLING SFX
'******************************************************

'Ball tracking ramp SFX 1.0
'   Reqirements:
'          * Import A Sound File for each ball on the table for plastic ramps.  Call It RampLoop<Ball_Number> ex: RampLoop1, RampLoop2, ...
'          * Import a Sound File for each ball on the table for wire ramps. Call it WireLoop<Ball_Number> ex: WireLoop1, WireLoop2, ...
'          * Create a Timer called RampRoll, that is enabled, with a interval of 100
'          * Set RampBAlls and RampType variable to Total Number of Balls
'	Usage:
'          * Setup hit events and call WireRampOn True or WireRampOn False (True = Plastic ramp, False = Wire Ramp)
'          * To stop tracking ball
'                 * call WireRampOff
'                 * Otherwise, the ball will auto remove if it's below 30 vp units
'

'*******************************************
'  Ramp Triggers
'*******************************************

	' *** Left Ramp ***
'Only enabled when MetalRamp_invisible is

Sub RampTrigger001_hit()
	If activeball.vely < 0 Then
		WireRampOn True 'Play Plastic Ramp Sound
	Else
		WireRampOff 'bricked
	End If
End Sub

'WireRampOff at Tlock, WireRampOn True on kick

Sub RampTrigger002_hit()
	WireRampOff ' Turn off the Plastic Ramp Sound
End Sub

Sub RampTrigger002_unhit()
	PlaySoundAt "WireRamp_Stop", RampTrigger002
End Sub

	' *** IT Ramp ***

Sub RampTrigger003_hit()
	If activeball.velx < 0 Then
		WireRampOn True 'Play Plastic Ramp Sound
	Else
		WireRampOff 'bricked
	End If
End Sub

'WireRampOff Trigger014_hit, WireRampOn False on _unhit

Sub RampTrigger004_hit()
	WireRampOff ' Exiting Wire Ramp Stop Playing Sound
End Sub

	' *** Vuk Ramp ***

'WireRampOn False on Trigger015_Hit

Sub RampTrigger005_hit()
	WireRampOff
End Sub

Sub RampTrigger005_unhit()
	PlaySoundAt "WireRamp_Stop", RampTrigger005
End Sub

	' *** u-turn ***

'WireRampOn False at Trigger012

'Ends at RampTrigger005
'*******************************************


dim RampMinLoops : RampMinLoops = 4

' RampBalls
'      Setup:        Set the array length of x in RampBalls(x,2) Total Number of Balls on table + 1:  if tnob = 5, then RammBalls(6,2)
'      Description:  
dim RampBalls(6,2)
'x,0 = ball x,1 = ID,	2 = Protection against ending early (minimum amount of updates)
'0,0 is boolean on/off, 0,1 unused for now
RampBalls(0,0) = False

' RampType
'     Setup: Set this array to the number Total number of balls that can be tracked at one time + 1.  5 ball multiball then set value to 6
'     Description: Array type indexed on BallId and a values used to deterimine what type of ramp the ball is on: False = Wire Ramp, True = Plastic Ramp
dim RampType(6)	

Sub WireRampOn(input)  : Waddball ActiveBall, input : RampRollUpdate: End Sub
Sub WireRampOff() : WRemoveBall ActiveBall.ID	: End Sub


' WaddBall (Active Ball, Boolean)
'     Description: This subroutine is called from WireRampOn to Add Balls to the RampBalls Array
Sub Waddball(input, RampInput)	'Add ball
	' This will loop through the RampBalls array checking each element of the array x, position 1
	' To see if the the ball was already added to the array.
	' If the ball is found then exit the subroutine
	dim x : for x = 1 to uBound(RampBalls)	'Check, don't add balls twice
		if RampBalls(x, 1) = input.id then 
			if Not IsEmpty(RampBalls(x,1) ) then Exit Sub	'Frustating issue with BallId 0. Empty variable = 0
		End If
	Next

	' This will itterate through the RampBalls Array.
	' The first time it comes to a element in the array where the Ball Id (Slot 1) is empty.  It will add the current ball to the array
	' The RampBalls assigns the ActiveBall to element x,0 and ball id of ActiveBall to 0,1
	' The RampType(BallId) is set to RampInput
	' RampBalls in 0,0 is set to True, this will enable the timer and the timer is also turned on
	For x = 1 to uBound(RampBalls)
		if IsEmpty(RampBalls(x, 1)) then 
			Set RampBalls(x, 0) = input
			RampBalls(x, 1)	= input.ID
			RampType(x) = RampInput
			RampBalls(x, 2)	= 0
			'exit For
			RampBalls(0,0) = True
			RampRoll.Enabled = 1	 'Turn on timer
			'RampRoll.Interval = RampRoll.Interval 'reset timer
			exit Sub
		End If
		if x = uBound(RampBalls) then 	'debug
			Debug.print "WireRampOn error, ball queue is full: " & vbnewline & _
			RampBalls(0, 0) & vbnewline & _
			Typename(RampBalls(1, 0)) & " ID:" & RampBalls(1, 1) & "type:" & RampType(1) & vbnewline & _
			Typename(RampBalls(2, 0)) & " ID:" & RampBalls(2, 1) & "type:" & RampType(2) & vbnewline & _
			Typename(RampBalls(3, 0)) & " ID:" & RampBalls(3, 1) & "type:" & RampType(3) & vbnewline & _
			Typename(RampBalls(4, 0)) & " ID:" & RampBalls(4, 1) & "type:" & RampType(4) & vbnewline & _
			Typename(RampBalls(5, 0)) & " ID:" & RampBalls(5, 1) & "type:" & RampType(5) & vbnewline & _
			" "
		End If
	next
End Sub

' WRemoveBall (BallId)
'    Description: This subroutine is called from the RampRollUpdate subroutine 
'                 and is used to remove and stop the ball rolling sounds
Sub WRemoveBall(ID)		'Remove ball
	'Debug.Print "In WRemoveBall() + Remove ball from loop array"
	dim ballcount : ballcount = 0
	dim x : for x = 1 to Ubound(RampBalls)
		if ID = RampBalls(x, 1) then 'remove ball
			Set RampBalls(x, 0) = Nothing
			RampBalls(x, 1) = Empty
			RampType(x) = Empty
			StopSound("RampLoop" & x)
			StopSound("wireloop" & x)
		end If
		'if RampBalls(x,1) = Not IsEmpty(Rampballs(x,1) then ballcount = ballcount + 1
		if not IsEmpty(Rampballs(x,1)) then ballcount = ballcount + 1
	next
	if BallCount = 0 then RampBalls(0,0) = False	'if no balls in queue, disable timer update
End Sub

Sub RampRoll_Timer():RampRollUpdate:End Sub

Sub RampRollUpdate()		'Timer update
	dim x : for x = 1 to uBound(RampBalls)
		if Not IsEmpty(RampBalls(x,1) ) then 
			if BallVel(RampBalls(x,0) ) > 1 then ' if ball is moving, play rolling sound
				If RampType(x) then 
					PlaySound("RampLoop" & x), -1, VolPlayfieldRoll(RampBalls(x,0)) * RampRollVolume * VolumeDial, AudioPan(RampBalls(x,0)), 0, BallPitchV(RampBalls(x,0)), 1, 0, AudioFade(RampBalls(x,0))				
					StopSound("wireloop" & x)
				Else
					StopSound("RampLoop" & x)
					PlaySound("wireloop" & x), -1, VolPlayfieldRoll(RampBalls(x,0)) * RampRollVolume * VolumeDial, AudioPan(RampBalls(x,0)), 0, BallPitch(RampBalls(x,0)), 1, 0, AudioFade(RampBalls(x,0))
				End If
				RampBalls(x, 2)	= RampBalls(x, 2) + 1
			Else
				StopSound("RampLoop" & x)
				StopSound("wireloop" & x)
			end if
			if RampBalls(x,0).Z < 30 and RampBalls(x, 2) > RampMinLoops then	'if ball is on the PF, remove  it
				StopSound("RampLoop" & x)
				StopSound("wireloop" & x)
				Wremoveball RampBalls(x,1)
			End If
		Else
			StopSound("RampLoop" & x)
			StopSound("wireloop" & x)
		end if
	next
	if not RampBalls(0,0) then RampRoll.enabled = 0

End Sub

' This can be used to debug the Ramp Roll time.  You need to enable the tbWR timer on the TextBox
Sub tbWR_Timer()	'debug textbox
	me.text =	"on? " & RampBalls(0, 0) & " timer: " & RampRoll.Enabled & vbnewline & _
	"1 " & Typename(RampBalls(1, 0)) & " ID:" & RampBalls(1, 1) & " type:" & RampType(1) & " Loops:" & RampBalls(1, 2) & vbnewline & _
	"2 " & Typename(RampBalls(2, 0)) & " ID:" & RampBalls(2, 1) & " type:" & RampType(2) & " Loops:" & RampBalls(2, 2) & vbnewline & _
	"3 " & Typename(RampBalls(3, 0)) & " ID:" & RampBalls(3, 1) & " type:" & RampType(3) & " Loops:" & RampBalls(3, 2) & vbnewline & _
	"4 " & Typename(RampBalls(4, 0)) & " ID:" & RampBalls(4, 1) & " type:" & RampType(4) & " Loops:" & RampBalls(4, 2) & vbnewline & _
	"5 " & Typename(RampBalls(5, 0)) & " ID:" & RampBalls(5, 1) & " type:" & RampType(5) & " Loops:" & RampBalls(5, 2) & vbnewline & _
	"6 " & Typename(RampBalls(6, 0)) & " ID:" & RampBalls(6, 1) & " type:" & RampType(6) & " Loops:" & RampBalls(6, 2) & vbnewline & _
	" "
End Sub


Function BallPitch(ball) ' Calculates the pitch of the sound based on the ball speed
    BallPitch = pSlope(BallVel(ball), 1, -1000, 60, 10000)
End Function

Function BallPitchV(ball) ' Calculates the pitch of the sound based on the ball speed Variation
	BallPitchV = pSlope(BallVel(ball), 1, -4000, 60, 7000)
End Function

'******************************************************
'**** END RAMP ROLLING SFX
'******************************************************


'******************************************************
'****  FLEEP MECHANICAL SOUNDS
'******************************************************

' This part in the script is an entire block that is dedicated to the physics sound system.
' Various scripts and sounds that may be pretty generic and could suit other WPC systems, but the most are tailored specifically for the TOM table

' Many of the sounds in this package can be added by creating collections and adding the appropriate objects to those collections.  
' Create the following new collections:
' 	Metals (all metal objects, metal walls, metal posts, metal wire guides)
' 	Apron (the apron walls and plunger wall)
' 	Walls (all wood or plastic walls)
' 	Rollovers (wire rollover triggers, star triggers, or button triggers)
' 	Targets (standup or drop targets, these are hit sounds only ... you will want to add separate dropping sounds for drop targets)
' 	Gates (plate gates)
' 	GatesWire (wire gates)
' 	Rubbers (all rubbers including posts, sleeves, pegs, and bands)
' When creating the collections, make sure "Fire events for this collection" is checked.  
' You'll also need to make sure "Has Hit Event" is checked for each object placed in these collections (not necessary for gates and triggers).  
' Once the collections and objects are added, the save, close, and restart VPX.
'
' Many places in the script need to be modified to include the correct sound effect subroutine calls. The tutorial videos linked below demonstrate 
' how to make these updates. But in summary the following needs to be updated:	
'	- Nudging, plunger, coin-in, start button sounds will be added to the keydown and keyup subs.
'	- Flipper sounds in the flipper solenoid subs. Flipper collision sounds in the flipper collide subs.
'	- Bumpers, slingshots, drain, ball release, knocker, spinner, and saucers in their respective subs
'	- Ball rolling sounds sub
'
' Tutorial vides by Apophis
' Part 1: 	https://youtu.be/PbE2kNiam3g
' Part 2: 	https://youtu.be/B5cm1Y8wQsk
' Part 3: 	https://youtu.be/eLhWyuYOyGg


'///////////////////////////////  SOUNDS PARAMETERS  //////////////////////////////
Dim GlobalSoundLevel, CoinSoundLevel, PlungerReleaseSoundLevel, PlungerPullSoundLevel, NudgeLeftSoundLevel
Dim NudgeRightSoundLevel, NudgeCenterSoundLevel, StartButtonSoundLevel, RollingSoundFactor

CoinSoundLevel = 1														'volume level; range [0, 1]
NudgeLeftSoundLevel = 1													'volume level; range [0, 1]
NudgeRightSoundLevel = 1												'volume level; range [0, 1]
NudgeCenterSoundLevel = 1												'volume level; range [0, 1]
StartButtonSoundLevel = 0.1												'volume level; range [0, 1]
PlungerReleaseSoundLevel = 0.8 '1 wjr											'volume level; range [0, 1]
PlungerPullSoundLevel = 1												'volume level; range [0, 1]
RollingSoundFactor = 1.1/5		

'///////////////////////-----Solenoids, Kickers and Flash Relays-----///////////////////////
Dim FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel, FlipperUpAttackLeftSoundLevel, FlipperUpAttackRightSoundLevel, FlipperUpAttackRight2SoundLevel
Dim FlipperUpSoundLevel, FlipperDownSoundLevel, FlipperLeftHitParm, FlipperRightHitParm, FlipperRight2HitParm
Dim SlingshotSoundLevel, BumperSoundFactor, KnockerSoundLevel

FlipperUpAttackMinimumSoundLevel = 0.010           						'volume level; range [0, 1]
FlipperUpAttackMaximumSoundLevel = 0.635								'volume level; range [0, 1]
FlipperUpSoundLevel = 1.0                        						'volume level; range [0, 1]
FlipperDownSoundLevel = 0.45                      						'volume level; range [0, 1]
FlipperLeftHitParm = FlipperUpSoundLevel								'sound helper; not configurable
FlipperRightHitParm = FlipperUpSoundLevel								'sound helper; not configurable
FlipperRight2HitParm = FlipperUpSoundLevel								'sound helper; not configurable
SlingshotSoundLevel = 0.95												'volume level; range [0, 1]
BumperSoundFactor = 4.25												'volume multiplier; must not be zero
KnockerSoundLevel = 1 													'volume level; range [0, 1]

'///////////////////////-----Ball Drops, Bumps and Collisions-----///////////////////////
Dim RubberStrongSoundFactor, RubberWeakSoundFactor, RubberFlipperSoundFactor,BallWithBallCollisionSoundFactor
Dim BallBouncePlayfieldSoftFactor, BallBouncePlayfieldHardFactor, PlasticRampDropToPlayfieldSoundLevel, WireRampDropToPlayfieldSoundLevel, DelayedBallDropOnPlayfieldSoundLevel
Dim WallImpactSoundFactor, MetalImpactSoundFactor, SubwaySoundLevel, SubwayEntrySoundLevel, ScoopEntrySoundLevel
Dim SaucerLockSoundLevel, SaucerKickSoundLevel

BallWithBallCollisionSoundFactor = 3.2									'volume multiplier; must not be zero
RubberStrongSoundFactor = 0.055/5											'volume multiplier; must not be zero
RubberWeakSoundFactor = 0.075/5											'volume multiplier; must not be zero
RubberFlipperSoundFactor = 0.075/5										'volume multiplier; must not be zero
BallBouncePlayfieldSoftFactor = 0.025									'volume multiplier; must not be zero
BallBouncePlayfieldHardFactor = 0.025									'volume multiplier; must not be zero
DelayedBallDropOnPlayfieldSoundLevel = 0.8									'volume level; range [0, 1]
WallImpactSoundFactor = 0.075											'volume multiplier; must not be zero
MetalImpactSoundFactor = 0.075/3
SaucerLockSoundLevel = 0.8
SaucerKickSoundLevel = 0.8

'///////////////////////-----Gates, Spinners, Rollovers and Targets-----///////////////////////

Dim GateSoundLevel, TargetSoundFactor, SpinnerSoundLevel, RolloverSoundLevel, DTSoundLevel

GateSoundLevel = 0.5/5													'volume level; range [0, 1]
TargetSoundFactor = 0.0025 * 10											'volume multiplier; must not be zero
DTSoundLevel = 0.25														'volume multiplier; must not be zero
RolloverSoundLevel = 0.25                              					'volume level; range [0, 1]
SpinnerSoundLevel = 0.5                              					'volume level; range [0, 1]

'///////////////////////-----Ball Release, Guides and Drain-----///////////////////////
Dim DrainSoundLevel, BallReleaseSoundLevel, BottomArchBallGuideSoundFactor, FlipperBallGuideSoundFactor 

DrainSoundLevel = 0.8														'volume level; range [0, 1]
BallReleaseSoundLevel = 1												'volume level; range [0, 1]
BottomArchBallGuideSoundFactor = 0.2									'volume multiplier; must not be zero
FlipperBallGuideSoundFactor = 0.015										'volume multiplier; must not be zero

'///////////////////////-----Loops and Lanes-----///////////////////////
Dim ArchSoundFactor
ArchSoundFactor = 0.025/5													'volume multiplier; must not be zero


'/////////////////////////////  SOUND PLAYBACK FUNCTIONS  ////////////////////////////
'/////////////////////////////  POSITIONAL SOUND PLAYBACK METHODS  ////////////////////////////
' Positional sound playback methods will play a sound, depending on the X,Y position of the table element or depending on ActiveBall object position
' These are similar subroutines that are less complicated to use (e.g. simply use standard parameters for the PlaySound call)
' For surround setup - positional sound playback functions will fade between front and rear surround channels and pan between left and right channels
' For stereo setup - positional sound playback functions will only pan between left and right channels
' For mono setup - positional sound playback functions will not pan between left and right channels and will not fade between front and rear channels

' PlaySound full syntax - PlaySound(string, int loopcount, float volume, float pan, float randompitch, int pitch, bool useexisting, bool restart, float front_rear_fade)
' Note - These functions will not work (currently) for walls/slingshots as these do not feature a simple, single X,Y position
Sub PlaySoundAtLevelStatic(playsoundparams, aVol, tableobj)
	PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelExistingStatic(playsoundparams, aVol, tableobj)
	PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 1, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelStaticLoop(playsoundparams, aVol, tableobj)
	PlaySound playsoundparams, -1, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelStaticRandomPitch(playsoundparams, aVol, randomPitch, tableobj)
	PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), randomPitch, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelActiveBall(playsoundparams, aVol)
	PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ActiveBall), 0, 0, 0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtLevelExistingActiveBall(playsoundparams, aVol)
	PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ActiveBall), 0, 0, 1, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtLeveTimerActiveBall(playsoundparams, aVol, ballvariable)
	PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ballvariable), 0, 0, 0, 0, AudioFade(ballvariable)
End Sub

Sub PlaySoundAtLevelTimerExistingActiveBall(playsoundparams, aVol, ballvariable)
	PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ballvariable), 0, 0, 1, 0, AudioFade(ballvariable)
End Sub

Sub PlaySoundAtLevelRoll(playsoundparams, aVol, pitch)
	PlaySound playsoundparams, -1, aVol * VolumeDial, AudioPan(tableobj), randomPitch, 0, 0, 0, AudioFade(tableobj)
End Sub

' Previous Positional Sound Subs

Sub PlaySoundAt(soundname, tableobj)
	PlaySound soundname, 1, 1 * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

Sub PlaySoundAtVol(soundname, tableobj, aVol)
	PlaySound soundname, 1, aVol * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

Sub PlaySoundAtBall(soundname)
	PlaySoundAt soundname, ActiveBall
End Sub

Sub PlaySoundAtBallVol (Soundname, aVol)
	Playsound soundname, 1,aVol * VolumeDial, AudioPan(ActiveBall), 0,0,0, 1, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtBallVolM (Soundname, aVol)
	Playsound soundname, 1,aVol * VolumeDial, AudioPan(ActiveBall), 0,0,0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtVolLoops(sound, tableobj, Vol, Loops)
	PlaySound sound, Loops, Vol * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub


'******************************************************
'  Fleep  Supporting Ball & Sound Functions
'******************************************************

Function AudioFade(tableobj) ' Fades between front and back of the table (for surround systems or 2x2 speakers, etc), depending on the Y position on the table. "table1" is the name of the table
  Dim tmp
    tmp = tableobj.y * 2 / tableheight-1

	if tmp > 7000 Then
		tmp = 7000
	elseif tmp < -7000 Then
		tmp = -7000
	end if

    If tmp > 0 Then
		AudioFade = Csng(tmp ^10)
    Else
        AudioFade = Csng(-((- tmp) ^10) )
    End If
End Function

Function AudioPan(tableobj) ' Calculates the pan for a tableobj based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = tableobj.x * 2 / tablewidth-1

	if tmp > 7000 Then
		tmp = 7000
	elseif tmp < -7000 Then
		tmp = -7000
	end if

    If tmp > 0 Then
        AudioPan = Csng(tmp ^10)
    Else
        AudioPan = Csng(-((- tmp) ^10) )
    End If
End Function

Function Vol(ball) ' Calculates the volume of the sound based on the ball speed
	Vol = Csng(BallVel(ball) ^2)
End Function

Function Volz(ball) ' Calculates the volume of the sound based on the ball speed
	Volz = Csng((ball.velz) ^2)
End Function

Function Pitch(ball) ' Calculates the pitch of the sound based on the ball speed
	Pitch = BallVel(ball) * 20
End Function

Function BallVel(ball) 'Calculates the ball speed
	BallVel = INT(SQR((ball.VelX ^2) + (ball.VelY ^2) ) )
End Function

Function VolPlayfieldRoll(ball) ' Calculates the roll volume of the sound based on the ball speed
	VolPlayfieldRoll = RollingSoundFactor * 0.0005 * Csng(BallVel(ball) ^3)
End Function

Function PitchPlayfieldRoll(ball) ' Calculates the roll pitch of the sound based on the ball speed
	PitchPlayfieldRoll = BallVel(ball) ^2 * 15
End Function

Function RndInt(min, max)
	RndInt = Int(Rnd() * (max-min + 1) + min)' Sets a random number integer between min and max
End Function

Function RndNum(min, max)
	RndNum = Rnd() * (max-min) + min' Sets a random number between min and max
End Function

'/////////////////////////////  GENERAL SOUND SUBROUTINES  ////////////////////////////
Sub SoundStartButton()
	PlaySound ("Start_Button"), 0, StartButtonSoundLevel, 0, 0.25
End Sub

Sub SoundNudgeLeft()
	PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeLeftSoundLevel * VolumeDial, -0.1, 0.25
End Sub

Sub SoundNudgeRight()
	PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeRightSoundLevel * VolumeDial, 0.1, 0.25
End Sub

Sub SoundNudgeCenter()
	PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeCenterSoundLevel * VolumeDial, 0, 0.25
End Sub


Sub SoundPlungerPull()
	PlaySoundAtLevelStatic ("Plunger_Pull_1"), PlungerPullSoundLevel, Plunger
End Sub

Sub SoundPlungerReleaseBall()
	PlaySoundAtLevelStatic ("Plunger_Release_Ball"), PlungerReleaseSoundLevel, Plunger
	DOF 147, DOFpulse 'MX effect for plunger
End Sub

Sub SoundPlungerReleaseNoBall()
	PlaySoundAtLevelStatic ("Plunger_Release_No_Ball"), PlungerReleaseSoundLevel, Plunger
End Sub


'/////////////////////////////  KNOCKER SOLENOID  ////////////////////////////
Sub KnockerSolenoid()
	PlaySoundAtLevelStatic SoundFX("Knocker_1",DOFKnocker), KnockerSoundLevel, KnockerPosition
End Sub

'/////////////////////////////  DRAIN SOUNDS  ////////////////////////////
Sub RandomSoundDrain(drainswitch)
	PlaySoundAtLevelStatic ("Drain_" & Int(Rnd*11)+1), DrainSoundLevel, drainswitch
End Sub

'/////////////////////////////  TROUGH BALL RELEASE SOLENOID SOUNDS  ////////////////////////////

Sub RandomSoundBallRelease(drainswitch)
	PlaySoundAtLevelStatic SoundFX("BallRelease" & Int(Rnd*7)+1,DOFContactors), BallReleaseSoundLevel, drainswitch
End Sub

'/////////////////////////////  SLINGSHOT SOLENOID SOUNDS  ////////////////////////////
Sub RandomSoundSlingshotLeft(sling)
	PlaySoundAtLevelStatic SoundFX("Sling_L" & Int(Rnd*10)+1,DOFContactors), SlingshotSoundLevel, Sling
End Sub

Sub RandomSoundSlingshotRight(sling)
	PlaySoundAtLevelStatic SoundFX("Sling_R" & Int(Rnd*8)+1,DOFContactors), SlingshotSoundLevel, Sling
End Sub

'/////////////////////////////  BUMPER SOLENOID SOUNDS  ////////////////////////////
Sub RandomSoundBumperTop(Bump)
	PlaySoundAtLevelStatic SoundFX("Bumpers_Top_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

Sub RandomSoundBumperMiddle(Bump)
	PlaySoundAtLevelStatic SoundFX("Bumpers_Middle_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

Sub RandomSoundBumperBottom(Bump)
	PlaySoundAtLevelStatic SoundFX("Bumpers_Bottom_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

'/////////////////////////////  SPINNER SOUNDS  ////////////////////////////
Sub SoundSpinner(spinnerswitch)
	PlaySoundAtLevelStatic ("Spinner"), SpinnerSoundLevel, spinnerswitch
End Sub


'/////////////////////////////  FLIPPER BATS SOUND SUBROUTINES  ////////////////////////////
'/////////////////////////////  FLIPPER BATS SOLENOID ATTACK SOUND  ////////////////////////////
Sub SoundFlipperUpAttackLeft(flipper)
	FlipperUpAttackLeftSoundLevel = RndNum(FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel)
	PlaySoundAtLevelStatic SoundFX("Flipper_Attack-L01",DOFFlippers), FlipperUpAttackLeftSoundLevel, flipper
End Sub

Sub SoundFlipperUpAttackRight(flipper)
	FlipperUpAttackRightSoundLevel = RndNum(FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel)
	PlaySoundAtLevelStatic SoundFX("Flipper_Attack-R01",DOFFlippers), FlipperUpAttackLeftSoundLevel, flipper
End Sub

Sub SoundFlipperUpAttackRight2(flipper)
	FlipperUpAttackRight2SoundLevel = RndNum(FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel)
	PlaySoundAtLevelStatic SoundFX("Flipper_Attack-R01",DOFFlippers), FlipperUpAttackLeftSoundLevel, flipper
End Sub

'/////////////////////////////  FLIPPER BATS SOLENOID CORE SOUND  ////////////////////////////
Sub RandomSoundFlipperUpLeft(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_L0" & Int(Rnd*9)+1,DOFFlippers), FlipperLeftHitParm, Flipper
End Sub

Sub RandomSoundFlipperUpRight(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_R0" & Int(Rnd*9)+1,DOFFlippers), FlipperRightHitParm, Flipper
End Sub

Sub RandomSoundFlipperUpRight2(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_R0" & Int(Rnd*9)+1,DOFFlippers), FlipperRight2HitParm, Flipper
End Sub

Sub RandomSoundReflipUpLeft(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_ReFlip_L0" & Int(Rnd*3)+1,DOFFlippers), (RndNum(0.8, 1))*FlipperUpSoundLevel, Flipper
End Sub

Sub RandomSoundReflipUpRight(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_ReFlip_R0" & Int(Rnd*3)+1,DOFFlippers), (RndNum(0.8, 1))*FlipperUpSoundLevel, Flipper
End Sub

Sub RandomSoundReflipUpRight2(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_ReFlip_R0" & Int(Rnd*3)+1,DOFFlippers), (RndNum(0.8, 1))*FlipperUpSoundLevel, Flipper
End Sub

Sub RandomSoundFlipperDownLeft(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_Left_Down_" & Int(Rnd*7)+1,DOFFlippers), FlipperDownSoundLevel, Flipper
End Sub

Sub RandomSoundFlipperDownRight(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_Right_Down_" & Int(Rnd*8)+1,DOFFlippers), FlipperDownSoundLevel, Flipper
End Sub

Sub RandomSoundFlipperDownRight2(flipper)
	PlaySoundAtLevelStatic SoundFX("Flipper_Right_Down_" & Int(Rnd*8)+1,DOFFlippers), FlipperDownSoundLevel, Flipper
End Sub

'/////////////////////////////  FLIPPER BATS BALL COLLIDE SOUND  ////////////////////////////

Sub LeftFlipperCollide(parm)
	FlipperLeftHitParm = parm/10
	If FlipperLeftHitParm > 1 Then
		FlipperLeftHitParm = 1
	End If
	FlipperLeftHitParm = FlipperUpSoundLevel * FlipperLeftHitParm
	RandomSoundRubberFlipper(parm)
End Sub

Sub RightFlipperCollide(parm)
	FlipperRightHitParm = parm/10
	If FlipperRightHitParm > 1 Then
		FlipperRightHitParm = 1
	End If
	FlipperRightHitParm = FlipperUpSoundLevel * FlipperRightHitParm
	RandomSoundRubberFlipper(parm)
End Sub

Sub RightFlipper2Collide(parm)
	FlipperRight2HitParm = parm/10
	If FlipperRight2HitParm > 1 Then
		FlipperRight2HitParm = 1
	End If
	FlipperRight2HitParm = FlipperUpSoundLevel * FlipperRight2HitParm
	RandomSoundRubberFlipper(parm)
End Sub

Sub RandomSoundRubberFlipper(parm)
	PlaySoundAtLevelActiveBall ("Flipper_Rubber_" & Int(Rnd*7)+1), parm  * RubberFlipperSoundFactor
End Sub

'/////////////////////////////  ROLLOVER SOUNDS  ////////////////////////////
Sub RandomSoundRollover()
	PlaySoundAtLevelActiveBall ("Rollover_" & Int(Rnd*4)+1), RolloverSoundLevel
End Sub

Sub Rollovers_Hit(idx)
	RandomSoundRollover
End Sub

'/////////////////////////////  VARIOUS PLAYFIELD SOUND SUBROUTINES  ////////////////////////////
'/////////////////////////////  RUBBERS AND POSTS  ////////////////////////////
'/////////////////////////////  RUBBERS - EVENTS  ////////////////////////////
Sub Rubbers_Hit(idx)
	dim finalspeed
	finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
	If finalspeed > 5 then		
		RandomSoundRubberStrong 1
	End if
	If finalspeed <= 5 then
		RandomSoundRubberWeak()
	End If	
End Sub

'/////////////////////////////  RUBBERS AND POSTS - STRONG IMPACTS  ////////////////////////////
Sub RandomSoundRubberStrong(voladj)
	Select Case Int(Rnd*10)+1
		Case 1 : PlaySoundAtLevelActiveBall ("Rubber_Strong_1"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 2 : PlaySoundAtLevelActiveBall ("Rubber_Strong_2"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 3 : PlaySoundAtLevelActiveBall ("Rubber_Strong_3"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 4 : PlaySoundAtLevelActiveBall ("Rubber_Strong_4"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 5 : PlaySoundAtLevelActiveBall ("Rubber_Strong_5"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 6 : PlaySoundAtLevelActiveBall ("Rubber_Strong_6"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 7 : PlaySoundAtLevelActiveBall ("Rubber_Strong_7"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 8 : PlaySoundAtLevelActiveBall ("Rubber_Strong_8"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 9 : PlaySoundAtLevelActiveBall ("Rubber_Strong_9"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
		Case 10 : PlaySoundAtLevelActiveBall ("Rubber_1_Hard"), Vol(ActiveBall) * RubberStrongSoundFactor * 0.6*voladj
	End Select
End Sub

'/////////////////////////////  RUBBERS AND POSTS - WEAK IMPACTS  ////////////////////////////
Sub RandomSoundRubberWeak()
	PlaySoundAtLevelActiveBall ("Rubber_" & Int(Rnd*9)+1), Vol(ActiveBall) * RubberWeakSoundFactor
End Sub

'/////////////////////////////  WALL IMPACTS  ////////////////////////////
Sub Walls_Hit(idx)
	RandomSoundWall()      
End Sub

Sub RandomSoundWall()
	dim finalspeed
	finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
	If finalspeed > 16 then 
		Select Case Int(Rnd*5)+1
			Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_1"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_2"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_5"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 4 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_7"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 5 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_9"), Vol(ActiveBall) * WallImpactSoundFactor
		End Select
	End if
	If finalspeed >= 6 AND finalspeed <= 16 then
		Select Case Int(Rnd*4)+1
			Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_3"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_4"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_6"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 4 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_8"), Vol(ActiveBall) * WallImpactSoundFactor
		End Select
	End If
	If finalspeed < 6 Then
		Select Case Int(Rnd*3)+1
			Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_4"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_6"), Vol(ActiveBall) * WallImpactSoundFactor
			Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_8"), Vol(ActiveBall) * WallImpactSoundFactor
		End Select
	End if
End Sub

'/////////////////////////////  METAL TOUCH SOUNDS  ////////////////////////////
Sub RandomSoundMetal()
	PlaySoundAtLevelActiveBall ("Metal_Touch_" & Int(Rnd*13)+1), Vol(ActiveBall) * MetalImpactSoundFactor
End Sub

'/////////////////////////////  METAL - EVENTS  ////////////////////////////

Sub Metals_Hit (idx)
	RandomSoundMetal
End Sub

Sub ShooterDiverter_collide(idx)
	RandomSoundMetal
End Sub

'/////////////////////////////  BOTTOM ARCH BALL GUIDE  ////////////////////////////
'/////////////////////////////  BOTTOM ARCH BALL GUIDE - SOFT BOUNCES  ////////////////////////////
Sub RandomSoundBottomArchBallGuide()
	dim finalspeed
	finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
	If finalspeed > 16 then 
		PlaySoundAtLevelActiveBall ("Apron_Bounce_"& Int(Rnd*2)+1), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
	End if
	If finalspeed >= 6 AND finalspeed <= 16 then
		Select Case Int(Rnd*2)+1
			Case 1 : PlaySoundAtLevelActiveBall ("Apron_Bounce_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
			Case 2 : PlaySoundAtLevelActiveBall ("Apron_Bounce_Soft_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
		End Select
	End If
	If finalspeed < 6 Then
		Select Case Int(Rnd*2)+1
			Case 1 : PlaySoundAtLevelActiveBall ("Apron_Bounce_Soft_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
			Case 2 : PlaySoundAtLevelActiveBall ("Apron_Medium_3"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
		End Select
	End if
End Sub

'/////////////////////////////  BOTTOM ARCH BALL GUIDE - HARD HITS  ////////////////////////////
Sub RandomSoundBottomArchBallGuideHardHit()
	PlaySoundAtLevelActiveBall ("Apron_Hard_Hit_" & Int(Rnd*3)+1), BottomArchBallGuideSoundFactor * 0.25
End Sub

Sub Apron_Hit (idx)
	If Abs(cor.ballvelx(activeball.id) < 4) and cor.ballvely(activeball.id) > 7 then
		RandomSoundBottomArchBallGuideHardHit()
	Else
		RandomSoundBottomArchBallGuide
	End If
End Sub

'/////////////////////////////  FLIPPER BALL GUIDE  ////////////////////////////
Sub RandomSoundFlipperBallGuide()
	dim finalspeed
	finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
	If finalspeed > 16 then 
		Select Case Int(Rnd*2)+1
			Case 1 : PlaySoundAtLevelActiveBall ("Apron_Hard_1"),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
			Case 2 : PlaySoundAtLevelActiveBall ("Apron_Hard_2"),  Vol(ActiveBall) * 0.8 * FlipperBallGuideSoundFactor
		End Select
	End if
	If finalspeed >= 6 AND finalspeed <= 16 then
		PlaySoundAtLevelActiveBall ("Apron_Medium_" & Int(Rnd*3)+1),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
	End If
	If finalspeed < 6 Then
		PlaySoundAtLevelActiveBall ("Apron_Soft_" & Int(Rnd*7)+1),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
	End If
End Sub

'/////////////////////////////  TARGET HIT SOUNDS  ////////////////////////////
Sub RandomSoundTargetHitStrong()
	PlaySoundAtLevelActiveBall SoundFX("Target_Hit_" & Int(Rnd*4)+5,DOFTargets), Vol(ActiveBall) * 0.45 * TargetSoundFactor
End Sub

Sub RandomSoundTargetHitWeak()		
	PlaySoundAtLevelActiveBall SoundFX("Target_Hit_" & Int(Rnd*4)+1,DOFTargets), Vol(ActiveBall) * TargetSoundFactor
End Sub

Sub PlayTargetSound()
	dim finalspeed
	finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
	If finalspeed > 10 then
		RandomSoundTargetHitStrong()
		RandomSoundBallBouncePlayfieldSoft Activeball
	Else 
		RandomSoundTargetHitWeak()
	End If	
End Sub

Sub Targets_Hit (idx)
	PlayTargetSound	
End Sub

'/////////////////////////////  BALL BOUNCE SOUNDS  ////////////////////////////
Sub RandomSoundBallBouncePlayfieldSoft(aBall)
	Select Case Int(Rnd*9)+1
		Case 1 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_1"), volz(aBall) * BallBouncePlayfieldSoftFactor, aBall
		Case 2 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_2"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.5, aBall
		Case 3 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_3"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.8, aBall
		Case 4 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_4"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.5, aBall
		Case 5 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_5"), volz(aBall) * BallBouncePlayfieldSoftFactor, aBall
		Case 6 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_1"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
		Case 7 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_2"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
		Case 8 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_5"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
		Case 9 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_7"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.3, aBall
	End Select
End Sub

Sub RandomSoundBallBouncePlayfieldHard(aBall)
	PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_" & Int(Rnd*7)+1), volz(aBall) * BallBouncePlayfieldHardFactor, aBall
End Sub

'/////////////////////////////  DELAYED DROP - TO PLAYFIELD - SOUND  ////////////////////////////
Sub RandomSoundDelayedBallDropOnPlayfield(aBall)
	Select Case Int(Rnd*5)+1
		Case 1 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_1_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
		Case 2 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_2_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
		Case 3 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_3_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
		Case 4 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_4_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
		Case 5 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_5_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
	End Select
End Sub

'/////////////////////////////  BALL GATES AND BRACKET GATES SOUNDS  ////////////////////////////

Sub SoundPlayfieldGate()			
	PlaySoundAtLevelStatic ("Gate_FastTrigger_" & Int(Rnd*2)+1), GateSoundLevel, Activeball
End Sub

Sub SoundHeavyGate()
	PlaySoundAtLevelStatic ("Gate_2"), GateSoundLevel, Activeball
End Sub

Sub Gates_hit(idx)
	SoundHeavyGate
End Sub

Sub GatesWire_hit(idx)	
	SoundPlayfieldGate	
End Sub	

'/////////////////////////////  LEFT LANE ENTRANCE - SOUNDS  ////////////////////////////

Sub RandomSoundLeftArch()
	PlaySoundAtLevelActiveBall ("Arch_L" & Int(Rnd*4)+1), Vol(ActiveBall) * ArchSoundFactor
End Sub

Sub RandomSoundRightArch()
	PlaySoundAtLevelActiveBall ("Arch_R" & Int(Rnd*4)+1), Vol(ActiveBall) * ArchSoundFactor
End Sub

'/////////////////////////////  SAUCERS (KICKER HOLES)  ////////////////////////////

Sub SoundSaucerLock()
	PlaySoundAtLevelStatic ("Saucer_Enter_" & Int(Rnd*2)+1), SaucerLockSoundLevel, Activeball
End Sub

Sub SoundSaucerKick(scenario, saucer)
	Select Case scenario
		Case 0: PlaySoundAtLevelStatic SoundFX("Saucer_Empty", DOFContactors), SaucerKickSoundLevel, saucer
		Case 1: PlaySoundAtLevelStatic SoundFX("Saucer_Kick", DOFContactors), SaucerKickSoundLevel, saucer
	End Select
End Sub

'/////////////////////////////  BALL COLLISION SOUND  ////////////////////////////
Sub OnBallBallCollision(ball1, ball2, velocity)
	Dim snd
	Select Case Int(Rnd*7)+1
		Case 1 : snd = "Ball_Collide_1"
		Case 2 : snd = "Ball_Collide_2"
		Case 3 : snd = "Ball_Collide_3"
		Case 4 : snd = "Ball_Collide_4"
		Case 5 : snd = "Ball_Collide_5"
		Case 6 : snd = "Ball_Collide_6"
		Case 7 : snd = "Ball_Collide_7"
	End Select

	PlaySound (snd), 0, Csng(velocity) ^2 / 200 * BallWithBallCollisionSoundFactor * VolumeDial, AudioPan(ball1), 0, Pitch(ball1), 0, 0, AudioFade(ball1)
End Sub


'///////////////////////////  DROP TARGET HIT SOUNDS  ///////////////////////////

Sub RandomSoundDropTargetReset(obj)
	PlaySoundAtLevelStatic SoundFX("Drop_Target_Reset_" & Int(Rnd*6)+1,DOFContactors), 1, obj
End Sub

Sub SoundDropTargetDrop(obj)
	PlaySoundAtLevelStatic ("Drop_Target_Down_" & Int(Rnd*6)+1), 200, obj
End Sub

'/////////////////////////////  GI AND FLASHER RELAYS  ////////////////////////////

Const RelayFlashSoundLevel = 0.315									'volume level; range [0, 1];
Const RelayGISoundLevel = 1.05									'volume level; range [0, 1];

Sub Sound_GI_Relay(toggle, obj)
	Select Case toggle
		Case 1
			PlaySoundAtLevelStatic ("Relay_GI_On"), 0.025*RelayGISoundLevel, obj
		Case 0
			PlaySoundAtLevelStatic ("Relay_GI_Off"), 0.025*RelayGISoundLevel, obj
	End Select
End Sub

Sub Sound_Flash_Relay(toggle, obj)
	Select Case toggle
		Case 1
			PlaySoundAtLevelStatic ("Relay_Flash_On"), 0.025*RelayFlashSoundLevel, obj			
		Case 0
			PlaySoundAtLevelStatic ("Relay_Flash_Off"), 0.025*RelayFlashSoundLevel, obj		
	End Select
End Sub

'/////////////////////////////////////////////////////////////////
'					End Mechanical Sounds
'/////////////////////////////////////////////////////////////////

'******************************************************
'****  FLEEP MECHANICAL SOUNDS
'******************************************************


' *********************************************************************
'                        User Defined Script Events
' *********************************************************************

' Initialise the Table for a new Game
'
Sub ResetForNewGame()
    Dim i

    bGameInPLay = True

    'resets the score display, and turn off attract mode
    StopAttractMode
    GiOn

    TotalGamesPlayed = TotalGamesPlayed + 1
    CurrentPlayer = 1
    PlayersPlayingGame = 1
    bOnTheFirstBall = True
    For i = 1 To MaxPlayers
        Score(i) = 0
        BonusPoints(i) = 0
        BonusHeldPoints(i) = 0
        BonusMultiplier(i) = 1
        PlayfieldMultiplier(i) = 1
        BallsRemaining(i) = BallsPerGame
        ExtraBallsAwards(i) = 0
    Next

    ' initialise any other flags
    Tilt = 0

    ' initialise specific Game variables
    Game_Init()
    UpdateBallInPlay

    ' you may wish to start some music, play a sound, do whatever at this point
    PlaySound "vo_start" &RndNbr(3)

	If VRRoom > 0 Then
		VRBGFlashIT.enabled = true
	End If
    vpmtimer.addtimer 1500, "FirstBall '"
End Sub

' This is used to delay the start of a game to allow any attract sequence to
' complete.  When it expires it creates a ball for the player to start playing with

Sub FirstBall
    ' reset the table for a new ball
    ResetForNewPlayerBall()
    ' create a new ball in the shooters lane
    CreateNewBall()
End Sub

' (Re-)Initialise the Table for a new ball (either a new ball after the player has
' lost one or we have moved onto the next player (if multiple are playing))

Sub ResetForNewPlayerBall()
    ' make sure the correct display is upto date
    DMDScoreNow

    ' set the current players bonus multiplier back down to 1X
    SetBonusMultiplier 1

    ' reduce the playfield multiplier by 1
    DecreasePlayfieldMultiplier

    ' reset any drop targets, lights, game Mode etc..

    BonusPoints(CurrentPlayer) = 0
    bBonusHeld = False
    bExtraBallWonThisBall = False

    'Reset any table specific
    ResetNewBallVariables

    'This is a new ball, so activate the ballsaver
    bBallSaverReady = True

    'and the skillshot
    bSkillShotReady = True

'Change the music ?
End Sub

' Create a new ball on the Playfield

Sub CreateNewBall()
    ' create a ball in the plunger lane kicker.
    BallRelease.CreateSizedBallWithMass BallSize / 2, BallMass
	Dof 666, DOFpulse 'Fire Right Sling solenoid when ejecting ball
    ' There is a (or another) ball on the playfield
    BallsOnPlayfield = BallsOnPlayfield + 1
    UpdateBallInPlay

    ' kick it out..
	RandomSoundBallRelease BallRelease
    BallRelease.Kick 90, 4
    If bEnableBloodTrails Then BloodBall 1

' if there is 2 or more balls then set the multibal flag (remember to check for locked balls and other balls used for animations)
' set the bAutoPlunger flag to kick the ball in play automatically
    If BallsOnPlayfield > 1 Then
        DOF 143, DOFPulse
        bMultiBallMode = True
        bAutoPlunger = True
    End If
End Sub

' Add extra balls to the table with autoplunger
' Use it as AddMultiball 4 to add 4 extra balls to the table

Sub AddMultiball(nballs)
    mBalls2Eject = mBalls2Eject + nballs
    CreateMultiballTimer.Enabled = True
    'and eject the first ball
    CreateMultiballTimer_Timer
End Sub

' Eject the ball after the delay, AddMultiballDelay
Sub CreateMultiballTimer_Timer()
    ' wait if there is a ball in the plunger lane
    If bBallInPlungerLane Then
        Exit Sub
    Else
        If BallsOnPlayfield < MaxMultiballs Then
            CreateNewBall()
            mBalls2Eject = mBalls2Eject -1
            If mBalls2Eject = 0 Then 'if there are no more balls to eject then stop the timer
                CreateMultiballTimer.Enabled = False
            End If
        Else 'the max number of multiballs is reached, so stop the timer
            mBalls2Eject = 0
            CreateMultiballTimer.Enabled = False
        End If
    End If
End Sub

Sub UpdateBallInPlay
    If B2SOn Then
        if BallsOnPlayfield = 0 then
            Controller.B2sSetData 50, 0:Controller.B2sSetData 51, 0:Controller.B2sSetData 52, 0
        Else
            select case BallsRemaining(CurrentPlayer)
                Case 5:Controller.B2sSetData 50, 1:Controller.B2sSetData 51, 0:Controller.B2sSetData 52, 0
                Case 4:Controller.B2sSetData 50, 1:Controller.B2sSetData 51, 0:Controller.B2sSetData 52, 0
                Case 3:Controller.B2sSetData 50, 1:Controller.B2sSetData 51, 0:Controller.B2sSetData 52, 0
                Case 2:Controller.B2sSetData 50, 0:Controller.B2sSetData 51, 1:Controller.B2sSetData 52, 0
                Case 1:Controller.B2sSetData 50, 0:Controller.B2sSetData 51, 0:Controller.B2sSetData 52, 1
                Case 0:Controller.B2sSetData 50, 0:Controller.B2sSetData 51, 0:Controller.B2sSetData 52, 0
            end select
        end if
    End If
End Sub

' The Player has lost his ball (there are no more balls on the playfield).
' Handle any bonus points awarded

Sub EndOfBall()
    Dim AwardPoints, TotalBonus, ii
    AwardPoints = 0
    TotalBonus = 10 'yes 10 points :)
    ' the first ball has been lost. From this point on no new players can join in
    bOnTheFirstBall = False
    GiOff
    ' only process any of this if the table is not tilted.
    '(the tilt recovery mechanism will handle any extra balls or end of game)

    If NOT Tilted Then
        PlaySong "m_bonus"
        'Count the bonus. This table uses several bonus
        DMD CL("BONUS"), "", "", eNone, eNone, eNone, 1000, True, ""

        'Children rescued + bullies x 250.000
        AwardPoints = ModesWon(CurrentPlayer) * 250000
        TotalBonus = TotalBonus + AwardPoints
        DMD CL("CHILDREN - BULLIES " & ModesWon(CurrentPlayer)), CL(FormatScore(AwardPoints)), "", eNone, eNone, eNone, 800, True, ""
        LightEffect 4

        'Balloons popped X 100.000
        AwardPoints = Balloons(CurrentPlayer) * 100000
        TotalBonus = TotalBonus + AwardPoints
        DMD CL("BALLOONS POPPED " & Balloons(CurrentPlayer)), CL(FormatScore(AwardPoints)), "", eNone, eNone, eNone, 800, True, ""
        vpmTimer.AddTimer 800, "LightEffect 4 '"

        'Orbits X 75.000
        AwardPoints = OrbitHits(CurrentPlayer) * 75000
        TotalBonus = TotalBonus + AwardPoints
        DMD CL("ORBIT HITS " & OrbitHits(CurrentPlayer)), CL(FormatScore(AwardPoints)), "", eNone, eNone, eNone, 800, True, ""
        vpmTimer.AddTimer 1600, "LightEffect 4 '"

        'Combos X 75.000
        AwardPoints = ComboHits(CurrentPlayer) * 75000
        TotalBonus = TotalBonus + AwardPoints
        DMD CL("COMBO HITS " & ComboHits(CurrentPlayer)), CL(FormatScore(AwardPoints)), "", eNone, eNone, eNone, 800, True, ""
        vpmTimer.AddTimer 2400, "LightEffect 4 '"

        'Bumpers X 10.000
        AwardPoints = BumperHits(CurrentPlayer) * 75000
        TotalBonus = TotalBonus + AwardPoints
        DMD CL("BUMPER HITS " & BumperHits(CurrentPlayer)), CL(FormatScore(AwardPoints)), "", eNone, eNone, eNone, 800, True, ""
        vpmTimer.AddTimer 3200, "LightEffect 4 '"

        If TotalBonus > 750000 Then
            DMD CL("TOTAL BONUS X MULT"), CL(FormatScore(TotalBonus * BonusMultiplier(CurrentPlayer))), "", eNone, eNone, eNone, 2000, True, "vo_greatbonus" &RndNbr(3)
        Else
            DMD CL("TOTAL BONUS X MULT"), CL(FormatScore(TotalBonus * BonusMultiplier(CurrentPlayer))), "", eNone, eNone, eNone, 2000, True, "vo_bonus" &RndNbr(2)
        End If
        vpmTimer.AddTimer 4000, "LightEffect 4 '"
        Score(CurrentPlayer) = Score(CurrentPlayer) + TotalBonus * BonusMultiplier(CurrentPlayer)

        ' add a bit of a delay to allow for the bonus points to be shown & added up
        vpmtimer.addtimer 8000, "EndOfBall2 '"
    Else 'if tilted then only add a short delay and move to the 2nd part of the end of the ball
        vpmtimer.addtimer 100, "EndOfBall2 '"
    End If
End Sub

' The Timer which delays the machine to allow any bonus points to be added up
' has expired.  Check to see if there are any extra balls for this player.
' if not, then check to see if this was the last ball (of the CurrentPlayer)
'
Sub EndOfBall2()
    ' if were tilted, reset the internal tilted flag (this will also
    ' set TiltWarnings back to zero) which is useful if we are changing player LOL
    Tilt = 0
    DisableTable False 'enable again bumpers and slingshots

    ' has the player won an extra-ball ? (might be multiple outstanding)
    If ExtraBallsAwards(CurrentPlayer) > 0 Then
        'debug.print "Extra Ball"

        ' yep got to give it to them
        ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer)- 1

        ' if no more EB's then turn off any Extra Ball light if there was any
        If(ExtraBallsAwards(CurrentPlayer) = 0)Then
            LightShootAgain.State = 0
        End If

        ' You may wish to do a bit of a song AND dance at this point
        DMD CL("EXTRA BALL"), CL("SHOOT AGAIN"), "", eNone, eBlink, eNone, 1500, True, "vo_extraball" &RndNbr(2)

        ' In this table an extra ball will have the skillshot and ball saver, so we reset the playfield for the new ball
        ResetForNewPlayerBall()

        ' Create a new ball in the shooters lane
        CreateNewBall()
    Else ' no extra balls

        BallsRemaining(CurrentPlayer) = BallsRemaining(CurrentPlayer)- 1

        ' was that the last ball ?
        If(BallsRemaining(CurrentPlayer) <= 0)Then
            ' debug.print "No More Balls, High Score Entry"
            ' Submit the CurrentPlayers score to the High Score system
            CheckHighScore()
        ' you may wish to play some music at this point

        Else

            ' not the last ball (for that player)
            ' if multiple players are playing then move onto the next one
            EndOfBallComplete()
        End If
    End If
End Sub

' This function is called when the end of bonus display
' (or high score entry finished) AND it either ends the game or
' move onto the next player (or the next ball of the same player)
'
Sub EndOfBallComplete()
    Dim NextPlayer

    'debug.print "EndOfBall - Complete"

    ' are there multiple players playing this game ?
    If(PlayersPlayingGame > 1)Then
        ' then move to the next player
        NextPlayer = CurrentPlayer + 1
        ' are we going from the last player back to the first
        ' (ie say from player 4 back to player 1)
        If(NextPlayer > PlayersPlayingGame)Then
            NextPlayer = 1
        End If
    Else
        NextPlayer = CurrentPlayer
    End If

    'debug.print "Next Player = " & NextPlayer

    ' is it the end of the game ? (all balls been lost for all players)
    If((BallsRemaining(CurrentPlayer) <= 0)AND(BallsRemaining(NextPlayer) <= 0))Then
        ' you may wish to do some sort of Point Match free game award here
        ' generally only done when not in free play mode

        ' set the machine into game over mode
        EndOfGame()

    ' you may wish to put a Game Over message on the desktop/backglass

    Else
        ' set the next player
        CurrentPlayer = NextPlayer

        ' make sure the correct display is up to date
        DMDScoreNow

        ' reset the playfield for the new player (or new ball)
        ResetForNewPlayerBall()

        ' AND create a new ball
        CreateNewBall()

        ' play a sound if more than 1 player
        If PlayersPlayingGame > 1 Then
            Select Case CurrentPlayer
                Case 1:DMD "", CL("PLAYER 1"), "", eNone, eNone, eNone, 1000, True, "vo_player1"
                Case 2:DMD "", CL("PLAYER 2"), "", eNone, eNone, eNone, 1000, True, "vo_player2"
                Case 3:DMD "", CL("PLAYER 3"), "", eNone, eNone, eNone, 1000, True, "vo_player3"
                Case 4:DMD "", CL("PLAYER 4"), "", eNone, eNone, eNone, 1000, True, "vo_player4"
            End Select
        Else
            DMD "", CL("PLAYER 1"), "", eNone, eNone, eNone, 1000, True, "vo_youareup"
        End If
    End If
End Sub

' This function is called at the End of the Game, it should reset all
' Drop targets, AND eject any 'held' balls, start any attract sequences etc..

Sub EndOfGame()
    'debug.print "End Of Game"
    bGameInPLay = False
    ' just ended your game then play the end of game tune
    ChangeSong
    ' ensure that the flippers are down
    SolLFlipper 0
    SolRFlipper 0

    ' terminate all Mode - eject locked balls
    ' most of the Mode/timers terminate at the end of the ball

    ' set any lights for the attract mode
    GiOff
    StartAttractMode
' you may wish to light any Game Over Light you may have

' End of game - setup VR start button to flash if there are credits.
if credits > 0 and VRRoom = 1 then VRStartButtonTimer.enabled = True
if credits > 0 and VRRoom = 2 then VRStartButtonTimer.enabled = True
if credits = 0 and VRRoom = 1 then StartButtonInner.disableLighting = 0
if credits = 0 and VRRoom = 2 then StartButtonInner.disableLighting = 0

End Sub

'this calculates the ball number in play
Function Balls
    Dim tmp
    tmp = BallsPerGame - BallsRemaining(CurrentPlayer) + 1
    If tmp > BallsPerGame Then
        Balls = BallsPerGame
    Else
        Balls = tmp
    End If
End Function

' *********************************************************************
'                      Drain / Plunger Functions
' *********************************************************************

' lost a ball ;-( check to see how many balls are on the playfield.
' if only one then decrement the remaining count AND test for End of game
' if more than 1 ball (multi-ball) then kill of the ball but don't create
' a new one
'
Sub Drain_Hit()
    ' Destroy the ball
    Drain.DestroyBall
    If bGameInPLay = False Then Exit Sub 'don't do anything, just delete the ball
    ' Exit Sub ' only for debugging - this way you can add balls from the debug window

	if bCentipede And Roachloc = 3 then roachmove

    BallsOnPlayfield = BallsOnPlayfield - 1

    ' pretend to knock the ball into the ball storage mech
	RandomSoundDrain Drain 
    'if Tilted the end Ball Mode
    If Tilted Then
        StopEndOfBallMode
    End If

    ' if there is a game in progress AND it is not Tilted
    If(bGameInPLay = True)AND(Tilted = False)Then

        ' is the ball saver active,
        If(bBallSaverActive = True)Then

            ' yep, create a new ball in the shooters lane
            ' we use the Addmultiball in case the multiballs are being ejected
            AddMultiball 1
            ' we kick the ball with the autoplunger
            bAutoPlunger = True
            ' you may wish to put something on a display or play a sound at this point
            ' stop the ballsaver timer during the launch ball saver time, but not during multiballs
            If NOT bMultiBallMode Then
                DMD "_", CL("BALL SAVED"), "_", eNone, eBlinkfast, eNone, 2500, True, "vo_ballsaved"&RndNbr(6)
                BallSaverTimerExpired_Timer
            End If
        Else
            ' cancel any multiball if on last ball (ie. lost all other balls)
            If(BallsOnPlayfield = 1)Then
                ' AND in a multi-ball??
				
                If(bMultiBallMode = True)then
                    ' not in multiball mode any more
                    bMultiBallMode = False
					bEnableBloodTrails = false
					bCentipede = False
					Roach.visible = False

                    BloodBall 0
                    ' you may wish to change any music over at this point and
                    changesong
                    ' turn off any multiball specific lights
                    ChangeGIIntensity 1
                    ChangeGi white


					If VRRoom > 0 Then
						If SpeakerColor = Default Then
						Else '???
							SpeakerColor = Default
							SpeakerChangeColor
						End If
					End If

                    'stop any multiball modes of this game
                    StopMBmodes
                End If
            End If

            ' was that the last ball on the playfield
            If(BallsOnPlayfield = 0)Then
                ' End Mode and timers
				DOF 145, DOFPulse 'MX Drain FLOAT

                StopSong Song
                ChangeGIIntensity 1
                ChangeGi white

				If VRRoom > 0 Then
					If SpeakerColor = Default Then
					Else ' ???
						SpeakerColor = Default
						SpeakerChangeColor
					End If
				End If

                UpdateBallInPlay
                ' Show the end of ball animation
                ' and continue with the end of ball
                ' DMD something?
                StopEndOfBallMode
                vpmtimer.addtimer 200, "EndOfBall '" 'the delay is depending of the animation of the end of ball, if there is no animation then move to the end of ball
            End If
        End If
    End If
End Sub

' The Ball has rolled out of the Plunger Lane and it is pressing down the trigger in the shooters lane
' Check to see if a ball saver mechanism is needed and if so fire it up.

Sub swPlungerRest_Hit()
    'debug.print "ball in plunger lane"
    ' some sound according to the ball position
    bBallInPlungerLane = True
    ' turn on Launch light is there is one
    'LaunchLight.State = 2
    ' be sure to update the Scoreboard after the animations, if any
    ' if the ball goes into the plunger lane during a multiball then activate the autoplunger
    If bMultiBallMode Then 
		bAutoPlunger = True ' kick the ball in play if the bAutoPlunger flag is on
	Else
		DOF 147, DOFOn 'MX ball waiting
	End If 

    If bAutoPlunger Then
        'debug.print "autofire the ball"
        vpmtimer.addtimer 1500, "PlungerIM.AutoFire:DOF 120, DOFPulse:SoundSaucerKick 1, swPlungerRest:bAutoPlunger = False '"
    End If
    'Start the skillshot lights & variables if any
    If bSkillShotReady Then
        ChangeSong
        UpdateSkillshot()
        ' show the message to shoot the ball in case the player has fallen sleep
        swPlungerRest.TimerEnabled = 1
    End If

	if bCentipede And Roachloc = 4 then roachmove
    ' remember last trigger hit by the ball.
    LastSwitchHit = "swPlungerRest"
End Sub

' The ball is released from the plunger turn off some flags and check for skillshot

Sub swPlungerRest_UnHit()
    lighteffect 6
	Dof 147, DOFoff 'Turn off ball waiting
    bBallInPlungerLane = False
	If bMultiBallMode=False or bAutoPlunger=False Then Dof 148,DOFPulse 'MX plunger Streak
    swPlungerRest.TimerEnabled = 0 'stop the launch ball timer if active
    If bSkillShotReady Then
        ChangeSong
        ResetSkillShotTimer.Enabled = 1
    End If
    ' if there is a need for a ball saver, then start off a timer
    ' only start if it is ready, and it is currently not running, else it will reset the time period
    If(bBallSaverReady = True)AND(BallSaverTime <> 0)And(bBallSaverActive = False)Then
        EnableBallSaver BallSaverTime
    End If
' turn off LaunchLight
' LaunchLight.State = 0
End Sub

' swPlungerRest timer to show the "launch ball" if the player has not shot the ball after a while
Sub swPlungerRest_Timer
    PlaySound "vo_wakeup" &RndNbr(6) 'there are only 3 sounds in the table, so it will play a sound about 50% of times
End Sub

Sub EnableBallSaver(seconds)
    'debug.print "Ballsaver started"
    ' set our game flag
    bBallSaverActive = True
    bBallSaverReady = False
    ' start the timer
    BallSaverTimerExpired.Interval = 1000 * seconds
    BallSaverTimerExpired.Enabled = True
    BallSaverSpeedUpTimer.Interval = 1000 * seconds -(1000 * seconds) / 3
    BallSaverSpeedUpTimer.Enabled = True
    ' if you have a ball saver light you might want to turn it on at this point (or make it flash)
    LightShootAgain.BlinkInterval = 160
    LightShootAgain.State = 2
End Sub

' The ball saver timer has expired.  Turn it off AND reset the game flag
'
Sub BallSaverTimerExpired_Timer()
    'debug.print "Ballsaver ended"
    BallSaverTimerExpired.Enabled = False
    BallSaverSpeedUpTimer.Enabled = False 'ensure this timer is also stopped
    ' clear the flag
    bBallSaverActive = False
    ' if you have a ball saver light then turn it off at this point
    LightShootAgain.State = 0
    ' if the table uses the same lights for the extra ball or replay then turn them on if needed
    If ExtraBallsAwards(CurrentPlayer) > 0 Then
        LightShootAgain.State = 1
    End If
End Sub

Sub BallSaverSpeedUpTimer_Timer()
    'debug.print "Ballsaver Speed Up Light"
    BallSaverSpeedUpTimer.Enabled = False
    ' Speed up the blinking
    LightShootAgain.BlinkInterval = 80
    LightShootAgain.State = 2
End Sub

' *********************************************************************
'                      Supporting Score Functions
' *********************************************************************

' Add points to the score AND update the score board

Sub AddScore(points) 'normal score routine; points x playfieldmultiplier
    If Tilted Then Exit Sub
    If bSkillshotReady Then ResetSkillShotTimer_Timer
    ' add the points to the current players score variable
    Score(CurrentPlayer) = Score(CurrentPlayer) + points * PlayfieldMultiplier(CurrentPlayer)
' you may wish to check to see if the player has gotten a replay
End Sub

' Add bonus to the bonuspoints AND update the score board

Sub AddBonus(points) 'not used in this table, since there are many different bonus items.
    If Tilted Then Exit Sub
    ' add the bonus to the current players bonus variable
    BonusPoints(CurrentPlayer) = BonusPoints(CurrentPlayer) + points
End Sub

' Add some points to the current Jackpot.
'
Sub AddJackpot(points)
    ' Jackpots only generally increment in multiball mode AND not tilted
    ' but this doesn't have to be the case
    If Tilted Then Exit Sub

    If(bMultiBallMode = True)Then
        Jackpot(CurrentPlayer) = Jackpot(CurrentPlayer) + points
        ' DMD "_", CL("INCREASED JACKPOT"), "_", eNone, eNone, eNone, 1000, True, ""
        ' you may wish to limit the jackpot to a upper limit, ie..
        If(Jackpot(CurrentPlayer) >= 1000000)Then
            Jackpot(CurrentPlayer) = 1000000
        End if
    End if
End Sub

Sub AddSuperJackpot(points)
    If Tilted Then Exit Sub
    If(bMultiBallMode = True)Then
        SuperJackpot(CurrentPlayer) = SuperJackpot(CurrentPlayer) + points
        ' DMD "_", "INCREASED SP.JACKPOT", "_", eNone, eNone, eNone, 1000, True, ""
        ' you may wish to limit the jackpot to a upper limit, ie..
        If(SuperJackpot(CurrentPlayer) >= 9000000)Then
            SuperJackpot(CurrentPlayer) = 9000000
        End if
    End if
End Sub

Sub AddBonusMultiplier(n)
    Dim NewBonusLevel
    ' if not at the maximum bonus level
    if(BonusMultiplier(CurrentPlayer) + n <= MaxBonusMultiplier)then
        ' then add and set the lights
        NewBonusLevel = BonusMultiplier(CurrentPlayer) + n
        SetBonusMultiplier(NewBonusLevel)
        DMD "_", CL("BONUS X " &NewBonusLevel), "_", eNone, eBlink, eNone, 2000, True, ""
        GiEffect 1
    Else
        AddScore 500000
        DMD "_", CL("500000"), "_", eNone, eNone, eNone, 1000, True, ""
    End if
End Sub

' Set the Bonus Multiplier to the specified level AND set any lights accordingly

Sub SetBonusMultiplier(Level)
    ' Set the multiplier to the specified level
    BonusMultiplier(CurrentPlayer) = Level
    UpdateBonusXLights(Level)
End Sub

Sub UpdateBonusXLights(Level) '4 lights in this table, from 2x to 5x
    ' Update the lights
    Select Case Level
        Case 1:li070.State = 0:li071.State = 0:li072.State = 0:li073.State = 0:li074.State = 0
        Case 2:li070.State = 1:li071.State = 0:li072.State = 0:li073.State = 0:li074.State = 0
        Case 3:li070.State = 1:li071.State = 1:li072.State = 0:li073.State = 0:li074.State = 0
        Case 4:li070.State = 1:li071.State = 1:li072.State = 1:li073.State = 0:li074.State = 0
        Case 5:li070.State = 1:li071.State = 1:li072.State = 1:li073.State = 1:li074.State = 0
        Case 6:li070.State = 1:li071.State = 1:li072.State = 1:li073.State = 1:li074.State = 1
    End Select
End Sub

Sub AddPlayfieldMultiplier(n)
    Dim NewPFLevel
    ' if not at the maximum level x
    if(PlayfieldMultiplier(CurrentPlayer) + n <= MaxMultiplier)then
        ' then add and set the lights
        NewPFLevel = PlayfieldMultiplier(CurrentPlayer) + n
        SetPlayfieldMultiplier(NewPFLevel)
        DMD "_", CL("PLAYFIELD X " &NewPFLevel), "_", eNone, eBlink, eNone, 2000, True, ""
        GiEffect 1
    Else 'if the max is already lit
        AddScore 500000
        DMD "_", CL("500000"), "_", eNone, eNone, eNone, 2000, True, ""
    End if
    ' restart the PlayfieldMultiplier timer to reduce the multiplier
    PFXTimer.Enabled = 0
    PFXTimer.Enabled = 1
End Sub

Sub PFXTimer_Timer
    DecreasePlayfieldMultiplier
End Sub

Sub DecreasePlayfieldMultiplier 'reduces by 1 the playfield multiplier
    Dim NewPFLevel
    ' if not at 1 already
    if(PlayfieldMultiplier(CurrentPlayer) > 1)then
        ' then add and set the lights
        NewPFLevel = PlayfieldMultiplier(CurrentPlayer)- 1
        SetPlayfieldMultiplier(NewPFLevel)
        PFXTimer.Enabled = 1
    Else
        PFXTimer.Enabled = 0
    End if
End Sub

' Set the Playfield Multiplier to the specified level AND set any lights accordingly

Sub SetPlayfieldMultiplier(Level)
    ' Set the multiplier to the specified level
    PlayfieldMultiplier(CurrentPlayer) = Level
    UpdatePFXLights(Level)
End Sub

Sub UpdatePFXLights(Level) 'no lights in this table, the multiplier is shown in the DMD
    ' Update the playfield multiplier lights
    Select Case Level
        Case 1:li065.State = 0:li066.State = 0:li067.State = 0:li068.State = 0:li069.State = 0
        Case 2:li065.State = 1:li066.State = 0:li067.State = 0:li068.State = 0:li069.State = 0
        Case 3:li065.State = 1:li066.State = 1:li067.State = 0:li068.State = 0:li069.State = 0
        Case 4:li065.State = 1:li066.State = 1:li067.State = 1:li068.State = 0:li069.State = 0
        Case 5:li065.State = 1:li066.State = 1:li067.State = 1:li068.State = 1:li069.State = 0
        Case 6:li065.State = 1:li066.State = 1:li067.State = 1:li068.State = 1:li069.State = 1
    End Select
' perhaps show also the multiplier in the DMD?
End Sub

Sub ExtraBallIsLit
    DMD "_", CL("EXTRA BALL IS LIT"), "", eNone, eNone, eNone, 1500, True, "vo_extraballislit"
    li044.State = 1
End Sub

Sub AwardExtraBall()
    '   If NOT bExtraBallWonThisBall Then 'uncomment this If in case you want to give just one extra ball per ball
    DMD "_", CL("EXTRA BALL WON"), "_", eNone, eBlink, eNone, 1000, True, SoundFXDOF("Knocker_1", 122, DOFPulse, DOFKnocker)
    DOF 121, DOFPulse
    ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer) + 1
    '    bExtraBallWonThisBall = True
    LightShootAgain.State = 1 'light the shoot again lamp
    GiEffect 3
    LightEffect 2
'    END If

	If VRRoom > 0 Then
		VRBGFlashLong.enabled = True
	End If

End Sub

Sub AwardSpecial()
    DMD "_", CL("EXTRA GAME WON"), "_", eNone, eBlink, eNone, 1000, True, SoundFXDOF("Knocker_1", 122, DOFPulse, DOFKnocker)
    DOF 121, DOFPulse
    Credits = Credits + 1
    If bFreePlay = False Then DOF 125, DOFOn
    LightEffect 2
    GiEffect 3
	If VRRoom > 0 Then
		VRBGFlashLong.enabled = True
	End If

End Sub

Sub AwardJackpot()
    DMD CL("JACKPOT"), CL(FormatScore(Jackpot(CurrentPlayer))), "d_border", eNone, eBlinkFast, eNone, 1500, True, "vo_Jackpot"
    DOF 126, DOFPulse
    AddScore Jackpot(CurrentPlayer)
    AddJackpot 50000
    LightEffect 2
    GiEffect 3
    FlashEffect 2
	If VRRoom > 0 Then
		VRBGFlashSmall.enabled = True
	End If

End Sub

Sub AwardSuperJackpot()
    DMD CL("SUPER JACKPOT"), CL(FormatScore(SuperJackpot(CurrentPlayer))), "d_border", eNone, eBlinkFast, eNone, 2000, True, "vo_superjackpot"
    DOF 126, DOFPulse
    AddScore SuperJackpot(CurrentPlayer)
    AddSuperJackpot 100000
    LightEffect 2
    GiEffect 3


	If VRRoom > 0 Then
		VRBGFlashLong.enabled = True
	End If
End Sub

Sub SuperJackpotTimer_Timer 'timer to stop superjackpots at Pennywise after 30 seconds
    SuperJackpotTimer.Enabled = 0
    SPJackpotLight(5) = 0
    li045.State = 0
End Sub

Sub AwardSkillshot(points)
    ResetSkillShotTimer_Timer
    'show dmd animation
    DMD CL("SKILLSHOT"), CL(FormatScore(points)), "d_border", eNone, eBlinkFast, eNone, 2000, True, "vo_skillshot"
    DOF 127, DOFPulse
    AddScore points
    'do some light show
    GiEffect 3
    LightEffect 2
	If VRRoom > 0 Then
		VRBGFlashSmall.enabled = True
	End If

End Sub

Sub AwardSuperSkillshot(points)
    ResetSkillShotTimer_Timer
    'show dmd animation
    DMD CL("SUPER SKILLSHOT"), CL(FormatScore(points)), "d_border", eNone, eBlinkFast, eNone, 2000, True, "vo_superskillshot"
    DOF 127, DOFPulse
    AddScore points
    'do some light show
    GiEffect 3
    LightEffect 2

	If VRRoom > 0 Then
		VRBGFlashLong.enabled = True
	End If
End Sub

'**************
'   COMBOS
'**************

Sub AwardCombo
	DOF 128, DOFPulse 'Combo
    ComboCount = ComboCount + 1
    ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1 'bonus
    Select Case ComboCount
        Case 1:DMD CL("COMBO"), CL(FormatScore(ComboValue(CurrentPlayer))), "", eNone, eNone, eNone, 1500, True, "vo_combo1":ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case 2:DMD CL("2X COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * 2)), "", eNone, eNone, eNone, 1500, True, "vo_combo2":ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case 3:DMD CL("3X COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * 3)), "", eNone, eNone, eNone, 1500, True, "vo_combo3":ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case 4:DMD CL("4X COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * 4)), "", eNone, eNone, eNone, 1500, True, "vo_combo4":ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case 5:DMD CL("5X COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * 5)), "", eNone, eNone, eNone, 1500, True, "vo_combo5":ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case Else:DMD CL("SUPER COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * 10)), "", eNone, eNone, eNone, 1500, True, "vo_supercombo":ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
    End Select
    AddScore ComboValue(CurrentPlayer) * ComboCount
    ComboValue(CurrentPlayer) = ComboValue(CurrentPlayer) + 100000
End Sub

'*****************************
'    Load / Save / Highscore
'*****************************

Sub Loadhs
    Dim x
    x = LoadValue(cGameName, "HighScore1")
    If(x <> "")Then HighScore(0) = CDbl(x)Else HighScore(0) = 100000 End If
    x = LoadValue(cGameName, "HighScore1Name")
    If(x <> "")Then HighScoreName(0) = x Else HighScoreName(0) = "AAA" End If
    x = LoadValue(cGameName, "HighScore2")
    If(x <> "")then HighScore(1) = CDbl(x)Else HighScore(1) = 100000 End If
    x = LoadValue(cGameName, "HighScore2Name")
    If(x <> "")then HighScoreName(1) = x Else HighScoreName(1) = "BBB" End If
    x = LoadValue(cGameName, "HighScore3")
    If(x <> "")then HighScore(2) = CDbl(x)Else HighScore(2) = 100000 End If
    x = LoadValue(cGameName, "HighScore3Name")
    If(x <> "")then HighScoreName(2) = x Else HighScoreName(2) = "CCC" End If
    x = LoadValue(cGameName, "HighScore4")
    If(x <> "")then HighScore(3) = CDbl(x)Else HighScore(3) = 100000 End If
    x = LoadValue(cGameName, "HighScore4Name")
    If(x <> "")then HighScoreName(3) = x Else HighScoreName(3) = "DDD" End If
    x = LoadValue(cGameName, "Credits")
    If(x <> "")then Credits = CInt(x)Else Credits = 0:If bFreePlay = False Then DOF 125, DOFOff:End If
    x = LoadValue(cGameName, "TotalGamesPlayed")
    If(x <> "")then TotalGamesPlayed = CInt(x)Else TotalGamesPlayed = 0 End If

	if VRRoom = 1 and Credits > 0 then VRStartButtonTimer.enabled = true
	if VRRoom = 2 and Credits > 0 then VRStartButtonTimer.enabled = true

End Sub

Sub Savehs
    SaveValue cGameName, "HighScore1", HighScore(0)
    SaveValue cGameName, "HighScore1Name", HighScoreName(0)
    SaveValue cGameName, "HighScore2", HighScore(1)
    SaveValue cGameName, "HighScore2Name", HighScoreName(1)
    SaveValue cGameName, "HighScore3", HighScore(2)
    SaveValue cGameName, "HighScore3Name", HighScoreName(2)
    SaveValue cGameName, "HighScore4", HighScore(3)
    SaveValue cGameName, "HighScore4Name", HighScoreName(3)
    SaveValue cGameName, "Credits", Credits
    SaveValue cGameName, "TotalGamesPlayed", TotalGamesPlayed
End Sub

Sub Reseths
    HighScoreName(0) = "AAA"
    HighScoreName(1) = "BBB"
    HighScoreName(2) = "CCC"
    HighScoreName(3) = "DDD"
    HighScore(0) = 1500000
    HighScore(1) = 1400000
    HighScore(2) = 1300000
    HighScore(3) = 1200000
    Savehs
End Sub

' ***********************************************************
'  High Score Initals Entry Functions - based on Black's code
' ***********************************************************

Dim hsbModeActive
Dim hsEnteredName
Dim hsEnteredDigits(3)
Dim hsCurrentDigit
Dim hsValidLetters
Dim hsCurrentLetter
Dim hsLetterFlash

Sub CheckHighscore()
    Dim tmp
    tmp = Score(CurrentPlayer)

    If tmp > HighScore(0)Then 'add 1 credit for beating the highscore
        Credits = Credits + 1
        'DOF 125, DOFOn
    End If

    If tmp > HighScore(3)Then
        KnockerSolenoid
        DOF 121, DOFPulse
        HighScore(3) = tmp
        'enter player's name
        HighScoreEntryInit()
    Else
        EndOfBallComplete()
    End If
End Sub

Sub HighScoreEntryInit()
    hsbModeActive = True
    PlaySound "vo_greatscore" &RndNbr(6)
    hsLetterFlash = 0

    hsEnteredDigits(0) = " "
    hsEnteredDigits(1) = " "
    hsEnteredDigits(2) = " "
    hsCurrentDigit = 0

    hsValidLetters = " ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<" ' < is back arrow
    hsCurrentLetter = 1
    DMDFlush()
    HighScoreDisplayNameNow()

    HighScoreFlashTimer.Interval = 250
    HighScoreFlashTimer.Enabled = True
End Sub

Sub EnterHighScoreKey(keycode)
    If keycode = LeftFlipperKey Then
        playsound "fx_Previous"
        hsCurrentLetter = hsCurrentLetter - 1
        if(hsCurrentLetter = 0)then
            hsCurrentLetter = len(hsValidLetters)
        end if
        HighScoreDisplayNameNow()
    End If

    If keycode = RightFlipperKey Then
        playsound "fx_Next"
        hsCurrentLetter = hsCurrentLetter + 1
        if(hsCurrentLetter > len(hsValidLetters))then
            hsCurrentLetter = 1
        end if
        HighScoreDisplayNameNow()
    End If

    If keycode = PlungerKey OR keycode = StartGameKey Then
        if(mid(hsValidLetters, hsCurrentLetter, 1) <> "<")then
            playsound "fx_Enter"
            hsEnteredDigits(hsCurrentDigit) = mid(hsValidLetters, hsCurrentLetter, 1)
            hsCurrentDigit = hsCurrentDigit + 1
            if(hsCurrentDigit = 3)then
                HighScoreCommitName()
            else
                HighScoreDisplayNameNow()
            end if
        else
            playsound "fx_Esc"
            hsEnteredDigits(hsCurrentDigit) = " "
            if(hsCurrentDigit > 0)then
                hsCurrentDigit = hsCurrentDigit - 1
            end if
            HighScoreDisplayNameNow()
        end if
    end if
End Sub

Sub HighScoreDisplayNameNow()
    HighScoreFlashTimer.Enabled = False
    hsLetterFlash = 0
    HighScoreDisplayName()
    HighScoreFlashTimer.Enabled = True
End Sub

Sub HighScoreDisplayName()
    Dim i
    Dim TempTopStr
    Dim TempBotStr

    TempTopStr = "YOUR NAME:"
    dLine(0) = ExpandLine(TempTopStr)
    DMDUpdate 0

    TempBotStr = "    > "
    if(hsCurrentDigit > 0)then TempBotStr = TempBotStr & hsEnteredDigits(0)
    if(hsCurrentDigit > 1)then TempBotStr = TempBotStr & hsEnteredDigits(1)
    if(hsCurrentDigit > 2)then TempBotStr = TempBotStr & hsEnteredDigits(2)

    if(hsCurrentDigit <> 3)then
        if(hsLetterFlash <> 0)then
            TempBotStr = TempBotStr & "_"
        else
            TempBotStr = TempBotStr & mid(hsValidLetters, hsCurrentLetter, 1)
        end if
    end if

    if(hsCurrentDigit < 1)then TempBotStr = TempBotStr & hsEnteredDigits(1)
    if(hsCurrentDigit < 2)then TempBotStr = TempBotStr & hsEnteredDigits(2)

    TempBotStr = TempBotStr & " <    "
    dLine(1) = ExpandLine(TempBotStr)
    DMDUpdate 1
End Sub

Sub HighScoreFlashTimer_Timer()
    HighScoreFlashTimer.Enabled = False
    hsLetterFlash = hsLetterFlash + 1
    if(hsLetterFlash = 2)then hsLetterFlash = 0
    HighScoreDisplayName()
    HighScoreFlashTimer.Enabled = True
End Sub

Sub HighScoreCommitName()
    HighScoreFlashTimer.Enabled = False
    hsbModeActive = False

    hsEnteredName = hsEnteredDigits(0) & hsEnteredDigits(1) & hsEnteredDigits(2)
    if(hsEnteredName = "   ")then
        hsEnteredName = "YOU"
    end if

    HighScoreName(3) = hsEnteredName
    SortHighscore
    EndOfBallComplete()
End Sub

Sub SortHighscore
    Dim tmp, tmp2, i, j
    For i = 0 to 3
        For j = 0 to 2
            If HighScore(j) < HighScore(j + 1)Then
                tmp = HighScore(j + 1)
                tmp2 = HighScoreName(j + 1)
                HighScore(j + 1) = HighScore(j)
                HighScoreName(j + 1) = HighScoreName(j)
                HighScore(j) = tmp
                HighScoreName(j) = tmp2
            End If
        Next
    Next
End Sub

'*********
'   LUT
'*********

Dim bLutActive, LUTImage
Sub LoadLUT
    bLutActive = False
    x = LoadValue(cGameName, "LUTImage")
    If(x <> "")Then LUTImage = x Else LUTImage = 9
	If VRRoom <> 0 then LUTImage = 4 ' Load LUT 4 for VR room Users
    UpdateLUT
End Sub

Sub SaveLUT
    SaveValue cGameName, "LUTImage", LUTImage
End Sub

Sub NextLUT:LUTImage = (LUTImage + 1)MOD 15:UpdateLUT:SaveLUT:Lutbox.text = "level of darkness " & LUTImage + 1:End Sub

Sub UpdateLUT
    Select Case LutImage
        Case 0:table1.ColorGradeImage = "LUT0":GiIntensity = 1:ChangeGIIntensity 1
        Case 1:table1.ColorGradeImage = "LUT1":GiIntensity = 1.05:ChangeGIIntensity 1
        Case 2:table1.ColorGradeImage = "LUT2":GiIntensity = 1.1:ChangeGIIntensity 1
        Case 3:table1.ColorGradeImage = "LUT3":GiIntensity = 1.15:ChangeGIIntensity 1
        Case 4:table1.ColorGradeImage = "LUT4":GiIntensity = 1.2:ChangeGIIntensity 1
        Case 5:table1.ColorGradeImage = "LUT5":GiIntensity = 1.25:ChangeGIIntensity 1
        Case 6:table1.ColorGradeImage = "LUT6":GiIntensity = 1.3:ChangeGIIntensity 1
        Case 7:table1.ColorGradeImage = "LUT7":GiIntensity = 1.35:ChangeGIIntensity 1
        Case 8:table1.ColorGradeImage = "LUT8":GiIntensity = 1.4:ChangeGIIntensity 1
        Case 9:table1.ColorGradeImage = "LUT9":GiIntensity = 1.45:ChangeGIIntensity 1
        Case 10:table1.ColorGradeImage = "LUT10":GiIntensity = 1.5:ChangeGIIntensity 1
        Case 11:table1.ColorGradeImage = "LUT11":GiIntensity = 1.55:ChangeGIIntensity 1
        Case 12:table1.ColorGradeImage = "LUT12":GiIntensity = 1.6:ChangeGIIntensity 1
        Case 13:table1.ColorGradeImage = "LUT13":GiIntensity = 1.65:ChangeGIIntensity 1
        Case 14:table1.ColorGradeImage = "LUT14":GiIntensity = 1.7:ChangeGIIntensity 1
    End Select
End Sub

' *************************************************************************
'   JP's Reduced Display Driver Functions (based on script by Black)
' only 5 effects: none, scroll left, scroll right, blink and blinkfast
' 3 Lines, treats all 3 lines as text.
' 1st and 2nd lines are 20 characters long
' 3rd line is just 1 character
' Example format:
' DMD "text1","text2","backpicture", eNone, eNone, eNone, 250, True, "sound"
' Short names:
' dq = display queue
' de = display effect
' *************************************************************************

Const eNone = 0        ' Instantly displayed
Const eScrollLeft = 1  ' scroll on from the right
Const eScrollRight = 2 ' scroll on from the left
Const eBlink = 3       ' Blink (blinks for 'TimeOn')
Const eBlinkFast = 4   ' Blink (blinks for 'TimeOn') at user specified intervals (fast speed)

Const dqSize = 64

Dim dqHead
Dim dqTail
Dim deSpeed
Dim deBlinkSlowRate
Dim deBlinkFastRate

Dim dLine(2)
Dim deCount(2)
Dim deCountEnd(2)
Dim deBlinkCycle(2)

Dim dqText(2, 64)
Dim dqEffect(2, 64)
Dim dqTimeOn(64)
Dim dqbFlush(64)
Dim dqSound(64)

Dim FlexDMD
Dim DMDScene

Sub DMD_Init() 'default/startup values
    If UseFlexDMD Then
        Set FlexDMD = CreateObject("FlexDMD.FlexDMD")
        If Not FlexDMD is Nothing Then
            If FlexDMDHighQuality Then
                FlexDMD.TableFile = Table1.Filename & ".vpx"
                FlexDMD.RenderMode = 2
                FlexDMD.Width = 256
                FlexDMD.Height = 64
                FlexDMD.Clear = True
                FlexDMD.GameName = cGameName
                FlexDMD.Run = True
                Set DMDScene = FlexDMD.NewGroup("Scene")
                DMDScene.AddActor FlexDMD.NewImage("Back", "VPX.d_border")
                DMDScene.GetImage("Back").SetSize FlexDMD.Width, FlexDMD.Height
                For i = 0 to 40
                    DMDScene.AddActor FlexDMD.NewImage("Dig" & i, "VPX.d_empty&dmd=2")
                    Digits(i).Visible = False
                Next
                digitgrid.Visible = False
                For i = 0 to 19 ' Top
                    DMDScene.GetImage("Dig" & i).SetBounds 8 + i * 12, 6, 12, 22
                Next
                For i = 20 to 39 ' Bottom
                    DMDScene.GetImage("Dig" & i).SetBounds 8 + (i - 20) * 12, 34, 12, 22
                Next
                FlexDMD.LockRenderThread
                FlexDMD.Stage.AddActor DMDScene
                FlexDMD.UnlockRenderThread
            Else
                FlexDMD.TableFile = Table1.Filename & ".vpx"
                FlexDMD.RenderMode = 2
                FlexDMD.Width = 128
                FlexDMD.Height = 32
                FlexDMD.Clear = True
                FlexDMD.GameName = cGameName
                FlexDMD.Run = True
                Set DMDScene = FlexDMD.NewGroup("Scene")
                DMDScene.AddActor FlexDMD.NewImage("Back", "VPX.d_border")
                DMDScene.GetImage("Back").SetSize FlexDMD.Width, FlexDMD.Height
                For i = 0 to 40
                    DMDScene.AddActor FlexDMD.NewImage("Dig" & i, "VPX.d_empty&dmd=2")
                    Digits(i).Visible = False
                Next
                digitgrid.Visible = False
                For i = 0 to 19 ' Top
                    DMDScene.GetImage("Dig" & i).SetBounds 4 + i * 6, 3, 6, 11
                Next
                For i = 20 to 39 ' Bottom
                    DMDScene.GetImage("Dig" & i).SetBounds 4 + (i - 20) * 6, 17, 6, 11
                Next
                FlexDMD.LockRenderThread
                FlexDMD.Stage.AddActor DMDScene
                FlexDMD.UnlockRenderThread
            End If
        End If
    End If

    Dim i, j
    DMDFlush()
    deSpeed = 20
    deBlinkSlowRate = 10
    deBlinkFastRate = 5
    For i = 0 to 2
        dLine(i) = Space(20)
        deCount(i) = 0
        deCountEnd(i) = 0
        deBlinkCycle(i) = 0
        dqTimeOn(i) = 0
        dqbFlush(i) = True
        dqSound(i) = ""
    Next
    dLine(2) = " "
    For i = 0 to 2
        For j = 0 to 64
            dqText(i, j) = ""
            dqEffect(i, j) = eNone
        Next
    Next
    DMD dLine(0), dLine(1), dLine(2), eNone, eNone, eNone, 25, True, ""
End Sub

Sub DMDFlush()
    Dim i
    DMDTimer.Enabled = False
    DMDEffectTimer.Enabled = False
    dqHead = 0
    dqTail = 0
    For i = 0 to 2
        deCount(i) = 0
        deCountEnd(i) = 0
        deBlinkCycle(i) = 0
    Next
End Sub

Sub DMDScore()
    Dim tmp, tmp1, tmp1a, tmp1b, tmp2
    if(dqHead = dqTail)Then
        ' default when no modes are active
        tmp = RL(FormatScore(Score(Currentplayer)))
        tmp1 = FL("PLAYER " &CurrentPlayer, "BALL " & Balls)
        tmp2 = "d_border"
        'info on the second line: tmp1
        Select Case Mode(CurrentPlayer, 0)
            Case 0 'no Mode active
            Case 1
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("SPINNERS LEFT " & SpinsToCount1-SpinCount1)
            Case 2
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("BUMPERS LEFT " & BumpersToHit2-BumperHits2)
            Case 3
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("RAMPHITS LEFT " & RampsToHit3-RampHits3)
            Case 4
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("ORBITS LEFT " & OrbitsToHit4-OrbitHits4)
            Case 5
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("HITS LEFT " & LightsToHit5-LightHits5)
            Case 6
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("HITS LEFT " & LightsToHit6-LightHits6)
            Case 7
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("TARGET HITS LEFT " & TargetsToHit7-TargetHits7)
            Case 8
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("COMPLETE YELLOW BANK")
            Case 9
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("COMPLETE GREEN BANK")
            Case 10
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("COMPLETE BLUE BANK")
            Case 11
                tmp = FL("PLAYER " &CurrentPlayer, FormatScore(Score(Currentplayer)))
                tmp1 = CL("HIT A RAMP COMBO")
        End Select
    End If
    DMD tmp, tmp1, tmp2, eNone, eNone, eNone, 10, True, ""
End Sub

Sub DMDScoreNow
    DMDFlush
    DMDScore
End Sub

Sub DMD(Text0, Text1, Text2, Effect0, Effect1, Effect2, TimeOn, bFlush, Sound)
    if(dqTail < dqSize)Then
        if(Text0 = "_")Then
            dqEffect(0, dqTail) = eNone
            dqText(0, dqTail) = "_"
        Else
            dqEffect(0, dqTail) = Effect0
            dqText(0, dqTail) = ExpandLine(Text0)
        End If

        if(Text1 = "_")Then
            dqEffect(1, dqTail) = eNone
            dqText(1, dqTail) = "_"
        Else
            dqEffect(1, dqTail) = Effect1
            dqText(1, dqTail) = ExpandLine(Text1)
        End If

        if(Text2 = "_")Then
            dqEffect(2, dqTail) = eNone
            dqText(2, dqTail) = "_"
        Else
            dqEffect(2, dqTail) = Effect2
            dqText(2, dqTail) = Text2 'it is always 1 letter in this table
        End If

        dqTimeOn(dqTail) = TimeOn
        dqbFlush(dqTail) = bFlush
        dqSound(dqTail) = Sound
        dqTail = dqTail + 1
        if(dqTail = 1)Then
            DMDHead()
        End If
    End If
End Sub

Sub DMDHead()
    Dim i
    deCount(0) = 0
    deCount(1) = 0
    deCount(2) = 0
    DMDEffectTimer.Interval = deSpeed

    For i = 0 to 2
        Select Case dqEffect(i, dqHead)
            Case eNone:deCountEnd(i) = 1
            Case eScrollLeft:deCountEnd(i) = Len(dqText(i, dqHead))
            Case eScrollRight:deCountEnd(i) = Len(dqText(i, dqHead))
            Case eBlink:deCountEnd(i) = int(dqTimeOn(dqHead) / deSpeed)
                deBlinkCycle(i) = 0
            Case eBlinkFast:deCountEnd(i) = int(dqTimeOn(dqHead) / deSpeed)
                deBlinkCycle(i) = 0
        End Select
    Next
    if(dqSound(dqHead) <> "")Then
        PlaySound(dqSound(dqHead))
    End If
    DMDEffectTimer.Enabled = True
End Sub

Sub DMDEffectTimer_Timer()
    DMDEffectTimer.Enabled = False
    DMDProcessEffectOn()
End Sub

Sub DMDTimer_Timer()
    Dim Head
    DMDTimer.Enabled = False
    Head = dqHead
    dqHead = dqHead + 1
    if(dqHead = dqTail)Then
        if(dqbFlush(Head) = True)Then
            DMDScoreNow()
        Else
            dqHead = 0
            DMDHead()
        End If
    Else
        DMDHead()
    End If
End Sub

Sub DMDProcessEffectOn()
    Dim i
    Dim BlinkEffect
    Dim Temp

    BlinkEffect = False

    For i = 0 to 2
        if(deCount(i) <> deCountEnd(i))Then
            deCount(i) = deCount(i) + 1

            select case(dqEffect(i, dqHead))
                case eNone:
                    Temp = dqText(i, dqHead)
                case eScrollLeft:
                    Temp = Right(dLine(i), 19)
                    Temp = Temp & Mid(dqText(i, dqHead), deCount(i), 1)
                case eScrollRight:
                    Temp = Mid(dqText(i, dqHead), 21 - deCount(i), 1)
                    Temp = Temp & Left(dLine(i), 19)
                case eBlink:
                    BlinkEffect = True
                    if((deCount(i)MOD deBlinkSlowRate) = 0)Then
                        deBlinkCycle(i) = deBlinkCycle(i)xor 1
                    End If

                    if(deBlinkCycle(i) = 0)Then
                        Temp = dqText(i, dqHead)
                    Else
                        Temp = Space(20)
                    End If
                case eBlinkFast:
                    BlinkEffect = True
                    if((deCount(i)MOD deBlinkFastRate) = 0)Then
                        deBlinkCycle(i) = deBlinkCycle(i)xor 1
                    End If

                    if(deBlinkCycle(i) = 0)Then
                        Temp = dqText(i, dqHead)
                    Else
                        Temp = Space(20)
                    End If
            End Select

            if(dqText(i, dqHead) <> "_")Then
                dLine(i) = Temp
                DMDUpdate i
            End If
        End If
    Next

    if(deCount(0) = deCountEnd(0))and(deCount(1) = deCountEnd(1))and(deCount(2) = deCountEnd(2))Then

        if(dqTimeOn(dqHead) = 0)Then
            DMDFlush()
        Else
            if(BlinkEffect = True)Then
                DMDTimer.Interval = 10
            Else
                DMDTimer.Interval = dqTimeOn(dqHead)
            End If

            DMDTimer.Enabled = True
        End If
    Else
        DMDEffectTimer.Enabled = True
    End If
End Sub

Function ExpandLine(TempStr) 'id is the number of the dmd line
    If TempStr = "" Then
        TempStr = Space(20)
    Else
        if Len(TempStr) > Space(20)Then
            TempStr = Left(TempStr, Space(20))
        Else
            if(Len(TempStr) < 20)Then
                TempStr = TempStr & Space(20 - Len(TempStr))
            End If
        End If
    End If
    ExpandLine = TempStr
End Function

Function FormatScore(ByVal Num) 'it returns a string with commas (as in Black's original font)
    dim i
    dim NumString

    NumString = CStr(abs(Num))

    For i = Len(NumString)-3 to 1 step -3
        if IsNumeric(mid(NumString, i, 1))then
            NumString = left(NumString, i-1) & chr(asc(mid(NumString, i, 1)) + 128) & right(NumString, Len(NumString)- i)
        end if
    Next
    FormatScore = NumString
End function

Function FL(NumString1, NumString2) 'Fill line
    Dim Temp, TempStr
    If Len(NumString1) + Len(NumString2) < 20 Then
        Temp = 20 - Len(NumString1)- Len(NumString2)
        TempStr = NumString1 & Space(Temp) & NumString2
        FL = TempStr
    End If
End Function

Function CL(NumString) 'center line
    Dim Temp, TempStr
    If Len(NumString) > 20 Then NumString = Left(NumString, 20)
    Temp = (20 - Len(NumString)) \ 2
    TempStr = Space(Temp) & NumString & Space(Temp)
    CL = TempStr
End Function

Function RL(NumString) 'right line
    Dim Temp, TempStr
    If Len(NumString) > 20 Then NumString = Left(NumString, 20)
    Temp = 20 - Len(NumString)
    TempStr = Space(Temp) & NumString
    RL = TempStr
End Function

'**************
' Update DMD
'**************

Sub DMDUpdate(id)
    Dim digit, value
    If UseFlexDMD Then FlexDMD.LockRenderThread
    Select Case id
        Case 0 'top text line
            For digit = 0 to 19
                DMDDisplayChar mid(dLine(0), digit + 1, 1), digit
            Next
        Case 1 'bottom text line
            For digit = 20 to 39
                DMDDisplayChar mid(dLine(1), digit -19, 1), digit
            Next
        Case 2 ' back image - back animations
            If dLine(2) = "" OR dLine(2) = " " Then dLine(2) = "d_border"
            Digits(40).ImageA = dLine(2)
            If UseFlexDMD Then DMDScene.GetImage("Back").Bitmap = FlexDMD.NewImage("", "VPX." & dLine(2) & "&dmd=2").Bitmap
    End Select
    If UseFlexDMD Then FlexDMD.UnlockRenderThread
End Sub

Sub DMDDisplayChar(achar, adigit)
    If achar = "" Then achar = " "
    achar = ASC(achar)
    Digits(adigit).ImageA = Chars(achar)
    If UseFlexDMD Then DMDScene.GetImage("Dig" & adigit).Bitmap = FlexDMD.NewImage("", "VPX." & Chars(achar) & "&dmd=2&add").Bitmap
End Sub

'************************************
'    JP's new DMD using flashers
' two text lines and 1 backdrop image
'************************************

Dim Digits, Chars(255), Images(255)

DMDInit

Sub DMDInit
    Dim i
    Digits = Array(digit001, digit002, digit003, digit004, digit005, digit006, digit007, digit008, digit009, digit010, _
        digit011, digit012, digit013, digit014, digit015, digit016, digit017, digit018, digit019, digit020,            _
        digit021, digit022, digit023, digit024, digit025, digit026, digit027, digit028, digit029, digit030,            _
        digit031, digit032, digit033, digit034, digit035, digit036, digit037, digit038, digit039, digit040,            _
        digit041)
    For i = 0 to 255:Chars(i) = "d_empty":Next

    Chars(32) = "d_empty"
    Chars(33) = ""        '!
    Chars(34) = ""        '"
    Chars(35) = ""        '#
    Chars(36) = ""        '$
    Chars(37) = ""        '%
    Chars(38) = ""        '&
    Chars(39) = ""        ''
    Chars(40) = ""        '(
    Chars(41) = ""        ')
    Chars(42) = ""        '*
    Chars(43) = ""        '+
    Chars(44) = ""        '
    Chars(45) = "d_minus" '-
    Chars(46) = "d_dot"   '.
    Chars(47) = ""        '/
    Chars(48) = "d_0"     '0
    Chars(49) = "d_1"     '1
    Chars(50) = "d_2"     '2
    Chars(51) = "d_3"     '3
    Chars(52) = "d_4"     '4
    Chars(53) = "d_5"     '5
    Chars(54) = "d_6"     '6
    Chars(55) = "d_7"     '7
    Chars(56) = "d_8"     '8
    Chars(57) = "d_9"     '9
    Chars(60) = "d_less"  '<
    Chars(61) = ""        '=
    Chars(62) = "d_more"  '>
    Chars(64) = ""        '@
    Chars(65) = "d_a"     'A
    Chars(66) = "d_b"     'B
    Chars(67) = "d_c"     'C
    Chars(68) = "d_d"     'D
    Chars(69) = "d_e"     'E
    Chars(70) = "d_f"     'F
    Chars(71) = "d_g"     'G
    Chars(72) = "d_h"     'H
    Chars(73) = "d_i"     'I
    Chars(74) = "d_j"     'J
    Chars(75) = "d_k"     'K
    Chars(76) = "d_l"     'L
    Chars(77) = "d_m"     'M
    Chars(78) = "d_n"     'N
    Chars(79) = "d_o"     'O
    Chars(80) = "d_p"     'P
    Chars(81) = "d_q"     'Q
    Chars(82) = "d_r"     'R
    Chars(83) = "d_s"     'S
    Chars(84) = "d_t"     'T
    Chars(85) = "d_u"     'U
    Chars(86) = "d_v"     'V
    Chars(87) = "d_w"     'W
    Chars(88) = "d_x"     'X
    Chars(89) = "d_y"     'Y
    Chars(90) = "d_z"     'Z
    Chars(94) = "d_up"    '^
    '    Chars(95) = '_
    Chars(96) = ""
    Chars(97) = ""  'a
    Chars(98) = ""  'b
    Chars(99) = ""  'c
    Chars(100) = "" 'd
    Chars(101) = "" 'e
    Chars(102) = "" 'f
    Chars(103) = "" 'g
    Chars(104) = "" 'h
    Chars(105) = "" 'i
    Chars(106) = "" 'j
    Chars(107) = "" 'k
    Chars(108) = "" 'l
    Chars(109) = "" 'm
    Chars(110) = "" 'n
    Chars(111) = "" 'o
    Chars(112) = "" 'p
    Chars(113) = "" 'q
    Chars(114) = "" 'r
    Chars(115) = "" 's
    Chars(116) = "" 't
    Chars(117) = "" 'u
    Chars(118) = "" 'v
    Chars(119) = "" 'w
    Chars(120) = "" 'x
    Chars(121) = "" 'y
    Chars(122) = "" 'z
    Chars(123) = "" '{
    Chars(124) = "" '|
    Chars(125) = "" '}
    Chars(126) = "" '~
    'used in the FormatScore function
    Chars(176) = "d_0a" '0.
    Chars(177) = "d_1a" '1.
    Chars(178) = "d_2a" '2.
    Chars(179) = "d_3a" '3.
    Chars(180) = "d_4a" '4.
    Chars(181) = "d_5a" '5.
    Chars(182) = "d_6a" '6.
    Chars(183) = "d_7a" '7.
    Chars(184) = "d_8a" '8.
    Chars(185) = "d_9a" '9.
End Sub

'********************
' Real Time updates
'********************
'used for all the real time updates

Sub Realtime_Timer
	Cor.Update
    RollingUpdate
    ' add any other real time update subs, like gates or diverters, flippers
	MetalRamp.HeightBottom = MetalRamp_Flipper.CurrentAngle
	MetalRamp_Start.HeightBottom = MetalRamp_Flipper.CurrentAngle
	MetalRamp_Start.HeightTop = MetalRamp_Flipper.CurrentAngle + 6
	FlasherUpdate
	GIUpdate
End Sub

Sub FrameTimer_Timer
    LeftFlipperTop.RotZ = LeftFlipper.CurrentAngle
    RightFlipperTop2.RotZ = RightFlipper2.CurrentAngle
    RightFlipperTop.RotZ = RightFlipper.CurrentAngle
End Sub

'********************************************************************************************
' FlashForMs will blink light or a flasher for TotalPeriod(ms) at rate of BlinkPeriod(ms)
' When TotalPeriod done, light or flasher will be set to FinalState value where
' Final State values are:   0=Off, 1=On, 2=Return to previous State
'********************************************************************************************

Sub FlashForMs(MyLight, TotalPeriod, BlinkPeriod, FinalState) 'thanks gtxjoe for the first version

    If TypeName(MyLight) = "Light" Then

        If FinalState = 2 Then
            FinalState = MyLight.State 'Keep the current light state
        End If
        MyLight.BlinkInterval = BlinkPeriod
        MyLight.Duration 2, TotalPeriod, FinalState
    ElseIf TypeName(MyLight) = "Flasher" Then

        Dim steps
        ' Store all blink information
        steps = Int(TotalPeriod / BlinkPeriod + .5) 'Number of ON/OFF steps to perform
        If FinalState = 2 Then                      'Keep the current flasher state
            FinalState = ABS(MyLight.Visible)
        End If
        MyLight.UserValue = steps * 10 + FinalState 'Store # of blinks, and final state
        ' Start blink timer and create timer subroutine
        MyLight.TimerInterval = BlinkPeriod
        MyLight.TimerEnabled = 0
        MyLight.TimerEnabled = 1
        ExecuteGlobal "Sub " & MyLight.Name & "_Timer:" & "Dim tmp, steps, fstate:tmp=me.UserValue:fstate = tmp MOD 10:steps= tmp\10 -1:Me.Visible = steps MOD 2:me.UserValue = steps *10 + fstate:If Steps = 0 then Me.Visible = fstate:Me.TimerEnabled=0:End if:End Sub"
    End If
End Sub

'******************************************
' Change light color - simulate color leds
' changes the light color and state
' 11 colors: red, orange, amber, yellow...
'******************************************

'colors
Const red = 5
Const orange = 4
Const amber = 6
Const yellow = 3
Const darkgreen = 7
Const green = 2
Const blue = 1
Const darkblue = 8
Const purple = 9
Const white = 11
Const teal = 10

Sub SetLightColor(n, col, stat) 'stat 0 = off, 1 = on, 2 = blink, -1= no change
    Select Case col
        Case red
            n.color = RGB(18, 0, 0)
            n.colorfull = RGB(255, 0, 0)
        Case orange
            n.color = RGB(18, 3, 0)
            n.colorfull = RGB(255, 64, 0)
        Case amber
            n.color = RGB(193, 49, 0)
            n.colorfull = RGB(255, 153, 0)
        Case yellow
            n.color = RGB(18, 18, 0)
            n.colorfull = RGB(255, 255, 0)
        Case darkgreen
            n.color = RGB(0, 8, 0)
            n.colorfull = RGB(0, 64, 0)
        Case green
            n.color = RGB(0, 16, 0)
            n.colorfull = RGB(0, 128, 0)
        Case blue
            n.color = RGB(0, 18, 18)
            n.colorfull = RGB(0, 255, 255)
        Case darkblue
            n.color = RGB(0, 8, 8)
            n.colorfull = RGB(0, 64, 64)
        Case purple
            n.color = RGB(64, 0, 96)
            n.colorfull = RGB(128, 0, 192)
        Case white
            n.color = RGB(193, 91, 0)
            n.colorfull = RGB(255, 197, 143)
        Case teal
            n.color = RGB(1, 64, 62)
            n.colorfull = RGB(2, 128, 126)
    End Select
    If stat <> -1 Then
        n.State = 0
        n.State = stat
    End If
End Sub

Sub SetFlashColor(n, col, stat) 'stat 0 = off, 1 = on, -1= no change - no blink for the flashers, use FlashForMs
    Select Case col
        Case red
            n.color = RGB(255, 0, 0)
        Case orange
            n.color = RGB(255, 64, 0)
        Case amber
            n.color = RGB(255, 153, 0)
        Case yellow
            n.color = RGB(255, 255, 0)
        Case darkgreen
            n.color = RGB(0, 64, 0)
        Case green
            n.color = RGB(0, 128, 0)
        Case blue
            n.color = RGB(0, 255, 255)
        Case darkblue
            n.color = RGB(0, 64, 64)
        Case purple
            n.color = RGB(128, 0, 192)
        Case white
            n.color = RGB(255, 197, 143)
        Case teal
            n.color = RGB(2, 128, 126)
    End Select
    If stat <> -1 Then
        n.Visible = stat
    End If
End Sub

'*************************
' Rainbow Changing Lights
'*************************

Dim RGBStep, RGBFactor, rRed, rGreen, rBlue, RainbowLights

Sub StartRainbow(n) 'n is a collection
    set RainbowLights = n
    RGBStep = 0
    RGBFactor = 5
    rRed = 255
    rGreen = 0
    rBlue = 0
    RainbowTimer.Enabled = 1
End Sub

Sub StopRainbow()
    RainbowTimer.Enabled = 0
End Sub

Sub RainbowTimer_Timer 'rainbow led light color changing
    Dim obj
    Select Case RGBStep
        Case 0 'Green
            rGreen = rGreen + RGBFactor
            If rGreen > 255 then
                rGreen = 255
                RGBStep = 1
            End If
        Case 1 'Red
            rRed = rRed - RGBFactor
            If rRed < 0 then
                rRed = 0
                RGBStep = 2
            End If
        Case 2 'Blue
            rBlue = rBlue + RGBFactor
            If rBlue > 255 then
                rBlue = 255
                RGBStep = 3
            End If
        Case 3 'Green
            rGreen = rGreen - RGBFactor
            If rGreen < 0 then
                rGreen = 0
                RGBStep = 4
            End If
        Case 4 'Red
            rRed = rRed + RGBFactor
            If rRed > 255 then
                rRed = 255
                RGBStep = 5
            End If
        Case 5 'Blue
            rBlue = rBlue - RGBFactor
            If rBlue < 0 then
                rBlue = 0
                RGBStep = 0
            End If
    End Select
    For each obj in RainbowLights
        obj.color = RGB(rRed \ 10, rGreen \ 10, rBlue \ 10)
        obj.colorfull = RGB(rRed, rGreen, rBlue)
    Next
End Sub

' ********************************
'   Table info & Attract Mode
' ********************************

Sub ShowTableInfo
    Dim ii
    'info goes in a loop only stopped by the credits and the startkey
    If Score(1)Then
        DMD CL("LAST SCORE"), CL("PLAYER 1 " &FormatScore(Score(1))), "", eNone, eNone, eNone, 3000, False, ""
    End If
    If Score(2)Then
        DMD CL("LAST SCORE"), CL("PLAYER 2 " &FormatScore(Score(2))), "", eNone, eNone, eNone, 3000, False, ""
    End If
    If Score(3)Then
        DMD CL("LAST SCORE"), CL("PLAYER 3 " &FormatScore(Score(3))), "", eNone, eNone, eNone, 3000, False, ""
    End If
    If Score(4)Then
        DMD CL("LAST SCORE"), CL("PLAYER 4 " &FormatScore(Score(4))), "", eNone, eNone, eNone, 3000, False, ""
    End If
    DMD "", CL("GAME OVER"), "", eNone, eBlink, eNone, 2000, False, ""
    If bFreePlay Then
        DMD "", CL("FREE PLAY"), "", eNone, eBlink, eNone, 2000, False, ""
    Else
        If Credits > 0 Then
            DMD CL("CREDITS " & Credits), CL("PRESS START"), "", eNone, eBlink, eNone, 2000, False, ""
        Else
            DMD CL("CREDITS " & Credits), CL("INSERT COIN"), "", eNone, eBlink, eNone, 2000, False, ""
        End If
    End If
    DMD "        JPSALAS", "           AND", "d_jppresents", eNone, eNone, eNone, 3000, False, ""
    DMD " JOE PICASSO", "  PRESENTS", "d_joe", eNone, eNone, eNone, 3000, False, ""
    DMD "", "", "d_title", eNone, eNone, eNone, 4000, False, ""
    DMD "", "", "d_title2", eNone, eNone, eNone, 4000, False, ""
    DMD "", CL("ROM VERSION " &myversion), "", eNone, eNone, eNone, 2000, False, ""
    DMD CL("HIGHSCORES"), Space(20), "", eScrollLeft, eScrollLeft, eNone, 20, False, ""
    DMD CL("HIGHSCORES"), "", "", eBlinkFast, eNone, eNone, 1000, False, ""
    DMD CL("HIGHSCORES"), "1> " &HighScoreName(0) & " " &FormatScore(HighScore(0)), "", eNone, eScrollLeft, eNone, 2000, False, ""
    DMD "_", "2> " &HighScoreName(1) & " " &FormatScore(HighScore(1)), "", eNone, eScrollLeft, eNone, 2000, False, ""
    DMD "_", "3> " &HighScoreName(2) & " " &FormatScore(HighScore(2)), "", eNone, eScrollLeft, eNone, 2000, False, ""
    DMD "_", "4> " &HighScoreName(3) & " " &FormatScore(HighScore(3)), "", eNone, eScrollLeft, eNone, 2000, False, ""
    DMD Space(20), Space(20), "", eScrollLeft, eScrollLeft, eNone, 500, False, ""
End Sub

Sub StartAttractMode
    StartLightSeq
    StartRainbow aArrows
    DMDFlush
    ShowTableInfo
    'PlaySong "m_gameover"
	StopSong Song
	PlaySound "m_gameover", 0, SongVolume 'play it only once..
	cSlowAttCount = 0
	SlowAttractTimer.enabled = 1
	DOF 115, DOFon 'MX lights 
End Sub

dim cSlowAttCount
sub SlowAttractTimer_timer
	cSlowAttCount = cSlowAttCount + 1	'seconds
'	debug.print "seconds: " &  cSlowAttCount
	select case cSlowAttCount
		case 30: roachmove
		case 60 : PlaySound "vo_drain17"
		case 90: roachmove
		case 120: roachmove : PlaySound "vo_drain24"
		case 240: PlaySound "vo_taunt63"
		case 390: roachmove
		case 480: PlaySound "vo_taunt13"
		case 490: roachmove
		case 498: roachmove
		case 509: roachmove
		case 525: roachmove
		case 533: roachmove
		case 545: roachmove
		case 550: PlaySound "vo_taunt" &RndNbr(66)
		case 558: roachmove
		case 578: roachmove
		case 598: roachmove
		case 610: roachmove
		case 620: roachmove
		case 650: roachmove
		case 698: roachmove
		case 619: roachmove
		case 655: roachmove
		case 670: roachmove
		case 960: PlaySound "vo_wakeup1"
		case 1400: cSlowAttCount = 0
	end select

end sub

Sub StopAttractMode
	roachmoveTo 0
    DOF 115, DOFoff 'MX lights
	DOF 159, DOFon 'Undercab Green
	StopRainbow
	DMDScoreNow
	stopSound("m_gameover")
	SlowAttractTimer.enabled = 0 : cSlowAttCount = 0
    LightSeqAttract.StopPlay
End Sub

Sub StartLightSeq()
    'lights sequences
    LightSeqAttract.UpdateInterval = 40
    LightSeqAttract.Play SeqBlinking, , 5, 150
    LightSeqAttract.Play SeqRandom, 40, , 4000
    LightSeqAttract.Play SeqAllOff
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqCircleOutOn, 15, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 40, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 40, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqRightOn, 30, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqLeftOn, 30, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 15, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqCircleOutOn, 15, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 5
    LightSeqAttract.Play SeqStripe1VertOn, 50, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe1VertOn, 50, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe2VertOn, 50, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe1VertOn, 25, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe2VertOn, 25, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 15, 1
End Sub

Sub LightSeqAttract_PlayDone()
    StartLightSeq()
End Sub

Sub LightSeqTilt_PlayDone()
    LightSeqTilt.Play SeqAllOff
End Sub

Sub LightSeqTopFlashers_PlayDone()
    FlashEffect 7
End Sub

'***********************************************************************
' *********************************************************************
'                     Table Specific Script Starts Here
' *********************************************************************
'***********************************************************************

' droptargets, animations, timers, etc
Sub VPObjects_Init
    CapKicker1.CreateBall
    kickerpin.IsDropped = 1
	For each x in aBallGlow
       x.Visible = 0
    Next
    For each x in aBallGlow2
       x.Visible = 0
    Next
End Sub

' tables variables and Mode init
Dim Mode(4, 14) '4 players, 11 games modes, and 3 wizard modes.
Dim ModesWon(4)
Dim Arrows(10)  'the mode lights
Dim JackpotLight(10)
Dim SPJackpotLight(10)
Dim UpdateArrowsCount
Dim Balloons(4)      'balloons popped
Dim BumperHits(4)    'used for the bonus and to activate super bumpers
Dim OrbitHits(4)
Dim Children(4)      'number of children rescued
Dim Bullies(4)       'number of bullies defeated
Dim TopLanes(4, 3)   'top lights - bonus x
Dim LowerLanes(4, 4) 'lower lane lights - playfield x
Dim GeorgieLights(4, 7)
Dim FearLights(4, 4)
Dim FloatLights(4, 5)
Dim HorrorsLights(4, 7)
Dim BumperValue
Dim bRampIsUp
Dim MultiballType(4)
Dim bLocksEnabled
Dim AddABallHits(4)
Dim bAddABallReady
Dim EndModeCountdown

' Modes variables
Dim SpinCount1
Dim BumperHits2
Dim RampHits3
Dim OrbitHits4
Dim LightHits5
Dim LightHits6
Dim TargetHits7
Dim JackpotHits

Dim SpinsToCount1
Dim BumpersToHit2
Dim RampsToHit3
Dim OrbitsToHit4
Dim LightsToHit5
Dim LightsToHit6
Dim TargetsToHit7

Sub Game_Init() 'called at the start of a new game
    Dim i, j
    'Init Variables
    bExtraBallWonThisBall = False
    BallSaverTime = 20
    ComboCount = 0
    UpdateArrowsCount = 0
    BumperValue = 5000
    bRampIsUp = False
    bLocksEnabled = False
    bAddABallReady = False
    For i = 0 to 10
        Arrows(i) = 0
        JackpotLight(i) = 0
        SPJackpotLight(i) = 0
    Next
    For i = 0 to 4 'init players variables
    ComboHits(i) = 0
    ComboValue(i) = 100000
    BallsInLock(i) = 0
    Jackpot(i) = 100000
    SuperJackpot(i) = 500000
    ModesWon(i) = 0
    Balloons(i) = 0
    BumperHits(i) = 0
    OrbitHits(i) = 0
    Children(i) = 0
    Bullies(i) = 0
    MultiballType(i) = 0
    AddABallHits(i) = 0
    For j = 0 to 14:Mode(i, j) = 0:Next
    For j = 0 to 3:TopLanes(i, j) = 0:Next
    For j = 0 to 5:FloatLights(i, j) = 0:Next
        For j = 0 to 7
            GeorgieLights(i, j) = 0
            HorrorsLights(i, j) = 0
        Next
        For j = 0 to 4
            LowerLanes(i, j) = 0
            FearLights(i, j) = 0
        Next
    Next
    'Mode variables
    SpinsToCount1 = 50
    BumpersToHit2 = 20
    RampsToHit3 = 5
    OrbitsToHit4 = 5
    LightsToHit5 = 5
    LightsToHit6 = 5
    TargetsToHit7 = 8

    TurnOffPlayfieldLights()
    ' play a welcome Sound
'    PlaySound "start" &RndNbr(10)
End Sub

Sub InstantInfo
    Dim tmp
    DMD CL("INSTANT INFO"), "", "", eNone, eNone, eNone, 1000, False, ""
    'Show some info on the current Mode
    Select Case Mode(CurrentPlayer, 0)
        Case 1
            DMD CL("RESCUE EDDIE"), CL("SHOOT THE SPINNER"), "", eNone, eNone, eNone, 1500, True, ""
        Case 2
            DMD CL("RESCUE BEN"), CL("HIT THE POP BUMPERS"), "", eNone, eNone, eNone, 1500, True, ""
        Case 3
            DMD CL("RESCUE RICHIE"), CL("SHOOT THE RAMPS"), "", eNone, eNone, eNone, 1500, True, ""
        Case 4
            DMD CL("RESCUE BEVERLY"), CL("SHOOT THE ORBIT"), "", eNone, eNone, eNone, 1500, True, ""
        Case 5
            DMD CL("RESCUE STANLEY"), CL("SHOOT THE LIGHTS"), "", eNone, eNone, eNone, 1500, True, ""
        Case 6
            DMD CL("RESCUE MIKE"), CL("SHOOT THE LIGHTS"), "", eNone, eNone, eNone, 1500, True, ""
        Case 7
            DMD CL("RESCUE BILL"), CL("SHOOT THE TARGETS"), "", eNone, eNone, eNone, 1500, True, ""
        Case 8
            DMD CL("RUN FROM PATRICK"), CL("COMPLETE YELLOW BANK"), "", eNone, eBlink, eNone, 1500, True, ""
        Case 9
            DMD CL("RUN FROM BOWERS"), CL("COMPLETE GREEN BANK"), "", eNone, eBlink, eNone, 1500, True, ""
        Case 10
            DMD CL("RUN FROM BELCH"), CL("COMPLETE BLUE BANK"), "", eNone, eBlink, eNone, 1500, True, ""
        Case 11
            DMD CL("RUN FROM VICTOR"), CL("HIT A COMBO"), "", eNone, eNone, eNone, 1500, True, ""
        Case 12
            DMD CL("FIND PENNYWISE"), CL("SHOOT JACKPOTS"), "", eNone, eNone, eNone, 2000, True, ""
        Case 13
            DMD CL("FIGHT PENNYWISE"), CL("SHOOT JACKPOTS"), "", eNone, eNone, eNone, 2000, True, ""
        Case 14
            DMD CL("KILL PENNYWISE"), CL("SHOOT PENNYWISE"), "", eNone, eNone, eNone, 2000, True, ""
    End Select
    DMD CL("YOUR SCORE"), CL(FormatScore(Score(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
    DMD CL("PLAYFIELD MULTIPLIER"), CL("X " &PlayfieldMultiplier(CurrentPlayer)), "", eNone, eNone, eNone, 2000, False, ""
    DMD CL("BONUS MULTIPLIER"), CL("X " &BonusMultiplier(CurrentPlayer)), "", eNone, eNone, eNone, 2000, False, ""
    DMD CL("JACKPOT VALUE"), CL(FormatScore(Jackpot(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
    DMD CL("SUPER JACKPOT VALUE"), CL(FormatScore(SuperJackpot(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
    If Score(1)Then
        DMD CL("PLAYER 1 SCORE"), CL(FormatScore(Score(1))), "", eNone, eNone, eNone, 2000, False, ""
    End If
    If Score(2)Then
        DMD CL("PLAYER 2 SCORE"), CL(FormatScore(Score(2))), "", eNone, eNone, eNone, 2000, False, ""
    End If
    If Score(3)Then
        DMD CL("PLAYER 3 SCORE"), CL(FormatScore(Score(3))), "", eNone, eNone, eNone, 2000, False, ""
    End If
    If Score(4)Then
        DMD CL("PLAYER 4 SCORE"), CL(FormatScore(Score(4))), "", eNone, eNone, eNone, 2000, False, ""
    End If
End Sub

Sub StopMBmodes                                  'stop multiball modes after loosing the last multiball
    If Mode(CurrentPlayer, 0) > 11 Then StopMode 'wizard modes
    LightSeqTopFlashers.StopPlay
    RndJackpot.Enabled = 0
    RndSPJackpot.Enabled = 0
    ResetJackpots
    ResetSPJackpots
    ChangeGi white
    ChangeGIIntensity 1
    GiOn
    Stop_Fog
    BallsInLock(CurrentPlayer) = 0
    MultiballType(CurrentPlayer) = 0
    UpdateMBLights
    RiseTarget
    bMultiBallStarted = False
    aBallWhiteGlowing = False
    ChangeSong
	DOF 155, DOFoff 'Stop Georgie MX
	DOF 156, DOFoff 'Stop Fear MX
	DOF 157, DOFoff 'Stop Float MX
	DOF 158, DOFOff 'Stop Horror MX
	DOF 159, DOFon 'Start Undercab Green Up

	If VRRoom > 0 Then
		SpeakerColor = Default
		SpeakerChangeColor
	End If

End Sub

Sub StopEndOfBallMode() 'this sub is called after the last ball in play is drained, reset skillshot, modes, timers
    StopMode
	ResetJackpots
    ResetSPJackpots
End Sub

Sub ResetNewBallVariables() 'reset variables and lights for a new ball or player
    'turn on or off the needed lights before a new ball is released
    TurnOffPlayfieldLights
    'set up the lights according to the player achievments
    BumperValue = 5000
    BonusMultiplier(CurrentPlayer) = 1
    DecreasePlayfieldMultiplier
    RiseRamp
    RiseTarget
    bAddABallReady = False
    'update user lights
    UpdateModeLights
    UpdateLowerLaneLights
    UpdateTopLaneLights
    UpdateFearLights
    UpdateFloatLights
    UpdateGeorgieLights
    UpdateHorrorsLights
    UpdateMBLights
End Sub

Sub TurnOffPlayfieldLights()
    Dim a
    For each a in aLights
        a.State = 0
    Next
End Sub

Sub UpdateSkillShot() 'Setup and updates the skillshot lights
    LightSeqTilt.Play SeqAlloff
    LightSeqSkillshot.PLay SeqBlinking, , 50, 300
    DMD CL("HIT LIT LIGHT"), CL("FOR SKILLSHOT"), "", eNone, eNone, eNone, 3000, True, ""
End Sub

Sub ResetSkillShotTimer_Timer 'timer to reset the skillshot lights & variables
    ResetSkillShotTimer.Enabled = 0
    bSkillShotReady = False
    LightSeqSkillshot.StopPlay
    LightSeqIT.StopPlay
    DMDScoreNow
End Sub

' *********************************************************************
'                        Table Object Hit Events
'
' Any target hit Sub will follow this:
' - play a sound
' - do some physical movement
' - add a score, bonus
' - check some variables/Mode this trigger is a member of
' - set the "LastSwitchHit" variable in case it is needed later
' *********************************************************************

'*********************************************************
' Slingshots has been hit
' In this table the slingshots change the outlanes lights

Dim LStep, RStep, Lstep2

Sub LeftSlingShot_Slingshot
	LS.VelocityCorrect(ActiveBall)
    If Tilted Then Exit Sub
	RandomSoundSlingshotLeft Lemk
    DOF 106, DOFPulse 'DOF Solenoid/MX
    LeftSling004.Visible = 1
    Lemk.RotX = 26
    LStep = 0
    LeftSlingShot.TimerEnabled = True
    ' add some points
    AddScore 530
    ' check modes
    ' add some effect to the table?
    ' remember last trigger hit by the ball
    LastSwitchHit = "LeftSlingShot"
	if bCentipede And Roachloc = 2 then roachmove
End Sub

Sub LeftSlingShot_Timer
    Select Case LStep
        Case 1:LeftSLing004.Visible = 0:LeftSLing003.Visible = 1:Lemk.RotX = 14
        Case 2:LeftSLing003.Visible = 0:LeftSLing002.Visible = 1:Lemk.RotX = 2
        Case 3:LeftSLing002.Visible = 0:Lemk.RotX = -20:LeftSlingShot.TimerEnabled = 0
    End Select
    LStep = LStep + 1
End Sub

Sub RightSlingShot_Slingshot
	RS.VelocityCorrect(ActiveBall)
    If Tilted Then Exit Sub
	RandomSoundSlingshotRight Remk
	DOF 107, DOFPulse 'DOF Solenoid/MX
    RightSling004.Visible = 1
    Remk.RotX = 26
    RStep = 0
    RightSlingShot.TimerEnabled = True
    ' add some points
    AddScore 530
    ' check modes
    ' add some effect to the table?
    ' remember last trigger hit by the ball
    LastSwitchHit = "RightSlingShot"
	if bCentipede And Roachloc = 1 then roachmove
End Sub

Sub RightSlingShot_Timer
    Select Case RStep
        Case 1:RightSLing004.Visible = 0:RightSLing003.Visible = 1:Remk.RotX = 14
        Case 2:RightSLing003.Visible = 0:RightSLing002.Visible = 1:Remk.RotX = 2
        Case 3:RightSLing002.Visible = 0:Remk.RotX = -20:RightSlingShot.TimerEnabled = 0
    End Select
    RStep = RStep + 1
End Sub

Sub LeftSlingShot2_Slingshot
	RS.VelocityCorrect(ActiveBall)
    If Tilted Then Exit Sub
	RandomSoundSlingshotLeft Lemk2
    DOF 108, DOFPulse 'DOF Solenoid
    LeftSling008.Visible = 1
    Lemk2.RotX = 26
    LStep2 = 0
    LeftSlingShot2.TimerEnabled = True
    ' add some points
    AddScore 530
    ' check modes
    ' add some effect to the table?
    ' remember last trigger hit by the ball
    LastSwitchHit = "LeftSlingShot2"
End Sub

Sub LeftSlingShot2_Timer
    Select Case LStep2
        Case 1:LeftSLing008.Visible = 0:LeftSLing007.Visible = 1:Lemk2.RotX = 14
        Case 2:LeftSLing007.Visible = 0:LeftSLing008.Visible = 1:Lemk2.RotX = 2
        Case 3:LeftSLing008.Visible = 0:Lemk2.RotX = -20:LeftSlingShot2.TimerEnabled = 0
    End Select
    LStep2 = LStep2 + 1
End Sub
'***********************
'        Bumpers
'***********************

Sub Bumper1_Hit
    If Tilted Then Exit Sub
	DOF 103, Dofpulse 'DOF Solenoid 
    If bSkillShotReady Then ResetSkillShotTimer_Timer
	RandomSoundBumperTop Bumper1
    AddScore BumperValue
    BumperHits(CurrentPlayer) = BumperHits(CurrentPlayer) + 1
    CheckBumperHits
    ' check for modes
    Select Case Mode(CurrentPlayer, 0)
        Case 2:BumperHits2 = BumperHits2 + 1:CheckWinMode
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Bumper1"

	if VRRoom = 1 and VRStrobeTimer.enabled = false then VRBumperHitTimer.enabled = true  ' dont run it if the other strobe is running
	If B2SOn Then
        Controller.B2SSetData 50, 1
        vpmtimer.AddTimer 1000, " Controller.B2SSetData 50, 0 '"
      End If
End Sub

Sub Bumper2_Hit
    If Tilted Then Exit Sub
	DOF 104, Dofpulse 'DOF Solenoid 
    If bSkillShotReady Then ResetSkillShotTimer_Timer
	RandomSoundBumperMiddle Bumper2
    AddScore BumperValue
    BumperHits(CurrentPlayer) = BumperHits(CurrentPlayer) + 1
    CheckBumperHits
    ' check for modes
    Select Case Mode(CurrentPlayer, 0)
        Case 2:BumperHits2 = BumperHits2 + 1:CheckWinMode
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Bumper2"

	if VRRoom = 1 and VRStrobeTimer.enabled = false then VRBumperHitTimer.enabled = true  ' dont run it if the other strobe is running
	If B2SOn Then
        Controller.B2SSetData 51, 1
        vpmtimer.AddTimer 1000, " Controller.B2SSetData 51, 0 '"
      End If
End Sub

Sub Bumper3_Hit
    If Tilted Then Exit Sub
	DOF 105, Dofpulse 'DOF Solenoid 
    If bSkillShotReady Then ResetSkillShotTimer_Timer
	RandomSoundBumperBottom Bumper3
    AddScore BumperValue
    BumperHits(CurrentPlayer) = BumperHits(CurrentPlayer) + 1
    CheckBumperHits
    ' check for modes
    Select Case Mode(CurrentPlayer, 0)
        Case 2:BumperHits2 = BumperHits2 + 1:CheckWinMode
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Bumper3"

	if VRRoom = 1 and VRStrobeTimer.enabled = false then VRBumperHitTimer.enabled = true  ' dont run it if the other strobe is running
	If B2SOn Then
        Controller.B2SSetData 52, 1
        vpmtimer.AddTimer 1000, " Controller.B2SSetData 52, 0 '"
      End If
End Sub

Sub CheckBumperHits                'to enable superbumpers
    If BumperHits(CurrentPlayer)MOD 10 = 0 Then
        If BumperValue = 5000 Then 'turn on the bumper lights
            DMD CL("SUPER BUMPERS"), CL("ARE LIT"), "", eNone, eNone, eNone, 1500, True, ""
            BumperValue = 50000
            Lbumper1.State = 1
            Lbumper2.State = 1
            Lbumper3.State = 1
        End If
    End If
End Sub

'*********
' Lanes
'*********
' in and outlanes
Sub Trigger008_Hit
    If Tilted Then Exit Sub
	Dof 141, Dofpulse 'MX Outlane
    Addscore 5000
    LowerLanes(CurrentPLayer, 1) = 1
    UpdateLowerLaneLights
    CheckPlayfieldX
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger008"
End Sub

Sub Trigger007_Hit
    If Tilted Then Exit Sub
	Dof 142, Dofpulse 'MX Inlane
    If bSkillShotReady Then
        AwardSkillShot 200000
    Else
        Addscore 5000
        LowerLanes(CurrentPLayer, 2) = 1
        UpdateLowerLaneLights
        CheckPlayfieldX
    End If
End Sub

Sub Trigger006_Hit
    If Tilted Then Exit Sub
	Dof 142, Dofpulse 'MX Inlane
    Addscore 5000
    LowerLanes(CurrentPLayer, 3) = 1
    UpdateLowerLaneLights
    CheckPlayfieldX
End Sub

Sub Trigger005_Hit
    If Tilted Then Exit Sub
	Dof 141, Dofpulse 'MX Outlane
    Addscore 5000
    LowerLanes(CurrentPLayer, 4) = 1
    UpdateLowerLaneLights
    CheckPlayfieldX
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger005"
End Sub

Sub CheckPlayfieldX
    Dim i, tmp
    tmp = LowerLanes(CurrentPLayer, 1) + LowerLanes(CurrentPLayer, 2) + LowerLanes(CurrentPLayer, 3) + LowerLanes(CurrentPLayer, 4)
    If tmp = 4 Then
        AddPlayfieldMultiplier 1
        For i = 0 to 4
            LowerLanes(CurrentPLayer, i) = 0
        Next
        UpdateLowerLaneLights
    End If
End Sub

Sub UpdateLowerLaneLights
    li002.State = LowerLanes(CurrentPLayer, 1)
    li037.State = LowerLanes(CurrentPLayer, 2)
    li038.State = LowerLanes(CurrentPLayer, 3)
    li039.State = LowerLanes(CurrentPLayer, 4)
End Sub

'top lanes

Sub Trigger001_Hit
    If Tilted Then Exit Sub
    Addscore 5000
    TopLanes(CurrentPLayer, 1) = 1
    UpdateTopLaneLights
    CheckBonusX
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger001"
End Sub

Sub Trigger002_Hit
    If Tilted Then Exit Sub
    Addscore 5000
    TopLanes(CurrentPLayer, 2) = 1
    UpdateTopLaneLights
    CheckBonusX
    LastSwitchHit = "Trigger002"
End Sub

Sub Trigger003_Hit
    If Tilted Then Exit Sub
    Addscore 5000
    TopLanes(CurrentPLayer, 3) = 1
    UpdateTopLaneLights
    CheckBonusX
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger003"
End Sub

Sub CheckBonusX
    Dim i, tmp
    tmp = TopLanes(CurrentPLayer, 1) + TopLanes(CurrentPLayer, 2) + TopLanes(CurrentPLayer, 3)
    If tmp = 3 Then
        AddBonusMultiplier 1
        For i = 0 to 3
            TopLanes(CurrentPLayer, i) = 0
        Next
        UpdateTopLaneLights
    End If
End Sub

Sub UpdateTopLaneLights
    li040.State = TopLanes(CurrentPLayer, 1)
    li041.State = TopLanes(CurrentPLayer, 2)
    li042.State = TopLanes(CurrentPLayer, 3)
End Sub

' diverse lanes

Sub LeftGate_hit()
	If Activeball.velx > 1 Then
		StopSound "Arch_L1"
		StopSound "Arch_L2"
		StopSound "Arch_L3"
		StopSound "Arch_L4"
	Elseif Activeball.velx < -10 Then
		RandomSoundLeftArch
	End If
End Sub

Sub RightGate_hit()
	If Activeball.velx < -1 Then
		StopSound "Arch_R1"
		StopSound "Arch_R2"
		StopSound "Arch_R3"
		StopSound "Arch_R4"
	Elseif Activeball.velx > 10 Then
		RandomSoundRightArch
	End If
End Sub

Sub Trigger013_Hit
	If Activeball.vely < -10 Then
		RandomSoundRightArch
	Else
		StopSound "Arch_R1"
		StopSound "Arch_R2"
		StopSound "Arch_R3"
		StopSound "Arch_R4"
	End If

    If Tilted Then Exit Sub
    Addscore 5000
	If VRRoom > 0 Then
		VRBGFlashSewer2.enabled = 1
	End If
    ' activate magnet
    If activeBall.VelY > 0 Then ' ball going down
        TopMagnet.MagnetOn = True
        vpmTimer.AddTimer 2000, "TopMagnet.MagnetOn = False '"
        FlashForMs f3a, 1500, 50, 0
        FlashForMs f3b, 1500, 50, 0
        FlashForMs f3c, 1500, 50, 0
    End If
    'check for OrbitHits
    If LastSwitchHit = "Trigger011" Then
        OrbitHits(CurrentPlayer) = OrbitHits(CurrentPlayer) + 1
        FlashEffect 1
        If Mode(CurrentPlayer, 0) = 4 Then
            OrbitHits4 = OrbitHits4 + 1
            CheckWinMode
        End If
    End If
    'check for add-a-ball
    If bAddABallReady AND bMultiBallMode Then 'award add-a-ball but only if during multiball
        DMD "_", CL("ADD-A-BALL"), "", eNone, eBlink, eNone, 1500, True, ""
        bAddABallReady = False
        li059.State = 0
        LightEffect 1
        AddMultiball 1
    End If
    AddABallHits(CurrentPlayer) = (AddABallHits(CurrentPlayer) + 1)MOD 10
    If AddABallHits(CurrentPlayer) = 0 Then 'enable add-a-ball light
        DMD "_", CL("ADD-A-BALL IS LIT"), "", eNone, eBlink, eNone, 1500, True, ""
        bAddABallReady = True
        li059.State = 1
    End If
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(9)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(9)OR SPJackpotLight(9)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger013"
End Sub

Sub Trigger009_Hit
    If Tilted Then Exit Sub
    Addscore 5000
	If VRRoom > 0 Then
		VRBGFlashStanley.enabled = True
	End If
'    PlaySound "vo_greatshot" &RndNbr(5)
    PlaySound "vo_greatshot1"
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger009"
End Sub

Sub Trigger011_Hit
	RandomSoundLeftArch
    If Tilted Then Exit Sub
    Addscore 5000
	If VRRoom > 0 Then
		VRBGFlashSewer1.enabled = 1
	End If
    'check for OrbitHits
    If LastSwitchHit = "Trigger013" Then
        OrbitHits(CurrentPlayer) = OrbitHits(CurrentPlayer) + 1
        FlashEffect 1
        If Mode(CurrentPlayer, 0) = 4 Then
            OrbitHits4 = OrbitHits4 + 1
            CheckWinMode
        End If
    End If
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(2)Then
                Arrows(2) = 0
                li050.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(2)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(2)OR SPJackpotLight(2)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger011"
End Sub

' ramps

Sub Trigger004_Hit 'left Ramp
	WireRampOff ' Turn off the Plastic Ramp Sound
    If Tilted Then Exit Sub
	DOF 140, DOFPulse 'Strobe flash 
    Addscore 5000
	If VRRoom > 0 Then 
		VRBGFlashStanley.enabled = True
	End If
    'check for Combo
    If LastSwitchHit = "Trigger004" Then
        AwardCombo
        If Mode(CurrentPlayer, 0) = 11 Then
            CheckWinMode
        End If
    Else
        ComboCount = 0
    End If
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 3:RampHits3 = RampHits3 + 1:CheckWinMode
        Case 5
            If Arrows(2)Then
                Arrows(2) = 0
                li050.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(2)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(2)OR SPJackpotLight(2)Then
                CheckWinMode
            End If
    End Select
    ' ensure the lock is disabled during a MultiballType
    If bMultiBallMode Then Tlock.Enabled = 0
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger004"
End Sub

Sub Trigger004_unHit
	WireRampOn False ' On Wire Ramp, Play Wire Ramp Sound
End Sub

Sub Trigger012_Hit 'right ramp
	WireRampOn False
    If Tilted Then Exit Sub
	DOF 140, DOFPulse 'Strobes
    Addscore 5000
    'check for Combo
    If LastSwitchHit = "Trigger012" Then
        AwardCombo
        If Mode(CurrentPlayer, 0) = 11 Then
            CheckWinMode
        End If
    Else
        ComboCount = 0
    End If
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 3:RampHits3 = RampHits3 + 1:CheckWinMode
        Case 5
            If Arrows(8)Then
                Arrows(8) = 0
                li048.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(8)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(8)OR SPJackpotLight(8)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger012"
End Sub

Sub Trigger014_Hit 'IT ramp
    If Tilted Then Exit Sub
    Addscore 5000

	If VRRoom > 0 Then
		VRBGFlashStanley.enabled = True
	End If
    'check for Combo (it may only happen during a multiball in this )
    If LastSwitchHit = "Trigger014" Then
        AwardCombo
        If Mode(CurrentPlayer, 0) = 11 Then
            CheckWinMode
        End If
    Else
        ComboCount = 0
    End If
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 3:RampHits3 = RampHits3 + 1:CheckWinMode
        Case 6
            If Arrows(3)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(3)OR SPJackpotLight(3)Then
                CheckWinMode
            End If
    End Select
    ' ensure the lock is disabled during a MultiballType
    If bMultiBallMode Then Clock.Enabled = 0
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger014"
	WireRampOff
End Sub

Sub Trigger014_unHit
	WireRampOn False
End Sub

Sub Trigger015_Hit 'center ramp
	WireRampOn False
    If Tilted Then Exit Sub
    Addscore 5000
    'check for Combo
    If LastSwitchHit = "Trigger015" Then
        AwardCombo
        If Mode(CurrentPlayer, 0) = 11 Then
            CheckWinMode
        End If
    Else
        ComboCount = 0
    End If
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 3:RampHits3 = RampHits3 + 1:CheckWinMode
        Case 6
            If Arrows(6)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(6)OR SPJackpotLight(6)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Trigger015"
End Sub

Sub Trigger016_Hit 'to release balls stuck under the ramp
	If Activeball.vely < -10 Then
		RandomSoundLeftArch
	Else
		StopSound "Arch_L1"
		StopSound "Arch_L2"
		StopSound "Arch_L3"
		StopSound "Arch_L4"
	End If
    Me.TimerEnabled = 1
End Sub

Sub Trigger016_UnHit 'to release balls stuck under the ramp
    Me.TimerEnabled = 0
End Sub

Sub Trigger016_Timer 'to release balls stuck under the ramp
    Me.TimerEnabled = 0
    RiseRamp
End Sub

'***********
' Targets
'***********
' Georgie yellow left targets
Sub Target010_Hit
    If Tilted Then Exit Sub
	DOF 160, DOFpulse 'Georgie Flasher
    Addscore 5000
    PlayElectro
    GeorgieLights(CurrentPlayer, 1) = 1
    CheckGeorgieLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(1)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(1)OR SPJackpotLight(1)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target010"
End Sub

Sub Target011_Hit
    If Tilted Then Exit Sub
	DOF 160, DOFpulse 'Georgie Flasher
    Addscore 5000
    PlayElectro
    GeorgieLights(CurrentPlayer, 2) = 1
    CheckGeorgieLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(1)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(1)OR SPJackpotLight(1)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target011"
End Sub

Sub Target012_Hit
    If Tilted Then Exit Sub
	DOF 160, DOFpulse 'Georgie Flasher
    Addscore 5000
    PlayElectro
    GeorgieLights(CurrentPlayer, 3) = 1
    CheckGeorgieLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(1)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(1)OR SPJackpotLight(1)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target012"
End Sub

Sub Target013_Hit
    If Tilted Then Exit Sub
	DOF 160, DOFpulse 'Georgie Flasher
    Addscore 5000
    PlayElectro
    GeorgieLights(CurrentPlayer, 4) = 1
    CheckGeorgieLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(1)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(1)OR SPJackpotLight(1)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target013"
End Sub

Sub Target014_Hit
    If Tilted Then Exit Sub
	DOF 160, DOFpulse 'Georgie Flasher
    Addscore 5000
    PlayElectro
    GeorgieLights(CurrentPlayer, 5) = 1
    CheckGeorgieLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(1)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(1)OR SPJackpotLight(1)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target014"
End Sub

Sub Target015_Hit
    If Tilted Then Exit Sub
	DOF 160, DOFpulse 'Georgie Flasher
    Addscore 5000
    PlayElectro
    GeorgieLights(CurrentPlayer, 6) = 1
    CheckGeorgieLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(1)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(1)OR SPJackpotLight(1)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target015"
End Sub

Sub Target016_Hit
    If Tilted Then Exit Sub
	DOF 160, DOFpulse 'Georgie Flasher
    Addscore 5000
    PlayElectro
    GeorgieLights(CurrentPlayer, 7) = 1
    CheckGeorgieLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(1)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(1)OR SPJackpotLight(1)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target016"
End Sub

Sub GeorgieTargets_Hit(idx)
	PlayTargetSound
	TargetBouncer Activeball, 1
    LeftMagnet.MagnetOn = True
    vpmTimer.AddTimer 1000, " LeftMagnet.MagnetOn = False '"
End Sub

Sub CheckGeorgieLights
	'select Georgie MB
	MultiballType(CurrentPlayer) = 1
	UpdateMBLights
	Dim i, tmp
	tmp = 0
	For i = 1 to 7
		tmp = tmp + GeorgieLights(CurrentPlayer, i)
	Next
	If tmp = 7 Then
		For i = 1 to 7
			GeorgieLights(CurrentPlayer, i) = 0
		Next
		GiEffect 3
		AwardJackpot
		' check modes
		Select Case Mode(CurrentPlayer, 0)
			Case 8:CheckWinMode
		End Select
	End If
	UpdateGeorgieLights
End Sub

Sub UpdateMBLights
    Select Case MultiballType(CurrentPlayer)
        Case 0:f10.State = 0:f9.State = 0:f8.State = 0:f7.State = 0
        Case 1:f10.State = 1:f9.State = 0:f8.State = 0:f7.State = 0
        Case 2:f10.State = 0:f9.State = 1:f8.State = 0:f7.State = 0
        Case 3:f10.State = 0:f9.State = 0:f8.State = 1:f7.State = 0
        Case 4:f10.State = 0:f9.State = 0:f8.State = 0:f7.State = 1
    End Select
End Sub

Sub UpdateGeorgieLights
    li021.State = GeorgieLights(CurrentPlayer, 1)
    li022.State = GeorgieLights(CurrentPlayer, 2)
    li023.State = GeorgieLights(CurrentPlayer, 3)
    li024.State = GeorgieLights(CurrentPlayer, 4)
    li025.State = GeorgieLights(CurrentPlayer, 5)
    li026.State = GeorgieLights(CurrentPlayer, 6)
    li027.State = GeorgieLights(CurrentPlayer, 7)
End Sub

'fear blue right targets

Sub Target018_Hit
    If Tilted Then Exit Sub
	DOF 161, DOFpulse 'Fear Flasher
    Addscore 5000
    PlayElectro
    FearLights(CurrentPlayer, 1) = 1
    CheckFearLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(10)Then
                Arrows(10) = 0
                li062.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(10)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(10)OR SPJackpotLight(10)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target018"
End Sub

Sub Target019_Hit
    If Tilted Then Exit Sub
	DOF 161, DOFpulse 'Fear Flasher
    Addscore 5000
    PlayElectro
    FearLights(CurrentPlayer, 2) = 1
    CheckFearLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(10)Then
                Arrows(10) = 0
                li062.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(10)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(10)OR SPJackpotLight(10)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target019"
End Sub

Sub Target020_Hit
    If Tilted Then Exit Sub
	DOF 161, DOFpulse 'Fear Flasher
    Addscore 5000
    PlayElectro
    FearLights(CurrentPlayer, 3) = 1
    CheckFearLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(10)Then
                Arrows(10) = 0
                li062.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(10)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(10)OR SPJackpotLight(10)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target020"
End Sub

Sub Target021_Hit
    If Tilted Then Exit Sub
	DOF 161, DOFpulse 'Fear Flasher
    Addscore 5000
    PlayElectro
    FearLights(CurrentPlayer, 4) = 1
    CheckFearLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(10)Then
                Arrows(10) = 0
                li062.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(10)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(10)OR SPJackpotLight(10)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target021"
End Sub

Sub FearTargets_Hit(idx)
	PlayTargetSound
	TargetBouncer Activeball, 1
    RightMagnet.MagnetOn = True
    vpmTimer.AddTimer 1000, " RightMagnet.MagnetOn = False '"
End Sub

Sub CheckFearLights
    'select Fear MB
    MultiballType(CurrentPlayer) = 2
    UpdateMBLights
    Dim i, tmp
    tmp = 0
    For i = 1 to 4
        tmp = tmp + FearLights(CurrentPlayer, i)
    Next
    If tmp = 4 Then
        For i = 1 to 4
            FearLights(CurrentPlayer, i) = 0
        Next
        GiEffect 3
        AwardJackpot
        ' check modes
        Select Case Mode(CurrentPlayer, 0)
            Case 10:CheckWinMode
        End Select
    End If
    UpdateFearLights
End Sub

Sub UpdateFearLights
    li028.State = FearLights(CurrentPlayer, 1)
    li029.State = FearLights(CurrentPlayer, 2)
    li030.State = FearLights(CurrentPlayer, 3)
    li031.State = FearLights(CurrentPlayer, 4)
End Sub

' float green center targets
Sub FloatTargets_Hit(idx)
	PlayTargetSound
	TargetBouncer Activeball, 1
End Sub

Sub Target002_Hit
    If Tilted Then Exit Sub
	DOF 162, DOFpulse 'Float Flasher
    Addscore 5000
    FloatLights(CurrentPlayer, 1) = 1
    CheckFloatLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(7)Then
                Arrows(7) = 0
                li061.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(7)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(7)OR SPJackpotLight(7)Then
                CheckWinMode
            End If
    End Select

    ' remember last trigger hit by the ball
    LastSwitchHit = "Target002"
End Sub

Sub Target003_Hit
    If Tilted Then Exit Sub
	DOF 162, DOFpulse 'Float Flasher
    Addscore 5000
    FloatLights(CurrentPlayer, 2) = 1
    CheckFloatLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(7)Then
                Arrows(7) = 0
                li061.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(7)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(7)OR SPJackpotLight(7)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target003"
End Sub

Sub Target004_Hit
    If Tilted Then Exit Sub
	DOF 162, DOFpulse 'Float Flasher
    Addscore 5000
    FloatLights(CurrentPlayer, 3) = 1
    CheckFloatLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(7)Then
                Arrows(7) = 0
                li061.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(7)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(7)OR SPJackpotLight(7)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target004"
End Sub

Sub Target005_Hit
    If Tilted Then Exit Sub
	DOF 162, DOFpulse 'Float Flasher
    Addscore 5000
    FloatLights(CurrentPlayer, 4) = 1
    CheckFloatLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(7)Then
                Arrows(7) = 0
                li061.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(7)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(7)OR SPJackpotLight(7)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target005"
End Sub

Sub Target006_Hit
    If Tilted Then Exit Sub
	DOF 162, DOFpulse 'Float Flasher
    Addscore 5000
    FloatLights(CurrentPlayer, 5) = 1
    CheckFloatLights
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(7)Then
                Arrows(7) = 0
                li061.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(7)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 7
            TargetHits7 = TargetHits7 + 1
            CheckWinMode
        Case 12, 13, 14
            If JackpotLight(7)OR SPJackpotLight(7)Then
                CheckWinMode
            End If
    End Select
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target006"
End Sub

Sub CheckFloatLights
    'select Georgie MB
    MultiballType(CurrentPlayer) = 3
    UpdateMBLights
    Dim i, tmp
    tmp = 0
    For i = 1 to 5
        tmp = tmp + FloatLights(CurrentPlayer, i)
    Next
    If tmp = 5 Then
        For i = 1 to 5
            FloatLights(CurrentPlayer, i) = 0
        Next
        GiEffect 3
        AwardJackpot
        ' check modes
        Select Case Mode(CurrentPlayer, 0)
            Case 9:CheckWinMode
        End Select
    End If
    UpdateFloatLights
End Sub

Sub UpdateFloatLights
    li032.State = FloatLights(CurrentPlayer, 1)
    li033.State = FloatLights(CurrentPlayer, 2)
    li034.State = FloatLights(CurrentPlayer, 3)
    li035.State = FloatLights(CurrentPlayer, 4)
    li036.State = FloatLights(CurrentPlayer, 5)
End Sub

'Newton Ball

Sub CapWall1_Hit 'balloon pop
    If Tilted Then Exit Sub
    PlaySound "sfx_balloon", 0, 1
    balloon.Visible = 0
    Balloons(CurrentPlayer) = Balloons(CurrentPlayer) + 1
    vpmTimer.AddTimer 2000, "balloon.visible = 1 '"
    Addscore 25000
    FlashEffect 3
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 6
            If Arrows(4)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(4)OR SPJackpotLight(4)Then
                CheckWinMode
            End If
    End Select
End Sub

' horrors red targets

Sub Target023_Hit
    If Tilted Then Exit Sub
    Addscore 5000
    PlayThunder
    HorrorsLights(CurrentPlayer, 1) = 1
    CheckHorrorsLights
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target023"
End Sub

Sub Target022_Hit
    If Tilted Then Exit Sub
    If bSkillShotReady Then
        AwardSkillShot 750000
    Else
        Addscore 5000
        PlayThunder
        HorrorsLights(CurrentPlayer, 2) = 1
        CheckHorrorsLights
    End If
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target022"
End Sub

Sub Target017_Hit
    If Tilted Then Exit Sub
    Addscore 5000
    PlayThunder
    HorrorsLights(CurrentPlayer, 3) = 1
    CheckHorrorsLights
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target017"
End Sub

Sub Target008_Hit
    If Tilted Then Exit Sub
	if bCentipede And Roachloc = 0 then roachmove
    Addscore 5000
    PlayThunder
    HorrorsLights(CurrentPlayer, 4) = 1
    CheckHorrorsLights
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target008"
End Sub

Sub Target007_Hit
    If Tilted Then Exit Sub
    Addscore 5000
    PlayThunder
    HorrorsLights(CurrentPlayer, 5) = 1
    CheckHorrorsLights
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target007"
End Sub

Sub Target024_Hit
    If Tilted Then Exit Sub
    Addscore 5000
    PlayThunder
    HorrorsLights(CurrentPlayer, 6) = 1
    CheckHorrorsLights
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target024"
End Sub

Sub Target001_Hit
    If Tilted Then Exit Sub
    If bSkillshotReady Then
        AwardSkillShot 80000
    Else
        Addscore 5000
        PlayThunder
        HorrorsLights(CurrentPlayer, 7) = 1
        CheckHorrorsLights
    End If
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target001"
End Sub

Sub HorrorsTargets_Hit(idx)
	PlayTargetSound
	TargetBouncer Activeball, 1
End Sub

Sub CheckHorrorsLights
	'select Horrors MB
	MultiballType(CurrentPlayer) = 4
	UpdateMBLights
	Dim i, tmp
	tmp = 0
	For i = 1 to 7
	tmp = tmp + HorrorsLights(CurrentPlayer, i)
	Next
	If tmp = 7 Then
		For i = 1 to 7
			HorrorsLights(CurrentPlayer, i) = 0
		Next
		GiEffect 3
		AwardJackpot
	End If
	UpdateHorrorsLights
End Sub

Sub UpdateHorrorsLights
    li014.State = HorrorsLights(CurrentPlayer, 1)
    li016.State = HorrorsLights(CurrentPlayer, 2)
    li015.State = HorrorsLights(CurrentPlayer, 3)
    li017.State = HorrorsLights(CurrentPlayer, 4)
    li018.State = HorrorsLights(CurrentPlayer, 5)
    li020.State = HorrorsLights(CurrentPlayer, 6)
    li019.State = HorrorsLights(CurrentPlayer, 7)
End Sub

' Droptarget

Sub Target009_Hit
	SoundDropTargetDrop Target009
    DOF 104, Dofpulse
    If Tilted Then Exit Sub
    Addscore 5000
    ' enable center ramp lock
    DMD "_", CL("LOCK IS LIT"), "", eNone, eNone, eNone, 1500, True, "vo_lockislit" &RndNbr(6)
    li060.State = 1
    li064.State = 1
    Tlock.Enabled = 1
    Clock.Enabled = 1
    bLocksEnabled = True
    LowerRamp
    ' remember last trigger hit by the ball
    LastSwitchHit = "Target009"
End Sub

Sub RiseTarget
	RandomSoundDropTargetReset Target009
    DOF 104, Dofpulse
    Target009.IsDropped = 0
    ' disable ramp locks
    li060.State = 0
    Clock.Enabled = 0
    li064.State = 0
    Tlock.Enabled = 0
    bLocksEnabled = False
End Sub

'***********
'  Spinner
'***********

Sub Spinner_Spin
    If Tilted Then Exit Sub
    'Addscore spinnervalue(CurrentPlayer)
	SoundSpinner spinner
    DOF 136, DOFPulse
    Select Case Mode(CurrentPlayer, 0)
        Case 1
            Addscore 3000
            SpinCount1 = SpinCount1 + 1
            CheckWinMode
    End Select
End Sub

'*********
' scoop
'*********
' used to start Modes

Sub Scoopin_Hit
	SoundSaucerLock
    Scoopin.Destroyball
    BallsinHole = BallsInHole + 1
    If Tilted Then vpmtimer.addtimer 500, "kickBallOut '":Exit Sub
    If bSkillShotReady Then
        AwardSkillShot 200000
    Else
        Addscore 5000
        ' check modes
        Select Case Mode(CurrentPlayer, 0)
            Case 0 'no mode active so start a Mode
                SelectMode
            Case Else
                'rise or lower ramp
                If bRampIsUp Then
                    LowerRamp
                Else
                    RiseRamp
                End If
        End Select
    End If
	if bCentipede And Roachloc = 0 then roachmove
    ' Nothing left to do, so kick out the ball
    vpmtimer.addtimer 1500, "kickBallOut '"

End Sub

Sub Tophole_Hit
	SoundSaucerLock
    Tophole.Destroyball
    BallsinHole = BallsInHole + 1
    If Tilted Then vpmtimer.addtimer 500, "kickBallOut '":Exit Sub
    PlaySound "vo_taunt" &RndNbr(66)
    FlashEffect 8
    If bSkillShotReady Then ResetSkillShotTimer_Timer
    Addscore 5000
	If VRRoom > 0 Then
		VRBGstepIT = 4
		VRBGFlashIT.enabled = True
	End If
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 5
            If Arrows(5)Then
                Arrows(5) = 0
                li045.State = 0
                LightHits5 = LightHits5 + 1
                CheckWinMode
            End If
        Case 6
            If Arrows(5)Then
                LightHits6 = LightHits6 + 1
                CheckWinMode
            End If
        Case 12, 13, 14
            If JackpotLight(5)OR SPJackpotLight(5)Then
                CheckWinMode
            End If
        Case Else
            If JackpotLight(5)Then
                AwardJackpot
                If Mode(CurrentPlayer, 0) = 0 Then
                    SuperJackpotTimer_Timer
                End If
            End If
            If SPJackpotLight(5)Then
                AwardSuperJackpot
                If Mode(CurrentPlayer, 0) = 0 Then
                    SuperJackpotTimer_Timer
                End If
            End If
    End Select
    ' Nothing left to do, so kick out the ball
    vpmtimer.addtimer 1500, "kickBallOut '"
End Sub

Sub kickBallOut 'from all the holes
    If BallsinHole > 0 Then
        BallsinHole = BallsInHole - 1
		SoundSaucerKick 1, ScoopExit
        DOF 130, DOFPulse
        ScoopExit.CreateSizedBallWithMass BallSize / 2, BallMass
        ScoopExit.kick 160, 22
        If bEnableBloodTrails Then BloodBall 1
        LightEffect 5
        FlashForMs f4a, 1500, 50, 0
        FlashForMs f4b, 1500, 50, 0
        vpmtimer.addtimer 1500, "kickBallOut '" 'kick out the rest of the balls, if any
    End If
End Sub

Sub VUK_Hit
    SoundSaucerLock
    If Tilted Then vpmtimer.addtimer 500, "VukExit '":Exit Sub
    FlashEffect 2
    If bSkillShotReady Then ResetSkillShotTimer_Timer
    Addscore 5000
    ' check modes
    Select Case Mode(CurrentPlayer, 0)
        Case 12, 13, 14
            If JackpotLight(6)OR SPJackpotLight(6)Then
                CheckWinMode
            End If
    End Select
    ' award extra ball
    If li044.State Then
        AwardExtraBall
        li044.State = 0
    End If
    ' Nothing to do, so kick out the ball
    vpmtimer.addtimer 1500, "VukExit '"
End Sub

Sub VukExit
	SoundSaucerKick 1, vuk
    DOF 130, DOFPulse
'	Vuk.kick 180, 55, 1.4
	Vuk.kick 180, 60, 80
    kickerpin.IsDropped = 0:kickerpin.TimerEnabled = 1
    LightEffect 5
End Sub

Sub kickerpin_Timer:kickerpin.TimerEnabled = 0:kickerpin.IsDropped = 1:End Sub

'**************
' Metal Ramp
'**************

Sub RiseRamp
    MetalRamp_Flipper.RotateToEnd
    MetalRamp_invisible.Collidable = 0
	RampTrigger001.Enabled=False
    LeftGate.Open = True
    RightGate.Open = True
    bRampIsUp = True
    'disable top lock
    li064.State = 0
'Tlock.Enabled = 0
End Sub

Sub LowerRamp
    MetalRamp_Flipper.RotateToStart
    MetalRamp_invisible.Collidable = 1
	RampTrigger001.Enabled=True
    LeftGate.Open = False
    RightGate.Open = False
    bRampIsUp = False
    'enable top lock
    If bLocksEnabled Then
        li064.State = 1
        Tlock.Enabled = 1
    Else
        li064.State = 0
        Tlock.Enabled = 0
    End If
End Sub

'********************************
' Boat, Hand & Balloon animation
'********************************

Dim MyPi, BoatStep, BoatDir, BalloonStep, BalloonDir
MyPi = Round(4 * Atn(1), 6) / 90
BoatStep = 0
BalloonStep = 0

Sub BoatTimer_Timer()
    BoatDir = SIN(BoatStep * MyPi)
    BoatStep = (BoatStep + 1)MOD 360
    Boat.Y = Boat.Y + BoatDir * 4
End Sub

Sub BalloonTimer_Timer()
    BalloonDir = SIN(BalloonStep * MyPi)
    BalloonStep = (BalloonStep + 1)MOD 360
    Balloon.Z = Balloon.Z + BalloonDir * 0.9
    hand.roty = hand.roty + BalloonDir * 0.3
    hand.rotx = hand.rotx + BalloonDir * 0.3
End Sub

'********
'  FOG
'********

Dim fr, fh, fopac 'rotation and height

Sub Start_Fog
    fr = 0
    fh = 2
    fopac = 0.005
    fog_flash.visible = 1
    fog_flash.IntensityScale = 0
    fog_flash.Timerenabled = 1
End Sub

Sub fog_flash_Timer
    'rotation
    fr = fr + 0.125
    If fr > 360 Then fr = 0
    fog_flash.RotZ = fr
    'height
    If fh < 52 Then
        fh = fh + 0.125
        fog_flash.height = fh
    End If
    ' opacity
    If fopac > 0 then
        If fog_flash.IntensityScale < 1 then
            fog_flash.IntensityScale = fog_flash.IntensityScale + fopac
        End If
    End If
    If fopac < 0 Then
        fog_flash.IntensityScale = fog_flash.IntensityScale + fopac
        If fog_flash.IntensityScale < 0 Then
            fog_flash.Timerenabled = 0
        End If
    End If
End Sub

Sub Stop_Fog
    fopac = -0.01
End Sub

'********************************
' Modes - Rescue or evasion modes
'********************************
' 7 childs to rescue, 4 evasion modes and 1 wizard mode
' every 4 modes won you get to fight Pennywise, the wizard mode

Sub SelectMode                         'select a children to rescue or to run from, called from the scoop
    Dim i, tmp
    If Mode(CurrentPlayer, 0) = 0 Then 'no mode active so select one
        LightSeqBalloons.Play SeqRandom, 50, , 1000
        ' reset the modes that are not finished so they can be played again
        For i = 1 to 14
            If Mode(CurrentPlayer, i) = 2 Then Mode(CurrentPlayer, i) = 0
        Next
        ' choose a mode at random
        tmp = RndNbr(11)
        do while Mode(CurrentPlayer, tmp) <> 0
            tmp = RndNbr(11)
        loop
        Mode(CurrentPlayer, tmp) = 2
        Mode(CurrentPlayer, 0) = tmp
        UpdateModeLights
        StartMode
    End If
    vpmtimer.addtimer 1500, "kickBallOut '"
End Sub

Sub SelectModeManually(modenr) 'select manually a mod - mostly for debuggingm but also used to start the wizard modes
    Dim i
    LightSeqBalloons.Play SeqRandom, 50, , 1000
    For i = 1 to 14
        If Mode(CurrentPlayer, i) = 2 Then Mode(CurrentPlayer, i) = 0
    Next
    Mode(CurrentPlayer, modenr) = 2
    Mode(CurrentPlayer, 0) = modenr
    UpdateModeLights
    StartMode
End Sub

' Update the lights according to the Mode's state
' 0-off-stopped or not started, 1-on-finished, 2-blinking-started
Sub UpdateModeLights                      'children faces
    li003.State = Mode(CurrentPlayer, 1)  'Eddie
    li008.State = Mode(CurrentPlayer, 2)  'Ben
    li009.State = Mode(CurrentPlayer, 3)  'Richie
    li006.State = Mode(CurrentPlayer, 4)  'Beverly
    li007.State = Mode(CurrentPlayer, 5)  'Stanley
    li005.State = Mode(CurrentPlayer, 6)  'Mike
    li004.State = Mode(CurrentPlayer, 7)  'Bill
    li010.State = Mode(CurrentPlayer, 8)  'Patrick
    li011.State = Mode(CurrentPlayer, 9)  'Bowers
    li012.State = Mode(CurrentPlayer, 10) 'Belch
    li013.State = Mode(CurrentPlayer, 11) 'Victor
End Sub

' Starting a mode means to setup some lights and variables, maybe timers
' Mode lights will always blink during an active mode
Sub StartMode
    ChangeSong
    EnableBallsaver 15       'start a 15 seconds ball saver
    ResetArrows
    UpdateArrows.Enabled = 1 'make sure it is started
    Select Case Mode(CurrentPlayer, 0)
        Case 1               'Eddie
            DMD CL("RESCUE EDDIE"), CL("SHOOT THE SPINNER"), "", eNone, eNone, eNone, 3500, True, "vo_saveeddie"
            DMD CL("RESCUE EDDIE"), CL("SHOOT THE SPINNER"), "", eNone, eNone, eNone, 1500, True, "vo_shootspinner"
            Arrows(9) = 2
            SpinCount1 = 0
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 2 'Ben
            DMD CL("RESCUE BEN"), CL("HIT THE POP BUMPERS"), "", eNone, eNone, eNone, 3500, True, "vo_taunt34"
            DMD CL("RESCUE BEN"), CL("HIT THE POP BUMPERS"), "", eNone, eNone, eNone, 1500, True, "vo_shootbumpers" &RndNbr(2)
            RiseRamp
            li058.State = 2
            Lbumper1.State = 2
            Lbumper2.State = 2
            Lbumper3.State = 2
            BumperHits2 = 0
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 3 'Richie
            DMD CL("RESCUE RICHIE"), CL("SHOOT THE RAMPS"), "", eNone, eNone, eNone, 2500, True, "vo_taunt23"
            DMD CL("RESCUE RICHIE"), CL("SHOOT THE RAMPS"), "", eNone, eNone, eNone, 1500, True, "vo_shootramps"
            LowerRamp
            Arrows(2) = 2
            Arrows(3) = 2
            Arrows(6) = 2
            Arrows(8) = 2
            RampHits3 = 0
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 4 'Beverly
            DMD CL("RESCUE BEVERLY"), CL("SHOOT THE ORBIT"), "", eNone, eNone, eNone, 2500, True, "vo_taunt20"
            DMD CL("RESCUE BEVERLY"), CL("SHOOT THE ORBIT"), "", eNone, eNone, eNone, 1500, True, "vo_shootorbits"
            RiseRamp
            Arrows(2) = 2
            Arrows(9) = 2
            OrbitHits4 = 0
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 5 'Stanley
            Select Case RndNbr(2)
                Case 1:DMD CL("RESCUE STANLEY"), CL("SHOOT THE LIGHTS"), "", eNone, eNone, eNone, 2500, True, "vo_savestanley"
                Case 2:DMD CL("RESCUE STANLEY"), CL("SHOOT THE LIGHTS"), "", eNone, eNone, eNone, 8000, True, "vo_savestanley2"
            End Select
            DMD CL("RESCUE STANLEY"), CL("SHOOT THE LIGHTS"), "", eNone, eNone, eNone, 1500, True, "vo_shootlights"
            LowerRamp
            Arrows(2) = 2
            Arrows(5) = 2
            Arrows(7) = 2
            Arrows(8) = 2
            Arrows(10) = 2
            LightHits5 = 0
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 6 'Mike - shoot lights one at a time
            DMD CL("RESCUE MIKE"), CL("SHOOT THE LIGHTS"), "", eNone, eNone, eNone, 2000, True, "vo_savemike"
            DMD CL("RESCUE MIKE"), CL("SHOOT THE LIGHTS"), "", eNone, eNone, eNone, 1500, True, "vo_shootlights"
            Arrows(RndNbr(10)) = 2
            LightHits6 = 0
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 7 'Bill
            DMD CL("RESCUE BILL"), CL("SHOOT THE TARGETS"), "", eNone, eNone, eNone, 2000, True, "vo_savebill"
            DMD CL("RESCUE BILL"), CL("SHOOT THE TARGETS"), "", eNone, eNone, eNone, 1500, True, "vo_shootlights"
            Arrows(1) = 2
            Arrows(7) = 2
            Arrows(10) = 2
            TargetHits7 = 0
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        ' Evasion modes
        Case 8 'Patrick
            DMD CL("RUN FROM PATRICK"), CL("COMPLETE YELLOW BANK"), "", eNone, eNone, eNone, 2500, True, "vo_runpatrick"
            DMD CL("RUN FROM PATRICK"), CL("COMPLETE YELLOW BANK"), "", eNone, eBlink, eNone, 1500, True, "vo_shootyellowtargets"
            Arrows(1) = 2
            EndModeCountdown = 90
            EndModeTimer.Enabled = 1
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 9 'Bowers
            DMD CL("RUN FROM BOWERS"), CL("COMPLETE GREEN BANK"), "", eNone, eNone, eNone, 3500, True, "vo_runhenry" &RndNbr(2)
            DMD CL("RUN FROM BOWERS"), CL("COMPLETE GREEN BANK"), "", eNone, eBlink, eNone, 1500, True, "vo_shootgreentargets"
            Arrows(7) = 2
            EndModeCountdown = 90
            EndModeTimer.Enabled = 1
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 10 'Belch
            DMD CL("RUN FROM BELCH"), CL("COMPLETE BLUE BANK"), "", eNone, eNone, eNone, 7500, True, "vo_runbelchor" &RndNbr(2)
            DMD CL("RUN FROM BELCH"), CL("COMPLETE BLUE BANK"), "", eNone, eBlink, eNone, 1500, True, "vo_shootbluetargets"
            Arrows(10) = 2
            EndModeCountdown = 90
            EndModeTimer.Enabled = 1
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        Case 11 'Victor
            DMD CL("RUN FROM VICTOR"), CL("HIT A COMBO"), "", eNone, eNone, eNone, 3000, True, "vo_runvictor"
            DMD CL("RUN FROM VICTOR"), CL("HIT A COMBO"), "", eNone, eNone, eNone, 1500, True, "vo_shootramps"
            LowerRamp
            Arrows(2) = 2
            Arrows(6) = 2
            Arrows(8) = 2
            EndModeCountdown = 90
            EndModeTimer.Enabled = 1
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
			End If
        'wizard modes
        Case 12 'wizard 1
            DMD CL("FIND PENNYWISE"), CL("SHOOT JACKPOTS"), "", eNone, eNone, eNone, 2000, True, "vo_wizards1"
            AddMultiball 2
            ChangeGI red
            ChangeGIIntensity 2
            RndJackpot_Timer 'turn on a Jackpot
            JackpotHits = 0
            aBallWhiteGlowing = True
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
				SpeakerColor = Red
				SpeakerChangeColor
			End If
        Case 13              'wizard 2
            DMD CL("FIGHT PENNYWISE"), CL("SHOOT JACKPOTS"), "", eNone, eNone, eNone, 2000, True, "vo_wizards2"
            AddMultiball 3
            ChangeGi red
            ChangeGIIntensity 2
            RndJackpot_Timer 'turn on a Jackpot
            JackpotHits = 0
            aBallWhiteGlowing = True
			If VRRoom > 0 Then
				VRBGFlashIT.enabled = True
				SpeakerColor = Red
				SpeakerChangeColor
			End If
        Case 14              'Wizard 3
            DMD CL("KILL PENNYWISE"), CL("SHOOT PENNYWISE"), "", eNone, eNone, eNone, 2000, True, "vo_wizards3"
            AddMultiball 4
            ChangeGi red
            ChangeGIIntensity 2
            JackpotLight(5) = 2
            JackpotHits = 0
            aBallWhiteGlowing = True
			If VRRoom > 0 Then
				SpeakerColor = Red
				SpeakerChangeColor
				VRBGFlashIT.enabled = True
			End If
    End Select
End Sub

' check if the Mode is completed
Sub CheckWinMode
    'PlaySound "sfx_thunder" & RndNbr(13)
    DOF 126, DOFPulse
    LightSeqInserts.StopPlay 'stop the light effects before starting again so they don't play too long.
    LightEffect 3
    Select Case Mode(CurrentPlayer, 0)
        Case 1
            If SpinCount1 = SpinsToCount1 Then
                DMD CL("YOU RESCUED EDDIE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_eddiesaved"
                WinMode
                SPJackpotLight(5) = 2
                SuperJackpotTimer.Enabled = 1
            End if
        Case 2
            If BumperHits2 = BumpersToHit2 Then
                DMD CL("YOU RESCUED BEN"), "", "_", eNone, eNone, eNone, 1500, True, "vo_bensaved"
                WinMode
                SPJackpotLight(5) = 2
                SuperJackpotTimer.Enabled = 1
            End if
        Case 3
            If RampHits3 = RampsToHit3 Then
                DMD CL("YOU RESCUED RICHIE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_richiesaved"
                WinMode
                SPJackpotLight(5) = 2
                SuperJackpotTimer.Enabled = 1
            End if
        Case 4
            If OrbitHits4 = OrbitsToHit4 Then
                DMD CL("YOU RESCUED BEVERLY"), "", "_", eNone, eNone, eNone, 1500, True, "vo_beverlysaved"
                WinMode
                SPJackpotLight(5) = 2
                SuperJackpotTimer.Enabled = 1
            End if
        Case 5
            If LightHits5 = LightsToHit5 Then
                DMD CL("YOU RESCUED STANLEY"), "", "_", eNone, eNone, eNone, 1500, True, "vo_stanleysaved"
                WinMode
                SPJackpotLight(5) = 2
                SuperJackpotTimer.Enabled = 1
            End if
        Case 6
            If LightHits6 = LightsToHit6 Then
                DMD CL("YOU RESCUED MIKE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_mikesaved"
                WinMode
                SPJackpotLight(5) = 2
                SuperJackpotTimer.Enabled = 1
            Else
                ResetArrows
                Arrows(RndNbr(10)) = 2
            End if
        Case 7
            If TargetHits7 = TargetsToHit7 Then
                DMD CL("YOU RESCUED BILL"), "", "_", eNone, eNone, eNone, 1500, True, "vo_billsaved"
                WinMode
                SPJackpotLight(5) = 2
                SuperJackpotTimer.Enabled = 1
            End if
        Case 8
            DMD CL("YOU RUN FROM PATRICK"), "", "_", eNone, eNone, eNone, 1500, True, "vo_patrickrun"
            WinMode
            ExtraBallIsLit
        Case 9
            DMD CL("YOU RUN FROM BOWERS"), "", "_", eNone, eNone, eNone, 1500, True, "vo_henryrun"
            WinMode
            ExtraBallIsLit
        Case 10
            DMD CL("YOU RUN FROM BELCH"), "", "_", eNone, eNone, eNone, 1500, True, "vo_belchrun"
            WinMode
            ExtraBallIsLit
        Case 11
            DMD CL("YOU RUN FROM VICTOR"), "", "_", eNone, eNone, eNone, 1500, True, "vo_victorrun"
            WinMode
            ExtraBallIsLit
        Case 12 'wizard modes they are multiballs with jackpots
            Select Case JackpotHits
                Case 1, 2, 3:AwardJackpot:ResetJackpots:RndJackpot_Timer:RndJackpot.Enabled = 1
                Case 4:AwardJackpot:ResetJackpots:RndJackpot.Enabled = 0:SPJackpotLight(5) = 2
                Case Else:AwardSuperJackpot
            End Select
            JackpotHits = JackpotHits + 1
        Case 13 '2nd wizard modes they are multiballs with jackpots
            Select Case JackpotHits
                Case 1, 2, 3, 4:AwardJackpot:ResetJackpots:RndJackpot_Timer:RndJackpot.Enabled = 1
                Case 5:AwardJackpot:ResetJackpots:RndJackpot.Enabled = 0:RndSPJackpot_Timer
                Case Else:AwardSuperJackpot:RndSPJackpot_Timer
            End Select
            JackpotHits = JackpotHits + 1
        Case 14 'last wizard mode
            Select Case JackpotHits
                Case 1, 2, 3, 4, 5:AwardJackpot
                Case 6:AwardJackpot:ResetJackpots:SPJackpotLight(5) = 2
                Case Else:AwardSuperJackpot
            End Select
            JackpotHits = JackpotHits + 1
    End Select
End Sub

Sub StopMode 'called at the end of a ball and also from the stopmode timer during times modes
    Dim i
    Select Case Mode(CurrentPlayer, 0)
        Case 0:PlaySound "vo_drain" &RndNbr(20) : If VRRoom > 0 Then VRBGFLITtimer.enabled = true
        Case 1:DMD CL("EDDIE IS MINE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_drain" &RndNbr(20) : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 2:DMD CL("BEN IS MINE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_bendead" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 3:DMD CL("RICHIE IS MINE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_richiedead" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 4:DMD CL("BEVERLY IS MINE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_beverlydead" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 5:DMD CL("STANLEY IS MINE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_stanleydead" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 6:DMD CL("MIKE IS MINE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_mikedead" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 7:DMD CL("BILL IS MINE"), "", "_", eNone, eNone, eNone, 1500, True, "vo_billdead" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 8:DMD CL("PATRICK GOT YOU"), "", "_", eNone, eNone, eNone, 1500, True, "vo_patrickwon" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 9:DMD CL("HENRY GOT YOU"), "", "_", eNone, eNone, eNone, 1500, True, "vo_henrywon" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 10:DMD CL("BELCH GOT YOU"), "", "_", eNone, eNone, eNone, 1500, True, "vo_benchorwon" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 11:DMD CL("VICTOR GOT YOU"), "", "_", eNone, eNone, eNone, 1500, True, "vo_victorwon" : If VRRoom > 0 Then VRBGFlashFail.enabled = 1
        Case 12:DMD CL("YOU FOUND"), CL("PENNYWISE"), "_", eBlink, eBlink, eNone, 3000, True, "vo_wizards4"
        Case 13:DMD CL("YOU FOUGHT"), CL("PENNYWISE"), "_", eBlink, eBlink, eNone, 3000, True, "vo_wizards5"
        Case 14:DMD CL("YOU ALMOST KILLED"), CL("PENNYWISE"), "_", eBlink, eBlink, eNone, 2000, True, "vo_wizards6"
                 DMD CL("BUT HE ESCAPED"), CL("HA HA HA"), "_", eBlink, eBlink, eNone, 2000, True, ""
    End Select
    For i = 1 to 14
        If Mode(CurrentPlayer, i) = 2 Then Mode(CurrentPlayer, i) = 0
    Next
    UpdateModeLights
    StopMode2
End Sub

'called after completing a Mode
Sub WinMode
    ModesWon(CurrentPlayer) = ModesWon(CurrentPlayer) + 1
    Mode(CurrentPlayer, Mode(CurrentPlayer, 0)) = 1
    UpdateModeLights
    FlashEffect 2
    LightEffect 2
    GiEffect 3
    DMD "_", CL("MODE COMPLETED"), "_", eNone, eBlinkFast, eNone, 1500, True, ""
    DOF 139, DOFPulse
    StopMode2
	If VRRoom > 0 Then
		VRBGFlashSuccess.enabled = true
	End If
    ' check for extra awards
    Select Case ModesWon(CurrentPlayer)
        Case 4:SelectModeManually 12
        Case 8:SelectModeManually 13
        Case 11:SelectModeManually 14
    End Select
    ChangeSong
End Sub

Sub StopMode2 'called after a win or after loosing the ball (from StopMode)
    'Turn off the Arrow lights
    ResetArrows
    ' stop some timers or reset Mode variables or lights
    EndModeTimer.Enabled = 0
    Select Case Mode(CurrentPlayer, 0)		
        Case 1:
        Case 2:li058.State = 0:Lbumper1.State = 0:Lbumper2.State = 0:Lbumper3.State = 0
        Case 3:
        Case 4:
        Case 5:
        Case 6:
        Case 7:
        Case 8:
        Case 9:
        Case 10:
        Case 11:
        Case 12, 13:ResetJackpots:ResetSPJackpots
        Case 14:ResetJackpots:ResetSPJackpots:ResetModes
    End Select
    Mode(CurrentPlayer, 0) = 0
End Sub

Sub ResetModes
    Dim i, j
    For j = 0 to 4
        ModesWon(j) = 0
        For i = 1 to 14
            Mode(CurrentPlayer, i) = 0
        Next
    Next
    Mode(CurrentPlayer, 0) = 0
End Sub

Sub EndModeTimer_Timer '1 second timer to count down to end the timed modes
    EndModeCountdown = EndModeCountdown - 1
    If EndModeCountdown < 61 Then
        Select Case EndModeCountdown
            Case 16:DMD "_", CL("TIME IS RUNNING OUT"), "_", eNone, eBlinkFast, eNone, 1000, True, "" : If VRRoom > 0 Then VRBGFlashIT.enabled = True
            Case 10:DMD "_", CL("10"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_10"
            Case 9:DMD "_", CL("9"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_9"
            Case 8:DMD "_", CL("8"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_8"
            Case 7:DMD "_", CL("7"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_7"
            Case 6:DMD "_", CL("6"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_6"
            Case 5:DMD "_", CL("5"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_5"
            Case 4:DMD "_", CL("4"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_4"
            Case 3:DMD "_", CL("3"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_3"
            Case 2:DMD "_", CL("2"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_2"
            Case 1:DMD "_", CL("1"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_1"
            Case 0:DMD "_", CL("TIME IS UP"), "_", eNone, eBlinkFast, eNone, 1000, True, "":StopMode
            Case Else:DMD "_", CL(EndModeCountdown), "_", eNone, eNone, eNone, 500, True, ""
        End Select
    End If
End Sub

'********************
' Update Arrow color
'********************

Sub UpdateArrows_Timer 'timer change the color of the blinking lights according to the active Mode
    Select Case UpdateArrowsCount
        Case 0         'Mode Arrows -white
            If Arrows(1)Then SetlightColor li063, white, Arrows(1)
            If Arrows(2)Then SetlightColor li050, white, Arrows(2)
            If Arrows(3)Then SetlightColor li047, white, Arrows(3)
            If Arrows(4)Then SetlightColor li046, white, Arrows(4)
            If Arrows(5)Then SetlightColor li045, white, Arrows(5)
            If Arrows(6)Then SetlightColor li043, white, Arrows(6)
            If Arrows(7)Then SetlightColor li061, white, Arrows(7)
            If Arrows(8)Then SetlightColor li048, white, Arrows(8)
            If Arrows(9)Then SetlightColor li049, white, Arrows(9)
            If Arrows(10)Then SetlightColor li062, white, Arrows(10)
        Case 1 'Jackpots -red
            If JackPotLight(1)Then SetlightColor li063, red, JackPotLight(1)
            If JackPotLight(2)Then SetlightColor li050, red, JackPotLight(2)
            If JackPotLight(3)Then SetlightColor li047, red, JackPotLight(3)
            If JackPotLight(4)Then SetlightColor li046, red, JackPotLight(4)
            If JackPotLight(5)Then SetlightColor li045, red, JackPotLight(5)
            If JackPotLight(6)Then SetlightColor li043, red, JackPotLight(6)
            If JackPotLight(7)Then SetlightColor li061, red, JackPotLight(7)
            If JackPotLight(8)Then SetlightColor li048, red, JackPotLight(8)
            If JackPotLight(9)Then SetlightColor li049, red, JackPotLight(9)
            If JackPotLight(10)Then SetlightColor li062, red, JackPotLight(10)
        Case 2 'SuperJackpots -purple
            If SPJackPotLight(1)Then SetlightColor li063, purple, SPJackPotLight(1)
            If SPJackPotLight(2)Then SetlightColor li050, purple, SPJackPotLight(2)
            If SPJackPotLight(3)Then SetlightColor li047, purple, SPJackPotLight(3)
            If SPJackPotLight(4)Then SetlightColor li046, purple, SPJackPotLight(4)
            If SPJackPotLight(5)Then SetlightColor li045, purple, SPJackPotLight(5)
            If SPJackPotLight(6)Then SetlightColor li043, purple, SPJackPotLight(6)
            If SPJackPotLight(7)Then SetlightColor li061, purple, SPJackPotLight(7)
            If SPJackPotLight(8)Then SetlightColor li048, purple, SPJackPotLight(8)
            If SPJackPotLight(9)Then SetlightColor li049, purple, SPJackPotLight(9)
            If SPJackPotLight(10)Then SetlightColor li062, purple, SPJackPotLight(10)
    End Select
    UpdateArrowsCount = (UpdateArrowsCount + 1)MOD 3
End Sub

Sub ResetArrows
    Dim i
    For i = 1 to 10
        Arrows(i) = 0
    Next
    li063.State = 0
    li050.State = 0
    li047.State = 0
    li046.State = 0
    li045.State = 0
    li043.State = 0
    li061.State = 0
    li048.State = 0
    li049.State = 0
    li062.State = 0
End Sub

Sub RndArrow_Timer
    ResetArrows
    Arrows(RndNbr(10)) = 2
End Sub

'Jackpots

Sub ResetJackpots
    Dim i
    For i = 1 to 10
        JackpotLight(i) = 0
    Next
    li063.State = 0
    li050.State = 0
    li047.State = 0
    li046.State = 0
    li045.State = 0
    li043.State = 0
    li061.State = 0
    li048.State = 0
    li049.State = 0
    li062.State = 0
End Sub

Sub RndJackpot_Timer
    ResetJackpots
    JackpotLight(RndNbr(10)) = 2
End Sub

' SuperJackpots
Sub ResetSPJackpots
    SuperJackpotTimer.Enabled = 0
    Dim i
    For i = 1 to 10
        SPJackpotLight(i) = 0
    Next
    li063.State = 0
    li050.State = 0
    li047.State = 0
    li046.State = 0
    li045.State = 0
    li043.State = 0
    li061.State = 0
    li048.State = 0
    li049.State = 0
    li062.State = 0
End Sub

Sub RndSPJackpot_Timer
    ResetSPJackpots
    SPJackpotLight(RndNbr(10)) = 2
End Sub

'********************
' Multiballs & Locks
'********************

Sub Clock_Hit 'Center Lock
    SoundSaucerLock
    If Tilted Then vpmtimer.addtimer 500, "ClockExit '":Exit Sub
    FlashEffect 2
    Addscore 5000
    If NOT bMultiBallMode Then 'in multiball the kicker should be already disabled
        BallsInLock(CurrentPlayer) = BallsInLock(CurrentPlayer) + 1
        Select Case BallsInLock(CurrentPlayer)
            Case 1
                DMD "_", CL("BALL 1 LOCKED"), "_", eNone, eBlink, eNone, 1500, True, "vo_ball1locked"
                vpmtimer.addtimer 1500, "ClockExit '"
				If VRRoom > 0 Then
					VRBGFlashMB1.enabled = True
				End If
            Case 2
                DMD "_", CL("BALL 2 LOCKED"), "_", eNone, eBlink, eNone, 1500, True, "vo_ball2locked"
                vpmtimer.addtimer 1500, "ClockExit '"
				If VRRoom > 0 Then
					VRBGFlashMB2.enabled = True
				End If
            Case 3
                DMD "_", CL("BALL 3 LOCKED"), "_", eNone, eBlink, eNone, 1500, True, "vo_ball3locked"
                vpmtimer.addtimer 1500, "StartMultiball '"
                vpmtimer.addtimer 2500, "ClockExit '"
				If VRRoom > 0 Then
					VRBGFlashMB3.enabled = True
				End If
        End Select
    Else
        ' Nothing more to do, so kick out the ball
        vpmtimer.addtimer 200, "ClockExit '"
    End If
End Sub


Sub ClockExit
    SoundSaucerKick 1, Clock
    DOF 130, DOFPulse
    Clock.kick 190, 6
    LightEffect 5
End Sub

Sub Tlock_Hit 'Top ramp Lock
    SoundSaucerLock
    If Tilted Then vpmtimer.addtimer 500, "TlockExit '":Exit Sub
    FlashEffect 2
    Addscore 5000
    If NOT bMultiBallMode Then 'in multiball the kicker should be already disabled
        BallsInLock(CurrentPlayer) = BallsInLock(CurrentPlayer) + 1
        Select Case BallsInLock(CurrentPlayer)
            Case 1
                DMD "_", CL("BALL 1 LOCKED"), "_", eNone, eBlink, eNone, 1500, True, "vo_ball1locked"
                vpmtimer.addtimer 1500, "TlockExit '"
				If VRRoom > 0 Then
					VRBGFlashMB1.enabled = True
				End If
            Case 2
                DMD "_", CL("BALL 2 LOCKED"), "_", eNone, eBlink, eNone, 1500, True, "vo_ball2locked"
                vpmtimer.addtimer 1500, "TlockExit '"
				If VRRoom > 0 Then
					VRBGFlashMB2.enabled = True
				End If
            Case 3
                DMD "_", CL("BALL 3 LOCKED"), "_", eNone, eBlink, eNone, 1500, True, "vo_ball3locked"
                vpmtimer.addtimer 1500, "StartMultiball '"
                vpmtimer.addtimer 2500, "TlockExit '"
				If VRRoom > 0 Then
					VRBGFlashMB3.enabled = True
				End If
        End Select
    Else
        ' Nothing more to do, so kick out the ball
        vpmtimer.addtimer 200, "TlockExit '"
    End If
End Sub

Sub TlockExit
    SoundSaucerKick 1, Tlock
    DOF 130, DOFPulse
    Tlock.kick 90, 6
    LightEffect 5
End Sub

dim bCentipede : bCentipede = false

Sub StartMultiball
	EnableBallSaver 20
    FlashEffect 7
    bMultiBallStarted = True
    ChangeSong
    ' disable locks
    bLocksEnabled = False
    li060.State = 0
    Clock.Enabled = 0
    li064.State = 0
    Tlock.Enabled = 0
    Select Case MultiballType(CurrentPlayer)
        Case 0 'normal multiball, no jackpots, use it for completing modes
            DMD "_", CL("MULTIBALL"), "_", eNone, eBlink, eNone, 1500, True, "vo_multiball"
            AddMultiball 2
        Case 1 'Georgie - 7 ball - random jackpots
            DMD CL("GEORGIE"), CL("MULTIBALL"), "_", eBlink, eBlink, eNone, 1500, True, ""
            RndJackpot_Timer
            RndJackpot.Enabled = 1
			bEnableBloodTrails = True
            BloodBall 1
            ChangeGi yellow
            ChangeGIIntensity 2
            AddMultiball 6
			DOF 159, DOFoff'Turn Off Green Undercab
			DOF 155, DOFOn 'Multiball Lighting
			If VRRoom > 0 Then
				SpeakerColor = Yellow
				SpeakerChangeColor
			End If
        Case 2 'Fear - 4 ball - jackpots on left ramp, nice for combos, dark mode
            DMD CL("FEAR OF THE DARK"), CL("MULTIBALL"), "_", eBlink, eBlink, eNone, 1500, True, ""
            LowerRamp
            JackPotLight(2) = 2
            NightMode
            AddMultiball 3
			DOF 159, DOFoff 'Turn Off Green Undercab
			DOF 156, DOFOn 'Multiball Lighting
			If VRRoom > 0 Then
				SpeakerColor = Dark
				SpeakerChangeColor
			End If
        Case 3 'Float - 5 ball - jackpots on right ramp, nice for combos, green fog
            DMD CL("YOU WILL ALL FLOAT"), CL("MULTIBALL"), "_", eBlink, eBlink, eNone, 1500, True, ""
            JackPotLight(8) = 2
            Start_Fog
            AddMultiball 4
			DOF 159, DOFoff'Turn Off Green Undercab
			DOF 157, DOFOn 'Multiball Lighting
			If VRRoom > 0 Then
				VRBGFLSlime
				SpeakerColor = Green
				SpeakerChangeColor
				VRWaterLIME.visible = true ' sewer water
			End If
        Case 4 'Horrors - 7 ball - jackpots on orbits, all scores x balls in play
            DMD CL("HORRORS"), CL("MULTIBALL"), "_", eBlink, eBlink, eNone, 1500, True, ""
            JackPotLight(2) = 2
            JackPotLight(9) = 2
            ChangeGi red
            ChangeGIIntensity 2
			bCentipede = true
			roachmove	'make it escape from scoop immediately
            AddMultiball 6
			DOF 159, DOFoff'Turn Off Green Undercab
			DOF 158, DOFOn 'Multiball Lighting
            RiseRamp
			If VRRoom > 0 Then
				SpeakerColor = Red
				SpeakerChangeColor
			End If
    End Select
End Sub

Sub BloodBall(Enabled)
    Dim BOT, b
    BOT = GetBalls
    ' exit the Sub if no balls on the table
    If UBound(BOT) = -1 Then Exit Sub

    ' change the image for each ball, but not the captive ball
    If Enabled Then
    For b = lob to UBound(BOT)
        BOT(b).Image = "bloodball"
        BOT(b).FrontDecal = "bloodscratches"
    Next
    Else
    For b = lob to UBound(BOT)
        BOT(b).Image = ""
        BOT(b).FrontDecal = "rust4"
    Next
    End If
End Sub


'**************************VR Stuff Below...- Rawd and Leojreimroc *************************
'*******************************************************************************************


' VR Plunger stuff below..........
Sub TimerVRPlunger_Timer
  If VRKnifeBlade.Y < 2380 then    'guessing on number..  trial and error..
		VRKnifeBlade.Y = VRKnifeBlade.Y + 5
		VRKnifeHandle.Y = VRKnifeHandle.Y + 5
  End If
End Sub

Sub TimerVRPlunger2_Timer
  VRKnifeBlade.Y = 2270 + (5* Plunger.Position) -20
 VRKnifeHandle.Y = 2265 + (5* Plunger.Position) -20
End Sub

Dim RatRunning
RatRunning = true

Sub RatTimer_Timer()
If Ratrunning = true then 
Ratrunning = False
RatAnim1.StopAnim
Else
Ratrunning = True
RatAnim1.PlayAnimEndless(0.06)
End If
End Sub

dim BoatMove 
BoatMove = 0.03

Dim WaterMove
Dim WaterMove2

Watermove = 0.5
Watermove2 = -0.5

Sub VRMainTimer_Timer()
VRDrip1.z = VRDrip1.z -45
if VRDrip1.z < -8000 then VRDrip1.z = 4000
VRDrip2.z = VRDrip2.z -45
if VRDrip2.z < -38000 then VRDrip2.z = 3300
VRDrip3.z = VRDrip3.z -45
if VRDrip3.z < -22000 then VRDrip3.z = 4000
VRDrip4.z = VRDrip4.z -45
if VRDrip4.z < -22000 then VRDrip4.z = 4000
VRDrip5.z = VRDrip5.z -30
if VRDrip5.z < -22000 then VRDrip5.z = 700

VRSewerBoat.rotx = VRSewerBoat.Rotx + BoatMove
if VRSewerBoat.RotX < 4 then Boatmove = 0.03
if VRSewerBoat.RotX > 12 then Boatmove = -0.03

VRWater.Opacity = VRWater.Opacity + WaterMove
If VRWater.Opacity => 150 then WaterMove = -0.5
If VRWater.Opacity =< 50 then WaterMove = 0.5
VRWater2.Opacity = VRWater2.Opacity + WaterMove2
If VRWater2.Opacity => 100 then WaterMove2 = -0.3
If VRWater2.Opacity =< 10 then WaterMove2 = 0.3

if RatRunning = true then RatAnim1.roty = RatAnim1.roty +0.65
End Sub


'**********************************************************
'*******	Set Up Backglass and Backglass Flashers	*******
'**********************************************************
' this is for lining up the backglass flashers on top of a backglass image

Sub SetBackglass()

' these are set as not visible in the editor now, for Desktop and FS defaults..
BGSlime.visible = True
BGDark.visible = True
BGBright.visible = True
BGLogo.visible = True

	Dim obj

	For Each obj In VRBackglass
		obj.x = obj.x
		obj.height = - obj.y + 310
		obj.y = -105 'adjusts the distance from the backglass towards the user
		obj.rotx = -87.5
	Next

End Sub


'**********************************************************
'*******		VR Backglass Flasher Code			*******
'**********************************************************

' ******************
' **** Flashers ****
' ******************

'Pennywise
dim VRBGFLITlvl
sub VRBGFLIT
	If VRRoom > 0 Then
		VRBGFLITlvl = 1	
		VRBGFLITtimer_timer
	End If
end sub

sub VRBGFLITtimer_timer							
	if Not VRBGFLITtimer.enabled then
		VRBGFLIt_1.visible = true
		VRBGFLIt_2.visible = true
		VRBGFLIt_3.visible = true
		VRBGFLIt_4.visible = true
		VRBGFLIt_5.visible = true
		BGMouth.visible = true
		VRBGFLITtimer.enabled = true
	end if
	VRBGFLITlvl = 0.80 * VRBGFLITlvl - 0.01
	if VRBGFLITlvl < 0 then VRBGFLITlvl = 0
	VRBGFLIt_1.opacity = 50 * VRBGFLITlvl^1.5
	VRBGFLIt_2.opacity = 50 * VRBGFLITlvl^1.5
	VRBGFLIt_3.opacity = 50 * VRBGFLITlvl^1.5
	VRBGFLIt_4.opacity = 100 * VRBGFLITlvl^2
	VRBGFLIt_5.opacity = 100 * VRBGFLITlvl^2.5
	BGMouth.opacity = 75 * VRBGFLITlvl^1.5
	if VRBGFLITlvl =< 0 Then
		VRBGFLIt_1.visible = false
		VRBGFLIt_2.visible = false
		VRBGFLIt_3.visible = false
		VRBGFLIt_4.visible = false
		VRBGFLIt_5.visible = false
		BGMouth.visible = false
		VRBGFLITtimer.enabled = false
	end if
end sub

'Claws
dim VRBGFLClawslvl
sub VRBGFLClaws
	If VRRoom > 0 Then
		VRBGFLClawslvl = 1
		VRBGFLClawsTimer_timer
	End If
end sub

sub VRBGFLClawsTimer_timer							
	if Not VRBGFLClawsTimer.enabled then
		BGClaws.visible = true
		VRBGFLClawsTimer.enabled = true
	end if
	VRBGFLClawslvl = 0.80 * VRBGFLClawslvl - 0.01
	if VRBGFLClawslvl < 0 then VRBGFLClawslvl = 0
	BGClaws.opacity = 100 * VRBGFLClawslvl^1.5
	if VRBGFLClawslvl =< 0 Then
		BGClaws.visible = false
		VRBGFLClawsTimer.enabled = false
	end if
end sub

'Kid Fail
dim VRBGFLKidFlvl
sub VRBGFLKidF
	If VRRoom > 0 Then
		VRBGFLKidFlvl = 1
		VRBGFLKidFTimer_timer
	End If
end sub

sub VRBGFLKidFtimer_timer							
	if Not VRBGFLKidFtimer.enabled then
		VRBGFLKidF_1.visible = true
		VRBGFLKidF_2.visible = true
		VRBGFLKidF_3.visible = true
		VRBGFLKidF_4.visible = true
		If VRBGExtraKid = 1 Then
			VRBGFLKidF_5.visible = true
		End If
		VRBGFLKidFtimer.enabled = true
	end if
	VRBGFLKidFlvl = 0.87 * VRBGFLKidFlvl - 0.01
	if VRBGFLKidFlvl < 0 then VRBGFLKidFlvl = 0
	VRBGFLKidF_1.opacity = 100 * VRBGFLKidFlvl^0.7
	VRBGFLKidF_2.opacity = 100 * VRBGFLKidFlvl^0.7
	VRBGFLKidF_3.opacity = 100 * VRBGFLKidFlvl^0.7
	VRBGFLKidF_4.opacity = 100 * VRBGFLKidFlvl^1
	If VRBGExtraKid = 1 Then
		VRBGFLKidF_5.opacity = 100 * VRBGFLKidFlvl^1
	End If
	if VRBGFLKidFlvl =< 0 Then
		VRBGFLKidF_1.visible = false
		VRBGFLKidF_2.visible = false
		VRBGFLKidF_3.visible = false
		VRBGFLKidF_4.visible = false
		If VRBGExtraKid = 1 Then
			VRBGFLKidF_5.visible = False
			VRBGExtraKid = 0
		End If
		VRBGFLKidFtimer.enabled = false
	end if
end sub

'Kid Saved
dim VRBGFLKidSlvl
sub VRBGFLKidS
	If VRRoom > 0 Then
		VRBGFLKidSlvl = 1
		VRBGFLKidSTimer_timer
	End If
end sub

sub VRBGFLKidStimer_timer							
	if Not VRBGFLKidStimer.enabled then
		VRBGFLKidS_1.visible = true
		VRBGFLKidS_2.visible = true
		VRBGFLKidS_3.visible = true
		VRBGFLKidS_4.visible = true
		VRBGFLKidStimer.enabled = true
	end if
	VRBGFLKidSlvl = 0.8 * VRBGFLKidSlvl - 0.01
	if VRBGFLKidSlvl < 0 then VRBGFLKidSlvl = 0
	VRBGFLKidS_1.opacity = 100 * VRBGFLKidSlvl^1.5
	VRBGFLKidS_2.opacity = 100 * VRBGFLKidSlvl^1.5
	VRBGFLKidS_3.opacity = 100 * VRBGFLKidSlvl^1.5
	VRBGFLKidS_4.opacity = 100 * VRBGFLKidSlvl^2
	if VRBGFLKidSlvl =< 0 Then
		VRBGFLKidS_1.visible = false
		VRBGFLKidS_2.visible = false
		VRBGFLKidS_3.visible = false
		VRBGFLKidS_4.visible = false
		VRBGFLKidStimer.enabled = false
	end if
end sub

'Sewer Left
dim VRBGFLSewer1lvl
sub VRBGFLSewer1
	If VRRoom > 0 Then
		VRBGFLSewer1lvl = 1	
		VRBGFLSewer1timer_timer
	End If
end sub

sub VRBGFLSewer1timer_timer							
	if Not VRBGFLSewer1timer.enabled then
		VRBGFLSewer1_1.visible = true
		VRBGFLSewer1_2.visible = true
		VRBGFLSewer1_3.visible = true
		VRBGFLSewer1_4.visible = true
		VRBGFlSewer1_5.visible = true
		VRBGFlSewer1Timer.enabled = true
	end if
	VRBGFLSewer1lvl = 0.80 * VRBGFLSewer1lvl - 0.01
	if VRBGFLSewer1lvl < 0 then VRBGFLSewer1lvl = 0
	VRBGFLSewer1_1.opacity = 100 * VRBGFLSewer1lvl^1.5
	VRBGFLSewer1_2.opacity = 100 * VRBGFLSewer1lvl^1.5
	VRBGFLSewer1_3.opacity = 100 * VRBGFLSewer1lvl^1.5
	VRBGFLSewer1_4.opacity = 100 * VRBGFLSewer1lvl^2
	VRBGFlSewer1_5.opacity = 100 * VRBGFLSewer1lvl^2.5
	if VRBGFLSewer1lvl =< 0 Then
		VRBGFLSewer1_1.visible = false
		VRBGFLSewer1_2.visible = false
		VRBGFLSewer1_3.visible = false
		VRBGFLSewer1_4.visible = false
		VRBGFlSewer1_5.visible = false
		VRBGFLSewer1timer.enabled = false
	end if
end sub

'Sewer Right
dim VRBGFLSewer2lvl
sub VRBGFLSewer2
	If VRRoom > 0 Then
		VRBGFLSewer2lvl = 1	
		VRBGFLSewer2timer_timer
	End If
end sub

sub VRBGFLSewer2timer_timer							
	if Not VRBGFLSewer2timer.enabled then
		VRBGFLSewer2_1.visible = true
		VRBGFLSewer2_2.visible = true
		VRBGFLSewer2_3.visible = true
		VRBGFLSewer2_4.visible = true
		VRBGFlSewer2_5.visible = true
		VRBGFlSewer2Timer.enabled = true
	end if
	VRBGFLSewer2lvl = 0.80 * VRBGFLSewer2lvl - 0.01
	if VRBGFLSewer2lvl < 0 then VRBGFLSewer2lvl = 0
	VRBGFLSewer2_1.opacity = 100 * VRBGFLSewer2lvl^1.5
	VRBGFLSewer2_2.opacity = 100 * VRBGFLSewer2lvl^1.5
	VRBGFLSewer2_3.opacity = 100 * VRBGFLSewer2lvl^1.5
	VRBGFLSewer2_4.opacity = 100 * VRBGFLSewer2lvl^2
	VRBGFlSewer2_5.opacity = 100 * VRBGFLSewer2lvl^2.5
	if VRBGFLSewer2lvl =< 0 Then
		VRBGFLSewer2_1.visible = false
		VRBGFLSewer2_2.visible = false
		VRBGFLSewer2_3.visible = false
		VRBGFLSewer2_4.visible = false
		VRBGFlSewer2_5.visible = false
		VRBGFLSewer2timer.enabled = false
	end if
end sub

'Transformed Stanley
dim VRBGFLStanleylvl
sub VRBGFLStanley
	If VRRoom > 0 Then
		VRBGFLStanleylvl = 1	
		VRBGFLStanleytimer_timer
	End If
end sub

sub VRBGFLStanleytimer_timer							
	if Not VRBGFLStanleytimer.enabled then
		VRBGFLStanley_1.visible = true
		VRBGFLStanley_2.visible = true
		VRBGFLStanley_3.visible = true
		VRBGFLStanley_4.visible = true
		VRBGFLStanley_5.visible = true
		VRBGFlStanleyTimer.enabled = true
	end if
	VRBGFLStanleylvl = 0.75 * VRBGFLStanleylvl - 0.01
	if VRBGFLStanleylvl < 0 then VRBGFLStanleylvl = 0
	VRBGFLStanley_1.opacity = 50 * VRBGFLStanleylvl^1.5
	VRBGFLStanley_2.opacity = 50 * VRBGFLStanleylvl^1.5
	VRBGFLStanley_3.opacity = 50 * VRBGFLStanleylvl^1.5
	VRBGFLStanley_4.opacity = 100 * VRBGFLStanleylvl^2
	VRBGFLStanley_5.opacity = 100 * VRBGFLStanleylvl^2.5
	if VRBGFLStanleylvl =< 0 Then
		VRBGFLStanley_1.visible = false
		VRBGFLStanley_2.visible = false
		VRBGFLStanley_3.visible = false
		VRBGFLStanley_4.visible = false
		VRBGFLStanley_5.visible = false
		VRBGFLStanleytimer.enabled = false
	end if
end sub

'Logo
dim VRBGFLLogolvl, VRBGLogoDirection
sub VRBGFLLogo
	If VRRoom > 0 Then
		VRBGLogoDirection = 1
		VRBGFLLogolvl = 0.1
		VRBGFLLogoTimer_timer
	End If
end sub

sub VRBGFLLogoTimer_timer
	if Not VRBGFLLogoTimer.enabled then
		BGLogo.visible = true
		VRBGFLLogo_1.visible = true
		VRBGFLLogoTimer.enabled = true
	end if
	If VRBGLogoDirection = 1 Then
		VRBGFLLogolvl = 1.3 * VRBGFLLogolvl + 0.01
		BGLogo.opacity = 100 * VRBGFLLogolvl
		VRBGFLLogo_1.opacity = 100 * VRBGFLLogolvl
	End If
	
	If VRBGFLLogolvl > 3 Then
		VRBGLogoDirection = 2
	End IF
	If VRBGLogoDirection = 2 Then
		VRBGFLLogolvl = 0.7 * VRBGFLLogolvl - 0.01
		if VRBGFLLogolvl < 0 then VRBGFLLogolvl = 0
		BGLogo.opacity = 100 * VRBGFLLogolvl
		VRBGFLLogo_1.opacity = 100 * VRBGFLLogolvl
	end if
	if VRBGFLLogolvl =< 0 Then
		BGLogo.visible = 0
		VRBGFLLogo_1.visible = 0
		VRBGFLLogoTimer.enabled = False
	End If
end sub



' ***************************
' **** Flasher Sequences ****
' ***************************

'Pennywise Voice Flash Sequence

Dim VRBGstepIT
VRBGstepIT = 0
VRBGFlashIT.enabled = false
Sub VRBGFlashIT_timer
	If VRRoom > 0 Then
		VRBGstepIT = VRBGstepIT + 1
		Select case VRBGstepIT
			case 0
				VRBGFLIT
			case 1
				VRBGFLIT
			Case 2
				VRBGFLIT
			case 3
				VRBGFLIT
			case 5
				VRBGFLIT
			Case 6
				VRBGFLIT
			Case 7
				VRBGFLIT
			Case 8
				VRBGFLIT
			Case 10
				VRBGFLIT
			Case 11
				VRBGFLIT
			Case 12
				VRBGFLIT
			Case 13
				VRBGFLIT
				VRBGstepIT = 0
				VRBGFlashIT.enabled = false
		End Select
	End If
End Sub

'Mode Success Sequence

dim VRBGStepSuccess
VRBGStepSuccess = 0
VRBGFlashSuccess.enabled = false
Sub VRBGFlashSuccess_timer
	If VRRoom > 0 Then
		VRBGStepSuccess = VRBGStepSuccess + 1
		Select case VRBGStepSuccess
			case 1
				VRBGFLIT
			Case 2
				VRBGFLKidS
			case 3
				VRBGFLKidS
'			case 4
'				VRBGFLKidF
			case 5
				VRBGFLIT
			Case 6
				VRBGFLKidS
			Case 7
				VRBGFLKidS
				VRBGstepSuccess = 0
				VRBGFlashSuccess.enabled = false
		End Select
	End If
End Sub

'Mode Failed Sequence

dim VRBGStepFail, VRBGExtraKid
VRBGFlashFail.enabled = false
Sub VRBGFlashFail_timer
	If VRRoom > 0 Then
		VRBGStepFail = VRBGStepFail + 1
		Select case VRBGStepFail
			case 1
				VRBGFLIT
			Case 2
				VRBGFLClaws
				VRBGFLLogo
			case 3
				VRBGFLClaws
			case 4
				VRBGFLKidF
			case 5
				VRBGFLLogo
			case 6
				VRBGFLIT
			Case 7
				VRBGFLClaws
			Case 8
				VRBGFLClaws
				VRBGFLLogo
			Case 11
				VRBGExtraKid = 1
				VRBGFLKidF
				VRBGstepFail = 0
				VRBGFlashFail.enabled = false
		End Select
	End If
End Sub

'Left Sewer Flash Sequence (Left Loop)
Dim VRBGStepSewer1
VRBGStepSewer1 = 0
VRBGFlashSewer1.enabled = false
Sub VRBGFlashSewer1_timer
	If VRRoom > 0 Then
		VRBGStepSewer1 = VRBGStepSewer1 + 1
		Select case VRBGStepSewer1
			case 2
				VRBGFLSewer1
			Case 4
				VRBGFLSewer1
			case 6
				VRBGFLSewer1
			Case 7
				VRBGFLSewer1
				VRBGStepSewer1 = 0
				VRBGFlashSewer1.enabled = false
		End Select
	End If
End Sub

'Right Sewer Flash Sequence (Right Loop)

Dim VRBGStepSewer2
VRBGStepSewer2 = 0
VRBGFlashSewer2.enabled = false
Sub VRBGFlashSewer2_timer
	If VRRoom > 0 Then
		VRBGStepSewer2 = VRBGStepSewer2 + 1
		Select case VRBGStepSewer2
			case 2
				VRBGFlSewer2
			Case 4
				VRBGFlSewer2
			case 6
				VRBGFLSewer2
			Case 7
				VRBGFLSewer2
				VRBGStepSewer2 = 0
				VRBGFlashSewer2.enabled = false
		End Select
	End If
End Sub

'Tranformed Stanley Flash Sequence (Ramps)

Dim VRBGStepStanley
VRBGStepStanley = 0
VRBGFlashStanley.enabled = false
Sub VRBGFlashStanley_timer
	If VRRoom > 0 Then
		VRBGStepStanley = VRBGStepStanley + 1
		Select case VRBGStepStanley
			case 2
				VRBGFlStanley
			Case 4
				VRBGFlStanley
			case 6
				VRBGFLStanley
			Case 7
				VRBGFLStanley
				VRBGStepStanley = 0
				VRBGFlashStanley.enabled = false
		End Select
	End If
End Sub

'Small Flash (Jackpot, Skillshot)

dim VRBGStepSmall
VRBGFlashSmall.enabled = false
Sub VRBGFlashSmall_timer
	If VRRoom > 0 Then
		VRBGStepSmall = VRBGStepSmall + 1
		Select case VRBGStepSmall
			case 1
				VRBGFlStanley
			Case 2
				VRBGFlSewer2
			case 3
				VRBGFLSewer1
			case 4

			case 5

			case 6
				VRBGFlStanley
			Case 7
				VRBGFlSewer2
			Case 8
				VRBGFLSewer1
				VRBGStepSmall = 0
				VRBGFlashSmall.enabled = false
		End Select
	End If
End Sub

'Long Flash (Super Jackpot, Extra Ball, Special, Super SkillShot)

dim VRBGStepLong
VRBGFlashLong.enabled = false
Sub VRBGFlashLong_timer
	If VRRoom > 0 Then
		VRBGStepLong = VRBGStepLong + 1
		Select case VRBGStepLong
			case 1
				VRBGFlStanley
			Case 2
				VRBGFlSewer2
			case 3
				VRBGFLSewer1
			case 4

			case 5

			case 6
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1
			Case 7

			Case 8
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1
			case 11
				VRBGFlStanley
			Case 12
				VRBGFlSewer2
			case 13
				VRBGFLSewer1
			Case 16
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1
			Case 18
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1		
				VRBGStepLong = 0
				VRBGFlashLong.enabled = false
		End Select
	End If
End Sub

' **************************************
' **** Multiball Flashers/Sequences ****
' **************************************

'Ball 1 lock
dim VRBGFLMB1lvl
sub VRBGFLMB1
	If VRRoom > 0 Then
		VRBGFLMB1lvl = 1	
		VRBGFLMB1timer_timer
	End If
end sub

sub VRBGFLMB1timer_timer							
	if Not VRBGFLMB1timer.enabled then
		VRBGFLMB1_1.visible = true
		VRBGFLMB1_2.visible = true
		VRBGFLMB1_3.visible = true
		VRBGFLMB1_4.visible = true
		VRBGFLMB1timer.enabled = true
	end if
	VRBGFLMB1lvl = 0.80 * VRBGFLMB1lvl - 0.01
	if VRBGFLMB1lvl < 0 then VRBGFLMB1lvl = 0
	VRBGFLMB1_1.opacity = 100 * VRBGFLMB1lvl^1.5
	VRBGFLMB1_2.opacity = 100 * VRBGFLMB1lvl^1.5
	VRBGFLMB1_3.opacity = 100 * VRBGFLMB1lvl^1.5
	VRBGFLMB1_4.opacity = 100 * VRBGFLMB1lvl^2
	if VRBGFLMB1lvl =< 0 Then
		VRBGFLMB1_1.visible = false
		VRBGFLMB1_2.visible = false
		VRBGFLMB1_3.visible = false
		VRBGFLMB1_4.visible = false
		VRBGFLMB1timer.enabled = false
	end if
end sub

Dim VRBGstepMB1, VRBGStepMB1_2
VRBGstepMB1 = 0
VRBGFlashMB1.enabled = false

Sub VRBGFlashMB1_timer
	If VRRoom > 0 Then
		VRBGstepMB1 = VRBGstepMB1 + 1
		Select case VRBGstepMB1
			case 0
				VRBGFLMB1
			case 1
				VRBGFLMB1
			Case 2
				VRBGFLMB1
			case 3
				VRBGFLMB1
			case 5
				VRBGFLMB1
			Case 6
				VRBGFLMB1
			Case 7
				VRBGFLMB1
			Case 8
				VRBGFLMB1
			Case 10
				VRBGFLMB1
			Case 11
				VRBGFLMB1
			Case 12
				VRBGFLMB1
			Case 13
				VRBGFLMB1
				VRBGstepMB1 = 0
				VRBGFlashMB1.enabled = false
				VRBGBlinkMB1.enabled = true
		End Select
	End If
End Sub

Sub VRBGBlinkMB1_timer
	If VRRoom > 0 Then
		If bLocksEnabled = True and bRampIsUp = False Then
			VRBGStepMB1_2 = VRBGStepMB1_2 + 1
			Select case VRBGStepMB1_2
				case 1
					VRBGFLMB1
				case 10
					VRBGStepMB1_2 = 0
			End Select
		End If
	End If
End Sub

'Ball 2 Lock
dim VRBGFLMB2lvl
sub VRBGFLMB2
	If VRRoom > 0 Then
		VRBGFLMB2lvl = 1	
		VRBGFLMB2timer_timer
	End If
end sub

sub VRBGFLMB2timer_timer							
	if Not VRBGFLMB2timer.enabled then
		VRBGFLMB2_1.visible = true
		VRBGFLMB2_2.visible = true
		VRBGFLMB2_3.visible = true
		VRBGFLMB2_4.visible = true
		VRBGFLMB2timer.enabled = true
	end if
	VRBGFLMB2lvl = 0.80 * VRBGFLMB2lvl - 0.01
	if VRBGFLMB2lvl < 0 then VRBGFLMB2lvl = 0
	VRBGFLMB2_1.opacity = 100 * VRBGFLMB2lvl^1.5
	VRBGFLMB2_2.opacity = 100 * VRBGFLMB2lvl^1.5
	VRBGFLMB2_3.opacity = 100 * VRBGFLMB2lvl^1.5
	VRBGFLMB2_4.opacity = 100 * VRBGFLMB2lvl^2
	if VRBGFLMB2lvl =< 0 Then
		VRBGFLMB2_1.visible = false
		VRBGFLMB2_2.visible = false
		VRBGFLMB2_3.visible = false
		VRBGFLMB2_4.visible = false
		VRBGFLMB2timer.enabled = false
	end if
end sub

Dim VRBGstepMB2, VRBGStepMB2_2
VRBGstepMB2 = 0
VRBGFlashMB2.enabled = false
VRBGBlinkMB2.enabled = false

Sub VRBGFlashMB2_timer
	If VRRoom > 0 Then
		VRBGBlinkMB1.enabled = false
		VRBGstepMB2 = VRBGstepMB2 + 1
		Select case VRBGstepMB2
			case 0
				VRBGFLMB2
				VRBGFLMB1
			case 1
				VRBGFLMB2
				VRBGFLMB1
			Case 2
				VRBGFLMB2
				VRBGFLMB1
			case 3
				VRBGFLMB2
			case 4
				VRBGFLMB1
			case 5
				VRBGFLMB2
				VRBGFLMB1
			Case 6
				VRBGFLMB2
				VRBGFLMB1
			Case 7
				VRBGFLMB2
			Case 8
				VRBGFLMB2
				VRBGFLMB1
			Case 9
				VRBGFLMB1
			Case 10
				VRBGFLMB2
				VRBGFLMB1
			Case 11
				VRBGFLMB2
			Case 12
				VRBGFLMB2
				VRBGFLMB1
			Case 13
				VRBGFLMB2
				VRBGFLMB1
			Case 14
				VRBGFLMB1
				VRBGstepMB2 = 0
				VRBGFlashMB2.enabled = false
				VRBGBlinkMB2.enabled = true
		End Select
	End If
End Sub

Sub VRBGBlinkMB2_timer
	If VRRoom > 0 Then
		If bLocksEnabled = True and bRampIsUp = False Then
			VRBGStepMB2_2 = VRBGStepMB2_2 + 1
			Select case VRBGStepMB2_2
				case 1
					VRBGFLMB2
					VRBGFLMB1
				case 4
					VRBGFLMB1
				case 6
					VRBGFLMB2
				case 7
					VRBGFLMB1
				case 10
					VRBGStepMB2_2 = 0
			End Select
		End If
	End If
End Sub

'Ball 3 lock, Start Multiball
dim VRBGFLMB3lvl
sub VRBGFLMB3
	If VRRoom > 0 Then
		VRBGFLMB3lvl = 1	
		VRBGFLMB3timer_timer
	End If
end sub

sub VRBGFLMB3timer_timer							
	if Not VRBGFLMB3timer.enabled then
		VRBGFLMB3_1.visible = true
		VRBGFLMB3_2.visible = true
		VRBGFLMB3_3.visible = true
		VRBGFLMB3_4.visible = true
		VRBGFLMB3timer.enabled = true
	end if
	VRBGFLMB3lvl = 0.80 * VRBGFLMB3lvl - 0.01
	if VRBGFLMB3lvl < 0 then VRBGFLMB3lvl = 0
	VRBGFLMB3_1.opacity = 100 * VRBGFLMB3lvl^1.5
	VRBGFLMB3_2.opacity = 100 * VRBGFLMB3lvl^1.5
	VRBGFLMB3_3.opacity = 100 * VRBGFLMB3lvl^1.5
	VRBGFLMB3_4.opacity = 100 * VRBGFLMB3lvl^2
	if VRBGFLMB3lvl =< 0 Then
		VRBGFLMB3_1.visible = false
		VRBGFLMB3_2.visible = false
		VRBGFLMB3_3.visible = false
		VRBGFLMB3_4.visible = false
		VRBGFLMB3timer.enabled = false
	end if
end sub

Dim VRBGstepMB3, VRBGStepMB3_2
VRBGstepMB3 = 0
VRBGFlashMB3.enabled = false

Sub VRBGFlashMB3_timer
	If VRRoom > 0 Then
		VRBGBlinkMB2.enabled = false
		VRBGstepMB3 = VRBGstepMB3 + 1
		Select case VRBGstepMB3
			case 1
				VRBGFLMB1
			case 2
				VRBGFlStanley
			case 3
				VRBGFlSewer2
			case 4
				VRBGFLSewer1
			case 7
				VRBGFLMB2
			Case 13
				VRBGFLMB3
			case 18
				VRBGFLMB1
			case 23
				VRBGFLMB2
			case 24
				VRBGFlStanley
			case 25
				VRBGFlSewer2
			case 26
				VRBGFLSewer1
			case 28
				VRBGFLMB3
			Case 32
				VRBGFLMB1
			Case 36
				VRBGFLMB2
			Case 40
				VRBGFLMB3
			Case 43
				VRBGFLMB1
			Case 46
				VRBGFLMB2
			case 47
				VRBGFlStanley
			case 48
				VRBGFlSewer2
			Case 49
				VRBGFLMB3
				VRBGFLSewer1
			Case 51
				VRBGFLMB1
			Case 53
				VRBGFLMB2
			Case 55
				VRBGFLMB3
			Case 56
				VRBGFLMB1
			Case 57
				VRBGFLMB2
			Case 58
				VRBGFLMB3
			Case 59
				VRBGFLMB1
			Case 60
				VRBGFLMB2
			Case 61
				VRBGFLMB3
			Case 62
				VRBGFLMB1
				VRBGFLMB2
				VRBGFLMB3
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1
			Case 72
				VRBGFLMB1
				VRBGFLMB2
				VRBGFLMB3
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1
			Case 82
				VRBGFLMB1
				VRBGFLMB2
				VRBGFLMB3
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1
			Case 92
				VRBGFLMB1
				VRBGFLMB2
				VRBGFLMB3
				VRBGFlStanley
				VRBGFlSewer2
				VRBGFLSewer1
				VRBGstepMB3 = 0
				VRBGFlashMB3.enabled = false
		End Select
	End If
End Sub

'Slime Multiball
dim VRBGFLSlimelvl, VRBGSlimeDirection
sub VRBGFLSlime
	If VRRoom > 0 Then
		VRBGFLSlimelvl = 0.1
		VRBGFLSlimeTimer_timer
	End If
end sub

sub VRBGFLSlimeTimer_timer
	if Not VRBGFLSlimeTimer.enabled then
		BGSlime.visible = true
		VRBGFLSlimeTimer.enabled = true
	end if
	If VRBGFLSlimelvl < 2 Then
		VRBGSlimeDirection = 1
	End If
	If VRBGSlimeDirection = 1 Then
		VRBGFLSlimelvl = 1.1 * VRBGFLSlimelvl + 0.01
		BGSlime.opacity = 100 * VRBGFLSlimelvl
	End If
	
	If VRBGFLSlimelvl > 20 Then
		VRBGSlimeDirection = 2
	End IF
	If VRBGSlimeDirection = 2 Then
		VRBGFLSlimelvl = 0.9 * VRBGFLSlimelvl - 0.01
		if VRBGFLSlimelvl < 0 then VRBGFLSlimelvl = 0.1
		BGSlime.opacity = 100 * VRBGFLSlimelvl
	end if
	If bMultiBallStarted = False Then
		VRBGFLSlimeTimer.enabled = false
		VRWaterLIME.visible = false ' sewer water
	End If
end sub

'Speakers Fade out/In
dim Speakerlvl, SpeakerDirection, SpeakerColor
sub SpeakerChangeColor
	If VRRoom > 0 Then
		SpeakerDirection = 1
		If VRLeftSpeakerFlasher2.opacity < 2500 and VRLeftSpeakerFlasher2.opacity > 2000 Then
            Speakerlvl = 1
        Elseif VRLeftSpeakerFlasher2.opacity < 2001 and VRLeftSpeakerFlasher2.opacity > 1500 Then
            Speakerlvl = 0.75
        Elseif VRLeftSpeakerFlasher2.opacity < 1501 and VRLeftSpeakerFlasher2.opacity > 1000 Then
            Speakerlvl = 0.50
        Elseif VRLeftSpeakerFlasher2.opacity < 1001 and VRLeftSpeakerFlasher2.opacity > 500 Then
            Speakerlvl = 0.25
        Elseif VRLeftSpeakerFlasher2.opacity < 501 and VRLeftSpeakerFlasher2.opacity > 0 Then
            Speakerlvl = 0.10
        End If
		SpeakerTimer_timer
	End If
end sub

Dim dark
SpeakerColor = Default
sub SpeakerTimer_timer
	if Not SpeakerTimer.enabled then
		SpeakerTimer.enabled = true
	end if
		VRSpeakerTimer.enabled = false
		If SpeakerDirection = 1 Then
			Speakerlvl = 0.7 * Speakerlvl - 0.01
			VRLeftSpeakerFlasher.opacity = 200 * Speakerlvl
			VRRightSpeakerFlasher.opacity = 200 * Speakerlvl
			VRLeftSpeakerFlasher2.opacity = 2500 * Speakerlvl
			VRRightSpeakerFlasher2.opacity = 2500 * Speakerlvl
			if Speakerlvl < 0 then 
				Speakerlvl = 0.1
				SpeakerDirection = 2
			End If
		End If
		If SpeakerDirection = 2 Then
			If SpeakerColor = Default Then
				VRLeftSpeakerFlasher.color = RGB(64,51,0)
				VRRightSpeakerFlasher.color = RGB(0,45,89)
				VRLeftSpeakerFlasher2.color = RGB(64,51,0)
				VRRightSpeakerFlasher2.color = RGB(0,45,89)
			ElseIf SpeakerColor = Red Then
				VRLeftSpeakerFlasher.color = RGB(50,0,0)
				VRRightSpeakerFlasher.color = RGB(50,0,0)
				VRLeftSpeakerFlasher2.color = RGB(50,0,0)
				VRRightSpeakerFlasher2.color = RGB(50,0,0)
			Elseif SpeakerColor = Green Then
				VRLeftSpeakerFlasher.color = RGB(0,50,0)
				VRRightSpeakerFlasher.color = RGB(0,50,0)		
				VRLeftSpeakerFlasher2.color = RGB(0,50,0)
				VRRightSpeakerFlasher2.color = RGB(0,50,0)		
			Elseif SpeakerColor = Yellow Then	
				VRLeftSpeakerFlasher.color = RGB(100,78,0)
				VRRightSpeakerFlasher.color = RGB(100,78,0)
				VRLeftSpeakerFlasher2.color = RGB(100,78,0)
				VRRightSpeakerFlasher2.color = RGB(100,78,0)
			Elseif SpeakerColor = Dark Then	
				VRLeftSpeakerFlasher.color = RGB(0,0,0)
				VRRightSpeakerFlasher.color = RGB(0,0,0)
				VRLeftSpeakerFlasher2.color = RGB(0,0,0)
				VRRightSpeakerFlasher2.color = RGB(0,0,0)
			End If
			Speakerlvl = 1.3 * Speakerlvl
			VRLeftSpeakerFlasher.opacity = 200 * Speakerlvl
			VRRightSpeakerFlasher.opacity = 200 * Speakerlvl
			VRLeftSpeakerFlasher2.opacity = 2500 * Speakerlvl
			VRRightSpeakerFlasher2.opacity = 2500 * Speakerlvl
			If Speakerlvl > 1 Then 
				Speakerlvl = 1
				SpeakerTimer.enabled = False
				VRSpeakerTimer.enabled = true
			End If
		End If
end sub

Dim FadeSpeakerSpeed
FadeSpeakerSpeed = 20
Dim FadeSpeakerDirection
FadeSpeakerDirection = 0

Sub VRSpeakerTimer_Timer()
VRLeftSpeakerFlasher2.Opacity = VRLeftSpeakerFlasher2.Opacity + FadeSpeakerSpeed
VRRightSpeakerFlasher2.Opacity = VRRightSpeakerFlasher2.Opacity + FadeSpeakerSpeed
VRLeftSpeakerFlasher.Opacity = VRLeftSpeakerFlasher2.Opacity / 12.5
VRRightSpeakerFlasher.Opacity = VRRightSpeakerFlasher2.Opacity / 12.5

If VRLeftSpeakerFlasher2.Opacity >= 2400 then FadeSpeakerSpeed = -20
If VRLeftSpeakerFlasher2.Opacity <= 0 then 
FadeSpeakerSpeed = 20 
If FadeSpeakerDirection = 0 then VRLeftSpeakerFlasher.x = 987.2234 :VRLeftSpeakerFlasher2.x = 975.0917  :VRRightSpeakerFlasher.x = -26.00743 : VRRightSpeakerFlasher2.x = -26.00743::FadeSpeakerDirection = 1: exit sub
If FadeSpeakerDirection = 1 then VRLeftSpeakerFlasher.x = -26.00743 : VRLeftSpeakerFlasher2.x = -26.00743 :VRRightSpeakerFlasher.x = 987.9344: VRRightSpeakerFlasher2.x = 975.0917:FadeSpeakerDirection = 0: exit sub
end If
End Sub

Dim SewerPennyOn
SewerPennyOn = False
Dim RandomTimer

Sub SewerPennyTimer_timer()
if SewerPennyOn = False Then
SewerPennyOn = True
SewerPennyTimer2.enabled = true  'fade in eyes..
VRPennyEyeLeft.visible = True
VRPennyEyeRight.visible = True
VRPennyWiseRight.visible = True
SewerPennyTimer.interval = 5000
Else
SewerPennyOn = false
VRPennyEyeLeft.visible = false
VRPennyEyeRight.visible = false
VRPennyEyeLeft.opacity = 0
VRPennyEyeRight.opacity = 0
VRPennyWiseRight.visible = false
RandomTimer = Int((30000 * Rnd) + 20000) 'between 20 and 50 seconds
SewerPennyTimer.interval = RandomTimer
SewerPennyTimer2.enabled = false
end If
End Sub


Sub VRStartButtonTimer_timer()
if StartButtonInner.DisableLighting = 0 Then
StartButtonInner.DisableLighting = 2
Else
StartButtonInner.DisableLighting = 0
end If
end Sub

Sub SewerPennyTimer2_timer()
if VRPennyWiseRight.opacity < 22 then
VRPennyEyeLeft.opacity = VRPennyEyeLeft.opacity + 1
VRPennyEyeRight.opacity = VRPennyEyeRight.opacity + 1
VRPennyWiseRight.opacity = VRPennyWiseRight.opacity + 0.1

If VRPennyWiseRight.opacity => 22 then
SewerPennyTimer3.enabled = True
SewerPennyTimer2.enabled = false
end If

end If
End Sub

Sub SewerPennyTimer3_timer()
if VRPennyWiseRight.opacity > 0 then
VRPennyEyeLeft.opacity = VRPennyEyeLeft.opacity - 1
VRPennyEyeRight.opacity = VRPennyEyeRight.opacity - 1
VRPennyWiseRight.opacity = VRPennyWiseRight.opacity - 0.1
end If
If VRPennyWiseRight.opacity =< 0 then VRPennyWiseRight.opacity = 0: SewerPennyTimer3.enabled = false
end Sub


Dim PennywiseBackOn
PennywiseBackOn = false

Sub PennywiseTimer1_Timer()  

PennywiseTimer1.Interval = 12000 ' runs for 12 seconds
if PennywiseBackOn = false then 
PennywiseBackOn = true
PennywiseTimer2.enabled = true

Else
PennywiseBackOn = false
PennywiseTimer2.enabled = false
VRPennyWiseBack.visible = false
VRPennyWiseBack.y = -16663.1
VRPennyWiseBack.z = 150
PennywiseTimer1.enabled = false
PennywiseTimer1.Interval = 100  ' set it back to run right away when called
end If
End Sub


Sub PennywiseTimer2_Timer()
if VRPennyWiseBack.visible = false then 
VRPennyWiseBack.visible = True
Else
VRPennyWiseBack.visible = false
end If

if PennywiseBackOn = true then 
VRPennyWiseBack.y = VRPennyWiseBack.y - 7
VRPennyWiseBack.z = VRPennyWiseBack.z - .6
end if
End Sub


Dim RandomTimer2
Dim VRLightisOn 
VRLightisOn = True
Dim Strobecount
Strobecount = 0

'' This sits outside of a sub and runs once at Gmaestart to pic a random time.
RandomTimer2 = Int((60000 * Rnd) + 60000) 'between 60 and 120 seconds
VRLightTimerStart.Interval = RandomTimer2

Sub VRLightTimerStart_Timer()
VRStrobeTimer.enabled = true
RandomTimer2 = Int((60000 * Rnd) + 60000) 'between 60 and 120 seconds
VRLightTimerStart.Interval = RandomTimer2
End Sub


Sub VRStrobeTimer_Timer()
if StrobeCount < 80 then 
if VRLightisOn = True Then
VRLightOff
VRLightisOn = False
Strobecount = Strobecount + 1
Playsound "Electricity"
Else
VRLightOn
VRLightisOn = True
Strobecount = Strobecount + 1
Stopsound "Electricity"
end If
End if
if StrobeCount = 50 then VRPennyWise.visible = True
RandomTimer2 = Int((120 * Rnd) + 11) 'between 11 and 131ms
VRStrobeTimer.Interval = RandomTimer2
if StrobeCount = 79 then VRPennyWise.visible = false: VRStrobeTimer.Interval = 600 ' over half second pause in the dark
if StrobeCount = 80 then StrobeCount = 0: PennywiseTimer1.enabled = true: VRStrobeTimer.enabled = false
End Sub


Sub VRLightOn()
VRPavement.image = "pavement_baked"
VRBarrels.image = "barrel_baked"
VRBulbs.image = "bulbs_Baked"
VRConcrete.image = "concrete_baked"
VRDarkSteel.image = "darkSteel_Baked"
VRPennyWise.image = "pennywise_bake"
VRPipes.image = "pipes_baked"
VRStructure.image = "structure_baked"
VRTrash.image = "trashGroup_baked"
VRValves.image = "valve_baked"
VRWires.image = "wires_baked"
VRWater.image = "water_baked"
VRWater2.image = "water_baked"
VRLight1.visible = true
VRLight1b.visible = true
End Sub


Sub VRLightOff()
VRPavement.image = "pavement_baked_OFF"
VRBarrels.image = "barrel_baked_OFF"
VRBulbs.image = "bulbs_Baked_OFF"
VRConcrete.image = "concrete_baked_OFF"
VRDarkSteel.image = "darkSteel_Baked_OFF"
VRPennyWise.image = "pennywise_bake_OFF"
VRPipes.image = "pipes_baked_OFF"
VRStructure.image = "structure_baked_OFF"
VRTrash.image = "trashGroup_baked_OFF"
VRValves.image = "valve_baked_OFF"
VRWires.image = "wires_baked_OFF"
VRWater.image = "water_baked_OFF"
VRWater2.image = "water_baked_OFF"
VRLight1.visible = false
VRLight1b.visible = false
End Sub


Dim BumperStrobeCount
BumperStrobeCount = 0
Dim BumperLightisRunning
BumperLightisRunning = false

Sub VRBumperHitTimer_Timer()
if BumperLightisRunning = false then 
VRLightOff
'RLightisOn = False
BumperLightisRunning = true
BumperStrobecount = BumperStrobecount + 1
Else
VRLightOn
'RLightisOn = True
BumperLightisRunning = false
BumperStrobecount = BumperStrobecount + 1
end If
if BumperStrobecount = 10 then 
BumperStrobecount = 0
VRBumperHitTimer.enabled = false
end If
End Sub



'************************** End VR Stuff.. *************************************************
'*******************************************************************************************

'*****************************************
'	iaakki's	Blood Trails
'*****************************************
Dim BloodTrails

dim objBlood(19), xxx

for xxx = 0 to 19
'	msgbox xxx
'	Eval("BallShadow" & xxx+1).image = "arrow"
	Set objBlood(xxx) = Eval("BloodTrail0" & xxx)
	objBlood(xxx).image = "blood" & RndInt(1,6)
'	objBlood(xxx).image = "arrow"
	objBlood(xxx).z = 0 + xxx/100
	objBlood(xxx).depthbias = -10 - xxx
	objBlood(xxx).uservalue = 0
next

dim Bcnt : Bcnt = 0
dim prevBcnt, rotateCnt

dim TableSlope
TableSlope = table1.SlopeMin + (table1.SlopeMax - table1.SlopeMin) * table1.GlobalDifficulty

dim resetTrails : resetTrails = 0
Sub BloodTrailUpdate_timer()

	if Not bEnableBloodTrails then
		if resetTrails = 1 Then
			for xxx = 0 to 19
				objBlood(xxx).x = 685: objBlood(xxx).y = 2234
				objBlood(xxx).visible = false
				objBlood(xxx).z = 0 + xxx/100
				objBlood(xxx).depthbias = -10 - xxx + 100
				objBlood(xxx).uservalue = 0
			next
			resetTrails = 0
'			debug.print "only once okey?"
		end if
		Exit Sub 'make this run only in multiball mode
	end if

	Dim BOT, b, currentBallVelx, currentBallVely, currentBallVel, currentBallZ
	BOT = GetBalls

	resetTrails = 1

	For b = lob to UBound(BOT)
		currentBallVel = BallVel(BOT(b))
		if currentBallVel > 0 then 
			currentBallZ = BOT(b).z
			'move
			objBlood(Bcnt).X = BOT(b).X
			objBlood(Bcnt).Y = BOT(b).Y

			'make it thinner by time and make them fall unless on ramp. Use uservalue for ramp status
			dim CurrentFallValue
			for xxx = 0 to 19
				if Not xxx = Bcnt then
					CurrentFallValue = objBlood(xxx).uservalue
					objBlood(xxx).size_x = objBlood(xxx).size_x * 0.95
					if CurrentFallValue > 0 Then
						CurrentFallValue = CurrentFallValue - 30
						if CurrentFallValue < 0 then CurrentFallValue = 0

						objBlood(xxx).rotx = objBlood(xxx).rotx / 2
'						objBlood(xxx).rotx = 0
						objBlood(xxx).z = CurrentFallValue + xxx/100

						objBlood(xxx).uservalue = CurrentFallValue
						if CurrentFallValue = 0 then 
							objBlood(xxx).rotx = 0
						end if
					end if
				end if
			next
			

			'resize by speed
			if currentBallVel > 50 then currentBallVel = 50
			objBlood(Bcnt).size_x = 5 - 2*(currentBallVel/50)
			objBlood(Bcnt).size_y = 5 + (currentBallVel/8)
			
			'ball direction
			objBlood(Bcnt).objrotz = Atn2(BOT(b).vely,BOT(b).velx)/(PI/180) - 90

			'ramp
			if currentBallZ > 27 then
				objBlood(Bcnt).z = currentBallZ - 24 + Bcnt/100

				'ramp angle
				objBlood(Bcnt).rotx = (Atn(BOT(b).velz / SQR(BOT(b).velx*BOT(b).velx+BOT(b).vely*BOT(b).vely)))/(PI/180) - 3


				if BOT(b).z > 120 and (InRect(BOT(b).x, BOT(b).y,157,734,237,771,118,1022,38,987) Or InRect(BOT(b).x, BOT(b).y,233,14,510,14,510,100,233,100)) then 'hide splatter
'					debug.print "hide!"
					objBlood(Bcnt).visible = False
				Else
					objBlood(Bcnt).visible = True
				end if
				if InRect(BOT(b).x, BOT(b).y,0,0,513,0,277,956,0,1024) Or InRect(BOT(b).x, BOT(b).y,750,600,831,641,776,750,691,712) then 
					if BOT(b).z > 110 And InRect(BOT(b).x, BOT(b).y,343,353,479,373,325,812,159,749) Then 'wireramp
'						debug.print "wire ramp1"
						objBlood(Bcnt).uservalue = objBlood(Bcnt).z	'fall amount
					else
'						debug.print "ramp! z: " & BOT(b).z
						objBlood(Bcnt).uservalue = 0
					end if
				Else	'not on a solid ramp
'					debug.print "wire ramp"
					objBlood(Bcnt).uservalue = objBlood(Bcnt).z	'fall amount
				end if

			else
				objBlood(Bcnt).z = Bcnt/100
				objBlood(Bcnt).rotx = 0
				objBlood(Bcnt).uservalue = 0
			end if

			prevBcnt = Bcnt
			Bcnt = Bcnt + 1
			if Bcnt > 19 Then 
				Bcnt = 0
			end if
		end if
	Next

End Sub


'*****************
' Maths
'*****************

'//  Determines if a Points (px,py) is inside a 4 point polygon A-D
'//  in Clockwise/CCW order
Function InRect(px,py,ax,ay,bx,by,cx,cy,dx,dy)
	Dim AB, BC, CD, DA
	AB = (bx*py) - (by*px) - (ax*py) + (ay*px) + (ax*by) - (ay*bx)
	BC = (cx*py) - (cy*px) - (bx*py) + (by*px) + (bx*cy) - (by*cx)
	CD = (dx*py) - (dy*px) - (cx*py) + (cy*px) + (cx*dy) - (cy*dx)
	DA = (ax*py) - (ay*px) - (dx*py) + (dy*px) + (dx*ay) - (dy*ax)
 
	If (AB <= 0 AND BC <=0 AND CD <= 0 AND DA <= 0) Or (AB >= 0 AND BC >=0 AND CD >= 0 AND DA >= 0) Then
		InRect = True
	Else
		InRect = False       
	End If
End Function



Roachloc=0

dim roachran

sub roachmove
	Roach.visible = true
	RoachCounter = 0
	if roachtimer.enabled=0 then

		RoachKickers true

		RoachMagnetsOff
		Do
			roachran=int(rnd*5)
		Loop while roachran=roachloc

		if Roachran = 4 And roachloc <> 3 Then
			if roachloc <> 3 then
				Roachran = 3
			Else
				Do
					roachran=int(rnd*3)
				Loop while roachran=roachloc
			end If
		end if
		if roachloc = 4 then roachran = 0

		select case roachran
			case 0:
				magnet0.magneton=true
			case 1:
				Magnet1.magneton=true 
			case 2:
				magnet2.magneton=true 
			case 3:
				magnet3.magneton=true 
			case 4:
				magnet4.magneton=true 
		end Select
		roachtimer.enabled=1
		RoachAnimLoopTimer.enabled=1
		select case RoachLoc
			case 0:
				RoachHole0.kick 180,4,0 
			case 1:
				RoachHole1.kick 270,4,0 
			case 2:
				RoachHole2.kick 45,4,0 
			case 3:
				RoachHole3.kick 90,4,0 
			case 4:
				RoachHole4.kick 0,10,0 
		end Select
	end if
end sub

sub roachmoveTo(aTarget)
	Roach.visible = true
	RoachCounter = 0
'	if roachtimer.enabled=0 then	'skipping this so it return immediately.

		RoachKickers true

		RoachMagnetsOff

		roachran = aTarget

		select case roachran
			case 0:
				magnet0.magneton=true
			case 1:
				Magnet1.magneton=true 
			case 2:
				magnet2.magneton=true 
			case 3:
				magnet3.magneton=true 
			case 4:
				magnet4.magneton=true 
		end Select
		roachtimer.enabled=1
		RoachAnimLoopTimer.enabled=1
		select case RoachLoc
			case 0:
				RoachHole0.kick 180,4,0 
			case 1:
				RoachHole1.kick 270,4,0 
			case 2:
				RoachHole2.kick 45,4,0 
			case 3:
				RoachHole3.kick 90,4,0 
			case 4:
				RoachHole4.kick 0,10,0 
		end Select
'	end if
end sub

dim frameRate:frameRate=0.8
dim frame:frame=0
sub RoachAnimLoopTimer_Timer
'	debug.print frame
	Roach.ShowFrame frame
	frame = frame + frameRate
'	If frame>18 Then	' the animation is a bit rough so don't play it till the end but stop a bit earlier
'		frame=0
'	end if
	If frame>22 Then	' the animation is a bit rough so don't play it till the end but stop a bit earlier
		frame=1.3
	end if
	roachball.velx = 0.8 * roachball.velx
	roachball.vely = 0.8 * roachball.vely
end sub

Sub RoachHole0_hit
'	debug.print "hit"
	RoachBall.x = RoachHole0.x : RoachBall.y = RoachHole0.y
	roach.x = roachBall.x
	roach.y = roachBall.y
	RoachAnimLoopTimer.enabled=0
	RoachMagnetsOff
	roachtimer.enabled=0
	RoachKickers false
	stopsound("centipede_sound")
	roachloc=0
	Roach.visible = false
End Sub

Sub RoachHole1_hit
	RoachBall.x = RoachHole1.x : RoachBall.y = RoachHole1.y
	roach.x = roachBall.x
	roach.y = roachBall.y
	RoachAnimLoopTimer.enabled=0
	RoachMagnetsOff
	roachtimer.enabled=0
	RoachKickers false
	stopsound("centipede_sound")
	roachloc=1
End Sub

Sub RoachHole2_hit
	RoachBall.x = RoachHole2.x : RoachBall.y = RoachHole2.y
	roach.x = roachBall.x
	roach.y = roachBall.y
	RoachAnimLoopTimer.enabled=0
	RoachMagnetsOff
	roachtimer.enabled=0
	RoachKickers false
	stopsound("centipede_sound")
	roachloc=2
End Sub

Sub RoachHole3_hit
	RoachBall.x = RoachHole3.x : RoachBall.y = RoachHole3.y
	roach.x = roachBall.x
	roach.y = roachBall.y
	RoachAnimLoopTimer.enabled=0
	Magnet3.magneton=False
	RoachMagnetsOff
	roachtimer.enabled=0
	RoachKickers false
	stopsound("centipede_sound")
	roachloc=3
	Roach.visible = false
End Sub

Sub RoachHole4_hit
	RoachBall.x = RoachHole4.x : RoachBall.y = RoachHole4.y
	roach.x = roachBall.x
	roach.y = roachBall.y
	RoachAnimLoopTimer.enabled=0
	RoachMagnetsOff
	roachtimer.enabled=0
	RoachKickers false
	roachloc=4
	stopsound("centipede_sound")
	Roach.visible = false
End Sub

Sub RoachKickers(Enabled)
	RoachHole0.enabled = Enabled
	RoachHole1.enabled = Enabled
	RoachHole2.enabled = Enabled
	RoachHole3.enabled = Enabled
	RoachHole4.enabled = Enabled
end sub

Sub RoachMagnetsOff
	Magnet0.magneton=False
	Magnet1.magneton=False
	magnet2.magneton=False
	Magnet3.magneton=False
	Magnet4.magneton=False
End Sub

dim RoachRollVolume : RoachRollVolume = 0.05
dim RoachCounter : RoachCounter = 0

Sub roachtimer_timer
	Dim roachA,dx,dy, AngleDiff

	RoachCounter = RoachCounter + 1
'	debug.print RoachCounter
	if RoachCounter > 500 then roachmoveTo 0	'probably stuck.. make it return to scoop

	roach.x = roachBall.x
	roach.y = roachBall.y


	'change roach rotation
	dy=-1*roachBall.vely  '-1*(EVAL("roachxy"&xx)(1)(roachstep)-EVAL("roachxy"&xx)(1)(roachstep-1))	'delta Y
	if dy=0 then dy=0.0000001													'avoid divide by zero errors
	dx=RoachBall.velx 	'EVAL("roachxy"&xx)(0)(roachstep)-EVAL("roachxy"&xx)(0)(roachstep-1)		'delta X
	roachA=atn(dX/dY)												'angle in radians
	if roachA<0 then roachA=roachA+PI								'correction for negative angles
	roachA=int(roachA/(pi/180))							'convert to degrees
	if dx<0 then roachA=roachA+180						'correction for negative quadrants
'			Roach.roty=roachA

'	debug.print roachA
	AngleDiff = roachA - Roach.rotz
	if abs(AngleDiff) > 30 then 
		if abs(AngleDiff) > 300 And Roach.rotz < 100 then  'do nothing, probably went around
'			debug.print "-around: " & AngleDiff
		elseif abs(AngleDiff) > 300 And Roach.rotz > 300 then  'do nothing, probably went around
'			debug.print "+around: " & AngleDiff
		else
'			debug.print "too much. Divide? " & AngleDiff
			roachA = roachA + AngleDiff / 45
		end if
	end if

	Roach.rotz=roachA

	'roach movement speed should affect framerate
	framerate = 0.23 * SQR(dx^2 + dy^2)

	'roach sound
	PlaySound ("centipede_sound"), -1, VolPlayfieldRoll(roachBall) * RoachRollVolume * VolumeDial, AudioPan(roachBall), 0, PitchPlayfieldRoll(roachBall), 1, 0, AudioFade(roachBall)
end sub


'VR Instruction Cards Code..

dim VRGlowSpeed
VRGlowspeed = 1
Dim VRInstructions
VRInstructions = 0

Sub VRInstructionsGlowTimer_timer()
for each Stuff in VRRings: Stuff.blenddisablelighting = Stuff.blenddisablelighting + VRGlowspeed: next
VRTipsText.opacity = VRTipsText.opacity + VRGlowspeed * 4
if VRPointer2.blenddisablelighting > 50 then VRGlowspeed = -1
if VRPointer2.blenddisablelighting < 1 then VRGlowspeed = 1
End Sub


Sub VRInstructionsLogic()

If VRInstructions = 1 then 
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions1.visible = true
end If

If VRInstructions = 2 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions2.visible = true
VRPointer2.visible = true
VRPointer2b.visible = true
VRPointer2c.visible = true
end If

If VRInstructions = 3 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions3.visible = true
VRPointer3.visible = true
VRPointer3b.visible = true
VRPointer3c.visible = true
VRPointer3d.visible = true
end If

If VRInstructions = 4 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions4.visible = true
VRPointer4.visible = true
end If

If VRInstructions = 5 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions5.visible = true
VRPointer5.visible = true
VRPointer5b.visible = true
end If

If VRInstructions = 6 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions6.visible = true
VRPointer6.visible = true
VRPointer6b.visible = true
VRPointer6c.visible = true
VRPointer6d.visible = true
VRPointer6e.visible = true
VRPointer6f.visible = true
end If

If VRInstructions = 7 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions7.visible = true
VRPointer7.visible = true
VRPointer3d.visible = true
VRPointer7c.visible = true
VRPointer7d.visible = true
end If

If VRInstructions = 8 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions8.visible = true
VRPointer8.visible = true
VRPointer8b.visible = true
VRPointer8c.visible = true
end If

If VRInstructions = 9 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions9.visible = true

end If

If VRInstructions = 10 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions10.visible = true

end If

If VRInstructions = 11 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions11.visible = true

end If

If VRInstructions = 12 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions12.visible = true

end If

If VRInstructions = 13 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions13.visible = true

end If

If VRInstructions = 14 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions14.visible = true
VRPointer14.visible = true
VRPointer14b.visible = true
VRPointer14c.visible = true
VRPointer14d.visible = true
VRPointer14e.visible = true
VRPointer14f.visible = true
VRPointer14g.visible = true
VRPointer14h.visible = true
VRPointer14i.visible = true
VRPointer14j.visible = true
end If

If VRInstructions = 15 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions15.visible = true
VRPointer6e.visible = true
VRPointer15b.visible = true
VRPointer15c.visible = true
end If

If VRInstructions = 16 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions16.visible = true
VRPointer14d.visible = true
VRPointer14e.visible = true
VRPointer14f.visible = true
VRPointer14c.visible = true
VRPointer14.visible = true
VRPointer14b.visible = true
VRPointer14j.visible = true
end If

If VRInstructions = 17 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions17.visible = true
VRPointer14h.visible = true
end If

If VRInstructions = 18 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions18.visible = true
VRPointer14i.visible = true
end If

If VRInstructions = 19 then
For Each Stuff in VRCards : Stuff.visible = false: Next
VRInstructions19.visible = true
VRPointer14g.visible = true
end If

If VRInstructions = 20 then 
For Each Stuff in VRCards : Stuff.visible = false: Next

end If
End Sub


Sub VRRightMagnaTimer_timer()
RightMagnaEnabled = True
if LeftMagnaEnabled = true then

if VRInstructionsEnabled = false then 
VRInstructionsGlowTimer.enabled = true
VRTipsText.visible = true
VRInstructionsEnabled = true
VRInstructions = 1
VRInstructionsLogic
VRRightMagnaTimer.interval = 2000
Else
VRInstructionsEnabled = false
VRTipsText.visible = false
VRInstructionsGlowTimer.enabled = false
VRRightMagnaTimer.interval = 2000
'turn off all shit here...
For Each Stuff in VRCards : Stuff.visible = false: Next
end if
end If
End Sub


Sub VRLeftMagnaTimer_timer()
LeftMagnaEnabled = True
if RightMagnaEnabled = true then 
if VRInstructionsEnabled = false then 
VRInstructionsGlowTimer.enabled = true
VRTipsText.visible = true
VRInstructionsEnabled = true
VRInstructions = 1
VRInstructionsLogic
'VRLeftMagnaTimer.interval = 2000
Else
VRInstructionsGlowTimer.enabled = false
VRInstructionsEnabled = false
VRTipsText.visible = false
'VRLeftMagnaTimer.interval = 2000
'turn off all shit here...
For Each Stuff in VRCards : Stuff.visible = false: Next
end if
end if
End Sub

'VR Roach...
sub VRRoachRunTimer_Timer()
VRRoach.visible = True
VRRoachAnimLoopTimer.enabled = true
End Sub

sub VRRoachAnimLoopTimer_Timer
	VRRoach.ShowFrame frame
	frame = frame + frameRate
	If frame>22 Then	' the animation is a bit rough so don't play it till the end but stop a bit earlier
		frame=1.3
	end if
	roachball.velx = 0.8 * roachball.velx
	roachball.vely = 0.8 * roachball.vely

VRRoach.y = VRRoach.y +30
VRRoach.z = VRRoach.z +3
if VRRoach.y > 11000 then 
VRRoach.visible = false
VRRoach.y = -13650
VRRoach.x = 257.8921
VRRoach.z = -2950
RandomTimer2 = Int((60000 * Rnd) + 60000) 'between 60 and 120 seconds
VRRoachRunTimer.Interval = RandomTimer2
VRRoachAnimLoopTimer.enabled = false ' Shut itself down
end if
end sub

